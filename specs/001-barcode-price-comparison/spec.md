# Feature Specification: 條碼掃描價格比較

**Feature Branch**: `001-barcode-price-comparison`  
**Created**: 2025-01-27  
**Status**: Draft  
**Input**: User description: "實現條碼掃描價格比較"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 基本條碼掃描 (Priority: P1)

用戶可以使用手機攝像頭掃描商品條碼，系統識別條碼並顯示商品基本信息。這是整個價格比較功能的核心基礎。

**Why this priority**: 這是最基本的功能，沒有條碼掃描就無法進行價格比較。這個功能本身就能為用戶提供商品識別的價值。

**Independent Test**: 可以通過掃描任何標準條碼（如書籍、食品包裝）來完全測試，系統應該能夠識別條碼並顯示商品名稱和基本信息。

**Acceptance Scenarios**:

1. **Given** 用戶在商店中看到想要查詢的商品, **When** 用戶打開應用並點擊掃描按鈕, **Then** 攝像頭啟動並顯示掃描界面
2. **Given** 掃描界面已開啟, **When** 用戶將攝像頭對準商品條碼, **Then** 系統自動識別條碼並顯示商品名稱和圖片
3. **Given** 條碼掃描成功, **When** 系統識別出商品, **Then** 顯示商品的基本信息（名稱、品牌、規格）

---

### User Story 2 - 多商店價格查詢 (Priority: P2)

用戶掃描條碼後，系統自動從本地資料庫查詢該商品的用戶掃描輸入價格信息，並以清晰的方式展示價格比較結果。

**Why this priority**: 這是價格比較的核心價值，讓用戶能夠快速了解不同商店的價格差異，做出明智的購買決策。

**Independent Test**: 可以通過掃描已知在資料庫中有價格記錄的商品來測試，系統應該顯示該商品的價格比較信息。

**Acceptance Scenarios**:

1. **Given** 用戶已成功拍攝價格標籤, **When** 系統透過OCR識別商品條碼後, **Then** 自動從資料庫查詢該商品的價格信息
2. **Given** OCR識別完成, **When** 系統顯示識別結果, **Then** 用戶必須能夠確認或修正所有字段
3. **Given** 用戶確認價格信息, **When** 系統保存數據, **Then** 顯示是否為歷史最低價的比較結果
4. **Given** OCR分析完成, **When** 系統建立價格記錄卡片, **Then** 卡片必須暫存至本地並備份至Firebase
5. **Given** 用戶確認OCR結果, **When** 用戶提交最終數據, **Then** 系統必須將完整記錄保存至Firebase資料庫
6. **Given** 網絡恢復後, **When** 系統開始同步離線數據, **Then** 必須按時間順序優先，重要數據標記優先的策略進行同步
7. **Given** 數據處理流程中斷, **When** 系統檢測到未完成的檢查點, **Then** 必須自動嘗試從最近檢查點恢復流程
8. **Given** 自動恢復達到最大重試次數, **When** 恢復仍然失敗, **Then** 必須通知用戶並提供手動處理選項
9. **Given** 價格比較結果已顯示, **When** 用戶查看結果, **Then** 歷史最低價格會被明確顯示作為參考，包含縣市和商店類型信息

---

### User Story 3 - 掃描歷史記錄 (Priority: P3)

用戶可以查看之前掃描過的商品歷史記錄，包括掃描時間和當時的價格信息，方便追蹤價格變化。

**Why this priority**: 提供額外的用戶價值，讓用戶能夠追蹤商品價格趨勢，但不是核心功能。

**Independent Test**: 可以通過掃描幾個商品後查看歷史記錄頁面來測試，應該顯示之前掃描的商品列表。

**Acceptance Scenarios**:

1. **Given** 用戶已掃描過多個商品, **When** 用戶點擊歷史記錄按鈕, **Then** 顯示按時間排序的掃描歷史列表
2. **Given** 歷史記錄頁面已開啟, **When** 用戶點擊某個歷史記錄, **Then** 顯示該商品的詳細信息和當時的價格
3. **Given** 查看歷史商品詳情, **When** 用戶選擇重新查詢價格, **Then** 系統更新該商品的最新價格信息

---

### Edge Cases

- 條碼無法識別或損壞時如何處理？
- 網絡連接不穩定時如何處理價格查詢失敗？
- 商品在某些商店缺貨時如何顯示？
- 掃描到非商品條碼（如會員卡）時如何處理？
- 同一商品有多種規格時如何區分？
- 多個用戶對同一商品掃描不同價格時如何處理？
- 掃描照片模糊或無法辨識價格標籤時如何處理？

- 如何判斷照片品質是否滿足手機螢幕清晰判讀的要求？
- 如何處理用戶掃描錯誤商品條碼的情況？
- 同一商品在不同時間的價格變化如何記錄？
- 用戶手動選擇錯誤縣市時如何處理？
- 如何識別和分類不同的商店類型？
- 商店名稱不標準或不完整時如何處理？
- 如何維護和更新預設商店列表？
- 用戶輸入重複或相似商店名稱時如何處理？
- OCR識別失敗或條碼不清晰時如何處理？
- 價格標籤包含多個條碼時如何選擇正確的商品條碼？
- OCR提取的價格信息與實際不符時如何處理？
- 如何判斷OCR識別結果的可信度？
- 用戶手動補充信息的驗證機制如何設計？
- 部分信息缺失時如何確保數據記錄的完整性？
- 用戶頻繁修正OCR結果時如何優化識別算法？
- 如何處理用戶確認錯誤信息的情況？
- OCR結果與用戶修正差異過大時如何處理？
- 如何在網絡較慢時確保OCR處理的響應時間？
- 並行處理失敗時如何優雅降級？
- 如何平衡處理速度和識別準確率？
- 本地暫存與Firebase同步失敗時如何處理？
- 用戶在確認階段關閉應用時如何保護數據？
- 多個卡片同時處理時如何管理暫存隊列？
- 網絡恢復後如何優先同步重要數據？
- 同步過程中用戶繼續拍攝新照片時如何處理？
- 如何判斷哪些數據應該標記為重要數據？
- 同步隊列過長時如何優化處理策略？
- 部分同步失敗時如何避免數據不一致？
- 檢查點數據過多時如何管理存儲空間？
- 如何確定檢查點設置的最佳時機？
- 恢復過程中用戶進行新操作時如何處理衝突？
- 檢查點數據損壞時如何處理？
- 如何平衡自動恢復的積極性和系統穩定性？
- 如何處理跨縣市邊界的商店定位問題？

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須能夠使用設備攝像頭拍攝價格標籤，透過OCR識別商品條碼
- **FR-002**: 系統必須能夠從價格標籤照片中識別標準商品條碼格式（EAN-13, UPC-A等）
- **FR-003**: 用戶必須能夠查看掃描到的商品基本信息（名稱、品牌、圖片）
- **FR-004**: 系統必須能夠從本地資料庫查詢用戶掃描輸入的商品價格信息並進行比較
- **FR-005**: 系統必須以清晰的格式顯示價格比較結果，顯示是否為歷史最低價
- **FR-006**: 系統必須顯示歷史最低價格作為參考基準
- **FR-007**: 用戶必須能夠點擊價格結果直接跳轉到對應商店頁面
- **FR-008**: 系統必須保存用戶的掃描歷史記錄
- **FR-009**: 用戶必須能夠查看和管理掃描歷史
- **FR-010**: 系統必須支持條碼掃描和歷史記錄的離線功能，價格查詢需要網絡連接
- **FR-011**: 系統必須在條碼無法識別時提供清晰的錯誤提示
- **FR-012**: 系統必須支持手動輸入條碼數字作為備選方案
- **FR-013**: 用戶必須能夠回報和更新商品的價格信息（透過掃描）
- **FR-014**: 系統必須完全信任用戶掃描輸入的價格信息，無需額外驗證
- **FR-015**: 系統必須記錄價格更新的來源和時間戳
- **FR-016**: 系統必須支持完全匿名用戶使用所有功能
- **FR-017**: 所有價格數據來源均為用戶現實掃描，無網路外部數據源
- **FR-018**: 系統必須保存所有掃描的價格標籤照片至本地存儲（不上傳至Firebase）
- **FR-019**: 照片存儲品質必須滿足手機螢幕清晰判讀的要求，僅存儲於本地
- **FR-020**: 系統必須記錄全域歷史最低價，不分地區但包含地理位置信息
- **FR-021**: 系統必須使用GPS判別用戶所在縣市並記錄在價格資料中
- **FR-022**: 當GPS定位失敗時，系統必須直接跳過地理位置記錄，不中斷主要流程
- **FR-023**: 系統必須記錄地理位置的獲取方式（GPS自動 vs 手動選擇）
- **FR-024**: 系統必須在價格比較結果中顯示縣市和商店類型信息
- **FR-025**: 系統必須保護用戶隱私，不顯示詳細地址信息
- **FR-026**: 系統必須提供預設的常見商店列表供用戶選擇
- **FR-027**: 系統必須允許用戶手動輸入不在預設列表中的商店名稱
- **FR-028**: 系統必須標準化商店名稱顯示，確保數據一致性
- **FR-029**: 系統必須使用OCR技術從價格標籤照片中提取條碼和價格信息
- **FR-030**: 系統必須能夠處理價格標籤照片中的多種信息（條碼、價格、商店名稱等）
- **FR-031**: 當OCR無法完整識別所有信息時，系統必須填入已識別的部分信息
- **FR-032**: 系統必須允許用戶手動補充或修正OCR未能識別的信息
- **FR-033**: 系統必須提供重新拍攝選項，讓用戶可以重新嘗試OCR識別
- **FR-034**: 系統必須向用戶顯示OCR識別的所有結果，包括條碼、價格、商店等信息

- **FR-037**: 系統必須採用分階段處理，優先處理關鍵步驟以確保響應時間
- **FR-038**: OCR處理和GPS定位必須能夠並行執行以提升效率
- **FR-039**: 用戶確認步驟不計入系統響應時間要求
- **FR-040**: 系統必須在2秒內完成照片拍攝到OCR結果顯示的流程

- **FR-046**: 系統必須支持離線模式下的本地暫存和後續同步
- **FR-047**: 系統必須按照時間順序優先同步離線暫存的價格記錄
- **FR-048**: 系統必須標記重要數據（如歷史最低價記錄）並優先同步
- **FR-049**: 系統必須提供同步進度指示器，顯示暫存數據的同步狀態
- **FR-050**: 系統必須在同步失敗時提供重試機制和錯誤處理
- **FR-051**: 系統必須在每個關鍵階段設置數據檢查點以確保數據完整性
- **FR-052**: 系統必須能夠從最近的檢查點自動恢復中斷的數據處理流程
- **FR-053**: 系統必須限制自動重試次數，避免無限循環重試
- **FR-054**: 系統必須在自動恢復失敗時通知用戶並提供手動處理選項
- **FR-055**: 系統必須在流程完成後清理所有臨時檢查點數據

- **FR-071**: 系統必須實施網絡感知式同步策略，智能檢測網絡狀態變化
- **FR-072**: 系統必須在網絡可用時積極嘗試同步待處理卡片以釋放本地空間
- **FR-073**: 系統必須在網絡不穩定時保守管理本地空間，優先保障新拍攝功能
- **FR-074**: 系統必須提供網絡狀態指示器，讓用戶了解當前同步能力
- **FR-075**: 系統必須在網絡恢復時自動恢復同步進程，無需用戶干預
- **FR-076**: 系統必須在每次程式開啟時詢問用戶當前所在商店
- **FR-077**: 系統必須檢測程式開啟時間間隔，若5分鐘內重新開啟則詢問是否為同一商店
- **FR-078**: 系統必須記錄商店會話狀態和時間戳，用於智慧會話管理
- **FR-079**: 系統必須在OCR識別完成後立即自動儲存價格記錄至Firebase
- **FR-080**: 系統必須移除用戶確認步驟，實現掃描即存的流暢體驗
- **FR-081**: 系統必須在自動儲存失敗時提供錯誤提示和重試機制
- **FR-082**: 系統必須實施圖像預處理技術以提升OCR識別準確率
- **FR-083**: 系統必須在歷史記錄中提供用戶修正錯誤資料的功能
- **FR-084**: 系統必須實施異常價格檢測，自動標記可疑的高/低價格資料（偏離歷史平均值50%以上，置信度>0.8）
- **FR-085**: 系統必須為異常標記的資料提供人工驗證機制，包含本地原始照片查看和手動確認功能
- **FR-086**: 系統必須在主頁面提供"今日掃描"區塊，顯示當天所有掃描記錄
- **FR-087**: 系統必須在今日掃描區塊中顯示每筆記錄的比價結果（是否為最低價）
- **FR-088**: 系統必須按時間順序排列今日掃描記錄，最新的在前
- **FR-089**: 系統必須在今日掃描區塊提供快速查看詳細資訊的功能
- **FR-090**: 系統必須自動嘗試GPS定位至鄉鎮等級，不等待用戶確認
- **FR-091**: 系統必須在GPS定位失敗時靜默跳過，不顯示錯誤提示或要求手動輸入
- **FR-092**: 系統必須將地理位置資訊視為可選資料，不影響核心掃描和比價功能
- **FR-093**: 系統必須完全移除待辨識序列相關功能和UI元件
- **FR-094**: 系統必須移除價格記錄卡片的狀態機管理（PENDING_CONFIRM等狀態）
- **FR-095**: 系統必須簡化資料流程，從掃描直接到儲存，無中間暫存狀態
- **FR-016**: 系統必須支持匿名用戶使用基本掃描和查詢功能


### Key Entities

- **商品 (Product)**: 代表被掃描的商品，包含條碼、名稱、品牌、圖片、規格等屬性
- **價格記錄 (Price Record)**: 代表用戶掃描輸入的商品價格信息，包含價格、掃描時間、本地照片路徑、商店信息、GPS縣市位置等屬性
- **掃描歷史 (Scan History)**: 代表用戶的掃描記錄，包含掃描時間、商品信息、當時的價格數據
- **商店 (Store)**: 代表線上商店，包含商店名稱、網站連結、API接口信息
- **價格更新 (Price Update)**: 代表用戶掃描提交的價格變更，包含新價格、商店信息、提交時間、本地照片路徑
- **價格標籤照片 (Price Tag Photo)**: 代表掃描時的價格標籤照片，所有掃描都保存至本地，附帶地理位置信息，存儲品質適合手機螢幕判讀，不上傳至雲端
- **地理位置記錄 (Location Record)**: 代表價格記錄的地理信息，包含縣市名稱、獲取方式（GPS/手動）、定位準確度等屬性
- **商店資料 (Store Data)**: 代表商店信息，包含標準化商店名稱、商店類型、是否為預設列表等屬性
- **OCR識別結果 (OCR Recognition Result)**: 代表OCR處理的結果，包含已識別信息、未識別字段、信心度、處理時間等屬性
- **性能指標 (Performance Metrics)**: 代表系統性能數據，包含響應時間、並行處理效率、用戶等待時間等屬性

- **商店會話 (Store Session)**: 代表用戶當前的購物會話，包含商店名稱、開始時間、會話狀態、GPS位置等屬性
- **圖像預處理結果 (Image Preprocessing Result)**: 代表OCR前的圖像處理結果，包含亮度調整、對比度增強、去噪等處理參數
- **異常價格標記 (Anomaly Price Flag)**: 代表系統自動檢測的可疑價格資料，包含異常類型、置信度、標記時間等屬性
- **資料修正記錄 (Data Correction Record)**: 代表用戶在歷史記錄中的修正操作，包含原始資料、修正後資料、修正時間等屬性
- **今日掃描摘要 (Daily Scan Summary)**: 代表當天的掃描活動摘要，包含掃描次數、最低價發現數、總節省金額等統計資訊

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用戶能夠在5秒內成功掃描並識別商品條碼
- **SC-002**: 系統能夠在2秒內完成照片拍攝到OCR結果顯示（不包含用戶確認時間，測試環境：室內光線≥300勒克斯，標準距離10-30公分）
- **SC-003**: 條碼識別成功率達到95%以上（測試條件：光線≥300勒克斯，條碼清晰無損壞，標準EAN-13/UPC-A格式）
- **SC-004**: 90%的用戶能夠在首次使用時成功完成完整的掃描和價格比較流程
- **SC-005**: 應用能夠在離線狀態下進行條碼掃描和顯示歷史記錄
- **SC-006**: 資料庫中的價格信息覆蓋率達到80%以上的常見商品
- **SC-008**: 所有掃描照片的存儲空間控制在5MB以內，單張照片壓縮後不超過500KB
- **SC-009**: 照片品質能夠在手機螢幕上清晰顯示價格標籤信息
- **SC-010**: 系統能夠準確記錄和顯示最低價的地理位置信息（縣市層級）
- **SC-011**: GPS定位準確率達到90%以上，能正確判別用戶所在縣市
- **SC-012**: GPS定位失敗時系統能夠在1秒內靜默跳過，不中斷用戶流程
- **SC-013**: 地理位置記錄的完整率達到95%以上（GPS或手動）
- **SC-014**: 價格比較結果能夠清晰顯示縣市和商店類型信息
- **SC-015**: 用戶隱私得到保護，不洩露詳細地址信息
- **SC-016**: 預設商店列表涵蓋90%以上的常見商店類型
- **SC-017**: 用戶能夠在5秒內完成商店選擇或輸入
- **SC-018**: 商店名稱顯示的一致性達到95%以上
- **SC-019**: OCR條碼識別準確率達到90%以上
- **SC-020**: 價格標籤照片中的信息提取準確率達到85%以上
- **SC-021**: 用戶能夠在10秒內完成OCR結果的確認或修正
- **SC-022**: 部分OCR失敗時，系統仍能保存已識別的有效信息
- **SC-023**: 用戶手動補充信息的成功率達到95%以上
- **SC-024**: OCR結果確認界面的用戶滿意度達到90%以上
- **SC-025**: 價格信息確認流程在15秒內完成
- **SC-026**: 用戶修正OCR結果的準確率達到98%以上
- **SC-027**: OCR處理和GPS定位的並行執行效率達到90%以上
- **SC-028**: 關鍵步驟（照片處理、條碼識別）在1.5秒內完成
- **SC-029**: 系統整體流程的用戶等待時間不超過5秒（包含用戶操作時間）
- **SC-030**: OCR識別到Firebase儲存的完整流程在3秒內完成
- **SC-031**: 離線模式下的localStorage暫存成功率達到99%以上
- **SC-032**: 網路恢復後的自動同步成功率達到95%以上
- **SC-033**: 今日掃描區塊的載入時間在2秒內完成
- **SC-034**: 異常價格檢測的準確率達到90%以上
- **SC-035**: 用戶修正歷史資料的成功率達到98%以上
- **SC-051**: 網絡狀態檢測的準確率達到95%以上，能正確識別網絡可用性
- **SC-052**: 網絡恢復後5秒內自動開始同步進程
- **SC-053**: 網絡不穩定時本地空間管理的準確性達到100%
- **SC-054**: 網絡狀態指示器的實時更新準確率達到90%以上
- **SC-007**: 用戶滿意度調查中，80%的用戶認為價格比較功能有助於他們的購買決策

## Clarifications

### Session 2025-01-27

- Q: 商店會話管理策略 → A: 每次程式開啟時都詢問商店，但5分鐘內重開時詢問是否為同一商店
- Q: 掃描後資料儲存流程 → A: 掃描後立即自動儲存至Firebase，無需用戶確認，配套提升OCR準確率、後續修正機制、異常檢測
- Q: 當天掃描歷史顯示方式 → A: 主頁面新增"今日掃描"區塊，顯示當天所有掃描記錄和比價結果
- Q: GPS定位處理策略 → A: 自動使用GPS定位至鄉鎮等級，失敗時直接跳過，非必要資訊
- Q: 待辨識序列功能處理 → A: 完全移除待辨識序列功能，包括相關UI和資料結構
- Q: 價格數據來源策略 → A: 僅與資料庫中的資料比較
- Q: 資料庫價格數據的更新機制 → A: 用戶貢獻更新允許用戶回報價格變化
- Q: 用戶身份驗證需求 → A: 完全匿名使用，不需註冊
- Q: 離線功能的具體範圍 → A: 掃描+歷史記錄，價格查詢需網絡
- Q: 價格比較的顯示方式 → A: 僅顯示最低價格和商店（保留現有設計）
- Q: 用戶價格貢獻的驗證機制 → A: 極高信任用戶，掃描價格標籤時自動保存照片至本地，無需額外驗證
- Q: 價格標籤照片的處理方式 → A: 採用現行方案，所有掃描都保存照片至本地，手機螢幕清晰度即可，不上傳至Firebase
- Q: 多用戶掃描同一商品的處理策略 → A: 全域最低價記錄，包含地區信息(GPS判別縣市)，照片回溯到資料庫前次最低價
- Q: 照片存儲策略調整 → A: 採用現行方案不更動，所有掃描都保存照片至本地，不上傳至雲端
- Q: 用戶註冊需求調整 → A: 不需註冊用戶，完全匿名使用
- Q: GPS定位失敗的處理策略 → A: 手動選擇縣市 + 記錄定位狀態
- Q: 價格比較結果的地理信息顯示詳細程度 → A: 縣市 + 商店類型
- Q: 商店類型的識別和分類方式 → A: 預設商店列表 + 手動輸入
- Q: 條碼掃描的實際實現方式 → A: 完全依賴OCR識別條碼（現有方式）
- Q: OCR處理失敗的備援機制 → A: 填入能夠辨識出的資訊，其他未完整資訊可由使用者補充或選擇重新拍攝
- Q: 價格信息的驗證和確認機制 → A: 顯示OCR結果供用戶確認，允許修正
- Q: 系統性能和響應時間的優化策略 → A: 分階段處理，關鍵步驟優先
- Q: 拍攝後卡片建立、暫存至Firebase的完整流程 → A: 保持現有多階段流程，明確規格化
- Q: 離線模式下的數據同步優先級策略 → A: 時間順序優先，重要數據標記
- Q: 數據完整性驗證和錯誤恢復機制 → A: 階段性檢查點 + 自動恢復
- Q: 價格記錄卡片的完整生命週期管理策略 → A: 實施完整狀態機模式（CREATED→PROCESSING→PENDING_CONFIRM→CONFIRMED→SYNCING→COMPLETED→ARCHIVED）
- Q: 本地存儲空間的動態管理策略 → A: 嚴格計數機制：1-2張正常操作，3-4張警告提示，5張停止操作並強制同步，有網路時持續嘗試同步釋放空間
- Q: OCR處理優先級和用戶確認流程的平衡 → A: 批次確認模式：用戶可連續拍攝，稍後統一確認多張卡片的OCR結果
- Q: 網絡狀態變化的處理策略 → A: 網絡感知式同步策略：系統智能檢測網絡狀態變化，在網絡可用時積極同步，網絡不穩定時保守管理本地空間
