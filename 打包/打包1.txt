This file is a merged representation of the entire codebase, combined into a single document by Repomix.
The content has been processed where security check has been disabled.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Security check has been disabled - content may contain sensitive information
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
netlify/
  functions/
    gemini-proxy.js
public/
  index.html
src/
  App.css
  App.js
  index.css
  index.js
.gitignore
netlify.toml
package.json
README.md
tailwind.config.js
åƒè€ƒç¨‹å¼.txt
åƒè€ƒç¨‹å¼2.txt
åƒè€ƒç¨‹å¼3.txt
åƒè€ƒç¨‹å¼4.txt
åƒè€ƒç¨‹å¼5.txt
å¾…å¯¦ä½œ.txt
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="netlify/functions/gemini-proxy.js">
// ä½¿ç”¨ ES æ¨¡çµ„èªæ³•ï¼ŒNetlify Functions æ”¯æ´
import fetch from 'node-fetch';

// API é‡‘é‘°å¾ç’°å¢ƒè®Šæ•¸è®€å–ï¼Œç¢ºä¿å®‰å…¨
const apiKey = process.env.GEMINI_API_KEY;

// Netlify Function çš„ä¸»è¦è™•ç†å‡½æ•¸
exports.handler = async (event, context) => {
  // åªå…è¨± POST è«‹æ±‚
  if (event.httpMethod !== 'POST') {
    return {
      statusCode: 405,
      body: JSON.stringify({ error: 'Method Not Allowed' }),
    };
  }

  try {
    // å¾å‰ç«¯è«‹æ±‚ä¸­è§£æå‡ºè³‡æ–™
    const { systemPrompt, userPrompt, base64Image } = JSON.parse(event.body);

    // é©—è­‰æ”¶åˆ°çš„è³‡æ–™
    if (!systemPrompt || !userPrompt || !base64Image) {
      return {
        statusCode: 400,
        body: JSON.stringify({ error: 'Missing required fields: systemPrompt, userPrompt, or base64Image' }),
      };
    }
    
    // Google Gemini API çš„ç«¯é»
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;

    // æ§‹å»ºèˆ‡ Google API è¦æ ¼ç›¸ç¬¦çš„ payload
    const payload = {
      contents: [{
        role: "user",
        parts: [
          { text: userPrompt },
          {
            inlineData: {
              mimeType: "image/jpeg",
              data: base64Image
            }
          }
        ]
      }],
      systemInstruction: { parts: [{ text: systemPrompt }] },
      generationConfig: {
        responseMimeType: "application/json",
        responseSchema: {
          type: "OBJECT",
          properties: {
            "scannedBarcode": { "type": "STRING", "description": "å½±åƒä¸­æ‰¾åˆ°çš„ EAN, UPC æˆ–å…¶ä»–ç”¢å“æ¢ç¢¼æ•¸å­—ï¼Œå¦‚æœä¸å¯è¦‹å‰‡ç‚ºç©ºå­—ä¸²ã€‚" },
            "extractedPrice": { "type": "STRING", "description": "ä¸»è¦å”®åƒ¹ï¼Œæ ¼å¼ç‚ºä¹¾æ·¨çš„å­—ä¸²ï¼Œä¸å¸¶è²¨å¹£ç¬¦è™Ÿï¼ˆä¾‹å¦‚ï¼š'120.5'ï¼‰ã€‚å¦‚æœæ‰¾ä¸åˆ°åƒ¹æ ¼å‰‡ç‚ºç©ºå­—ä¸²ã€‚" },
            "storeName": { "type": "STRING", "description": "åƒ¹ç›®æ¨™ç±¤æˆ–æ”¶æ“šæ‰€ç¤ºçš„å•†åº—åç¨±ã€‚å¦‚æœä¸å¯è¦‹å‰‡ç‚ºç©ºå­—ä¸²ã€‚" },
            "discountDetails": { "type": "STRING", "description": "ç™¼ç¾çš„ä»»ä½•ä¿ƒéŠ·æˆ–æŠ˜æ‰£çš„è©³ç´°æè¿°ï¼ˆä¾‹å¦‚ï¼š'è²·ä¸€é€ä¸€', 'ç¬¬äºŒä»¶åŠåƒ¹', 'æœ‰æ•ˆæœŸé™ 2026/01/01'ï¼‰ã€‚å¦‚æœæ²’æœ‰æŠ˜æ‰£å‰‡ç‚ºç©ºå­—ä¸²ã€‚" }
          },
          "required": ["scannedBarcode", "extractedPrice", "storeName", "discountDetails"]
        }
      }
    };

    // å‘¼å« Google API
    const response = await fetch(apiUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });

    // æª¢æŸ¥ Google API çš„å›æ‡‰
    if (!response.ok) {
      const errorBody = await response.json();
      console.error('Google API Error:', errorBody);
      return {
        statusCode: response.status,
        body: JSON.stringify({ error: `Google API error: ${errorBody.error?.message || 'Unknown error'}` }),
      };
    }

    // å°‡ Google API çš„æˆåŠŸå›æ‡‰ç›´æ¥å‚³å›çµ¦å‰ç«¯
    const data = await response.json();
    return {
      statusCode: 200,
      body: JSON.stringify(data),
    };

  } catch (error) {
    console.error('Serverless Function Error:', error);
    return {
      statusCode: 500,
      body: JSON.stringify({ error: `Internal Server Error: ${error.message}` }),
    };
  }
};
</file>

<file path="public/index.html">
<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="æ¯”åƒ¹ç¥å™¨ - æ¢ç¢¼æƒæèˆ‡åƒ¹æ ¼æ¯”è¼ƒæ‡‰ç”¨"
    />
    <title>æ¯”åƒ¹ç¥å™¨</title>
  </head>
  <body>
    <noscript>æ‚¨éœ€è¦å•Ÿç”¨JavaScriptæ‰èƒ½é‹è¡Œæ­¤æ‡‰ç”¨ç¨‹å¼ã€‚</noscript>
    <div id="root"></div>
  </body>
</html>
</file>

<file path="src/App.css">
/* æ‡‰ç”¨åŸºæœ¬æ¨£å¼ */
.App {
  text-align: center;
  min-height: 100vh;
}

/* è‡ªå®šç¾©æ¨£å¼å¯ä»¥åœ¨é€™è£¡æ·»åŠ  */
</file>

<file path="src/App.js">
import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { PaintBucket, DollarSign, Barcode, ClipboardCheck, X, Camera, Zap, FileText, RotateCcw } from 'lucide-react';

// -----------------------------------------------------------------------------
// 1. æ ¸å¿ƒè¨­å®šèˆ‡å·¥å…·å‡½æ•¸ (Core Setup & Utilities)
// -----------------------------------------------------------------------------

// MVP éšæ®µä½¿ç”¨ Local Storage æ¨¡æ“¬ App ID
const MVP_APP_ID = 'mvp-local-price-app'; 

/**
 * DJB2 é›œæ¹Šç®—æ³•ï¼šå°‡æ¢ç¢¼å­—ä¸²è½‰æ›ç‚ºæ•¸å€¼ ID (numericalID)ã€‚
 * @param {string} str - åŸå§‹æ¢ç¢¼å­—ä¸²
 * @returns {number} - 32ä½å…ƒç„¡ç¬¦è™Ÿæ•´æ•¸
 */
function djb2Hash(str) {
    let hash = 5381;
    for (let i = 0; i < str.length; i++) {
        // hash * 33 + charCode
        hash = ((hash << 5) + hash) + str.charCodeAt(i);
    }
    // è½‰æ›ç‚ºç„¡ç¬¦è™Ÿ 32 ä½æ•´æ•¸
    return hash >>> 0;
}

/**
 * æŒ‡æ•¸é€€é¿ (Exponential Backoff) åŸ·è¡Œ API å‘¼å«
 */
async function callGeminiApiWithRetry(payload, apiUrl, maxRetries = 3) {
    let lastError = null;
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API response error: ${response.status} - ${errorBody.error?.message || 'Unknown error'}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const jsonText = candidate.content.parts[0].text;
                try {
                    // è§£æ JSON å…§å®¹
                    return JSON.parse(jsonText);
                } catch (parseError) {
                    console.error("JSON Parse Error:", jsonText, parseError);
                    throw new Error("AI è¼¸å‡ºæ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æ JSONã€‚");
                }
            } else {
                throw new Error("AI ç„¡æ³•ç”Ÿæˆæœ‰æ•ˆå…§å®¹ã€‚");
            }

        } catch (error) {
            lastError = error;
            console.warn(`API call failed (Attempt ${i + 1}/${maxRetries}):`, error.message);
            if (i < maxRetries - 1) {
                const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }
    throw lastError; // æ‰€æœ‰é‡è©¦å¤±æ•—å¾Œæ‹‹å‡ºæœ€å¾Œä¸€å€‹éŒ¯èª¤
}


// -----------------------------------------------------------------------------
// 2. ä¸»é¡Œé…ç½®èˆ‡æœ¬åœ°å„²å­˜è¨­å®š (Theming & Local Setup)
// -----------------------------------------------------------------------------

const THEMES = {
    'Default (Indigo)': { primary: 'bg-indigo-600', light: 'bg-indigo-100', hover: 'hover:bg-indigo-700', border: 'border-indigo-600', text: 'text-indigo-600', color: 'indigo' },
    'æµ·æ´‹è— (Ocean Blue)': { primary: 'bg-blue-600', light: 'bg-blue-100', hover: 'hover:bg-blue-700', border: 'border-blue-600', text: 'text-blue-600', color: 'blue' },
    'æ£®æ—ç¶  (Forest Green)': { primary: 'bg-green-600', light: 'bg-green-100', hover: 'hover:bg-green-700', border: 'border-green-600', text: 'text-green-600', color: 'green' },
    'å¤•é™½ç´… (Sunset Red)': { primary: 'bg-red-600', light: 'bg-red-100', hover: 'hover:bg-red-700', border: 'border-red-600', text: 'text-red-600', color: 'red' },
    'æ´»åŠ›æ©™ (Vibrant Orange)': { primary: 'bg-orange-600', light: 'bg-orange-100', hover: 'hover:bg-orange-700', border: 'border-orange-600', text: 'text-orange-600', color: 'orange' },
    'è–°è¡£è‰ç´« (Lavender)': { primary: 'bg-purple-600', light: 'bg-purple-100', hover: 'hover:bg-purple-700', border: 'border-purple-600', text: 'text-purple-600', color: 'purple' },
};
const DEFAULT_THEME_KEY = 'Default (Indigo)';

function useLocalMVPSetup() {
    const [userId] = useState(() => {
        let savedId = localStorage.getItem('mvp_user_id');
        if (!savedId) {
            savedId = crypto.randomUUID();
            localStorage.setItem('mvp_user_id', savedId);
        }
        return savedId;
    });

    const [currentTheme, setCurrentTheme] = useState(() => {
        const savedKey = localStorage.getItem('appTheme') || DEFAULT_THEME_KEY;
        return THEMES[savedKey] || THEMES[DEFAULT_THEME_KEY];
    });

    const saveUserTheme = useCallback((themeKey) => {
        localStorage.setItem('appTheme', themeKey);
        setCurrentTheme(THEMES[themeKey] || THEMES[DEFAULT_THEME_KEY]);
    }, []);

    const isAuthReady = true; 
    
    return { userId, isAuthReady, currentTheme, saveUserTheme, appId: MVP_APP_ID };
}

// ä¸»é¡Œé¸æ“‡å…ƒä»¶ (Theme Selector Component)
function ThemeSelector({ theme, saveTheme, onClose }) {
    // æ¸²æŸ“é‚è¼¯èˆ‡ä¹‹å‰ç›¸åŒï¼Œç•¥
    const handleThemeChange = (themeKey) => {
        saveTheme(themeKey);
    };

    const handleReset = () => {
        saveTheme(DEFAULT_THEME_KEY);
    };

    return (
        <div className="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all">
                <h3 className={`text-xl font-bold ${theme.text} mb-4 border-b pb-2`}>
                    <PaintBucket className="inline-block w-5 h-5 mr-2" />
                    ä»‹é¢é…è‰²é¸é …
                </h3>
                
                <div className="grid grid-cols-2 gap-4 mb-6">
                    {Object.keys(THEMES).map((themeKey) => {
                        const themeData = THEMES[themeKey];
                        const isSelected = theme.color === themeData.color;
                        return (
                            <button
                                key={themeKey}
                                onClick={() => handleThemeChange(themeKey)}
                                className={`
                                    p-3 rounded-lg text-white font-medium shadow-md transition-all 
                                    ${themeData.primary} ${themeData.hover} 
                                    ${isSelected ? 'ring-4 ring-offset-2 ring-opacity-70 ring-gray-400' : ''}
                                `}
                                style={{ transform: isSelected ? 'scale(1.05)' : 'scale(1)' }}
                            >
                                {themeKey}
                            </button>
                        );
                    })}
                </div>

                <div className="flex justify-between items-center pt-4 border-t">
                    <button
                        onClick={handleReset}
                        className="flex items-center text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors"
                    >
                        <RotateCcw className="w-4 h-4 mr-1" />
                        æ¸…é™¤é‚„åŸ (é è¨­)
                    </button>
                    <button
                        onClick={onClose}
                        className={`px-4 py-2 text-white font-semibold rounded-lg shadow-lg ${theme.primary} ${theme.hover} transition-all`}
                    >
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    );
}

// -----------------------------------------------------------------------------
// 3. AI è¦–è¦ºæ“·å–èˆ‡åˆ†æå…ƒä»¶ (AIOcrCaptureModal)
// -----------------------------------------------------------------------------

/**
 * è² è²¬æ”å½±æ©Ÿå­˜å–ã€æ“·å–ç•«é¢ä¸¦å‘¼å« AI é€²è¡Œåˆ†æçš„ Modal å…ƒä»¶ã€‚
 * è¼¸å‡ºç‚ºçµæ§‹åŒ– JSON æ•¸æ“šã€‚
 */
function AIOcrCaptureModal({ theme, onAnalysisSuccess, onClose }) {
    const videoRef = useRef(null);
    const streamRef = useRef(null);
    const [isCameraOn, setIsCameraOn] = useState(false);
    const [scanError, setScanError] = useState('');
    const [isAnalyzing, setIsAnalyzing] = useState(false);
    const [capturedImage, setCapturedImage] = useState(null);

    const stopCamera = useCallback(() => {
        if (streamRef.current) {
            streamRef.current.getTracks().forEach(track => track.stop());
            streamRef.current = null;
        }
        if (videoRef.current) {
            videoRef.current.srcObject = null;
        }
        setIsCameraOn(false);
    }, []);

    const startCamera = useCallback(async () => {
        setScanError('');
        setCapturedImage(null);
        setIsCameraOn(true); 
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    facingMode: "environment",
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                }
            });
            streamRef.current = stream;

            if (videoRef.current) {
                videoRef.current.srcObject = stream;
                await videoRef.current.play();
            }
        } catch (err) {
            console.error("ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:", err);
            setScanError(`ç„¡æ³•å­˜å–æ”å½±æ©Ÿæˆ–æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚ (${err.name} - ${err.message})`);
            setIsCameraOn(false);
        }
    }, []);

    // On mount, start the camera. On unmount, stop it.
    useEffect(() => {
        startCamera();
        return () => {
            stopCamera();
        };
    // eslint-disable-next-line react-hooks/exhaustive-deps
    }, []);

    const handleCapture = useCallback(() => {
        if (!videoRef.current || !videoRef.current.srcObject) return;

        const video = videoRef.current;
        const canvas = document.createElement('canvas');
        
        const cropWidth = video.videoWidth * 0.75;
        const cropHeight = video.videoHeight * 0.75;
        const cropX = (video.videoWidth - cropWidth) / 2;
        const cropY = (video.videoHeight - cropHeight) / 2;

        canvas.width = cropWidth;
        canvas.height = cropHeight;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, cropX, cropY, cropWidth, cropHeight, 0, 0, canvas.width, canvas.height);

        const base64Data = canvas.toDataURL('image/jpeg', 0.9);
        
        stopCamera();
        setCapturedImage(base64Data);

    }, [stopCamera]);

    // å‘¼å« Gemini API é€²è¡Œè¦–è¦ºåˆ†æ
    const handleAnalyze = useCallback(async () => {
        if (!capturedImage) {
            setScanError("æ²’æœ‰å¯åˆ†æçš„å½±åƒã€‚");
            return;
        }
        setIsAnalyzing(true);
        setScanError('');

        try {
            const base64Image = capturedImage.split(',')[1]; // ç§»é™¤ MIME é¡å‹å‰ç¶´

            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åƒ¹ç›®æ¨™ç±¤å’Œæ”¶æ“šåˆ†æå¸«ã€‚è«‹å¾æä¾›çš„å½±åƒä¸­æå–ç”¢å“æ¢ç¢¼ï¼ˆå¦‚æœå¯è¦‹ï¼‰ã€ä¸»è¦å”®åƒ¹ã€å•†åº—åç¨±ä»¥åŠä»»ä½•è©³ç´°çš„æŠ˜æ‰£æˆ–ä¿ƒéŠ·è³‡è¨Šã€‚è«‹åš´æ ¼ä»¥ JSON æ ¼å¼è¼¸å‡ºã€‚";
            const userPrompt = "åˆ†ææ­¤ç”¢å“æˆ–åƒ¹ç›®æ¨™ç±¤çš„å½±åƒï¼Œä¸¦æå–æ‰€éœ€çš„çµæ§‹åŒ–è³‡è¨Šã€‚è«‹åœ¨ discountDetails ä¸­æä¾›æ‰€æœ‰ç›¸é—œçš„ä¿ƒéŠ·è¨Šæ¯ï¼Œä¾‹å¦‚è²·ä¸€é€ä¸€ã€æœ‰æ•ˆæœŸé™ç­‰ã€‚";
            const apiUrl = `/.netlify/functions/gemini-proxy`;

            const payload = { systemPrompt, userPrompt, base64Image };

            const analysisResult = await callGeminiApiWithRetry(payload, apiUrl);

            onAnalysisSuccess(analysisResult);
            onClose();

        } catch (error) {
            console.error("AI åˆ†æå¤±æ•—:", error);
            setScanError(`AI åˆ†æéŒ¯èª¤: ${error.message}`);
        } finally {
            setIsAnalyzing(false);
        }
    }, [capturedImage, onAnalysisSuccess, onClose]);

    // æ¨¡æ“¬ AI åˆ†ææˆåŠŸ
    const handleSimulatedAnalysis = () => {
        const mockResult = {
            scannedBarcode: '4710123456789',
            extractedPrice: (Math.random() * 50 + 100).toFixed(0).toString(),
            storeName: 'æ¨¡æ“¬è¶…å•† (AI)',
            discountDetails: 'è²·äºŒé€ä¸€å„ªæƒ  / é™æ™‚ä¿ƒéŠ·',
        };
        onAnalysisSuccess(mockResult);
        onClose();
    };

    const themePrimary = theme.primary;
    const themeHover = theme.hover;

    return (
        <div className="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex flex-col items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all flex flex-col items-center">
                <header className="flex justify-between items-center w-full mb-4 border-b pb-2">
                    <h3 className={`text-xl font-bold ${theme.text} flex items-center`}>
                        <Zap className="inline-block w-5 h-5 mr-2" />
                        AI è¦–è¦ºæ“·å–èˆ‡åˆ†æ
                    </h3>
                    <button onClick={() => { stopCamera(); onClose(); }} className="p-1 rounded-full text-gray-500 hover:text-gray-900">
                        <X className="w-6 h-6" />
                    </button>
                </header>

                {/* ç‹€æ…‹é¡¯ç¤º */}
                {isAnalyzing && (
                    <div className={`w-full p-4 mb-4 rounded-lg bg-yellow-100 text-yellow-800 flex items-center justify-center`}>
                        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        æ­£åœ¨å‘¼å« AI åˆ†æå½±åƒï¼Œè«‹ç¨å€™...
                    </div>
                )}
                
                {scanError ? (
                    <div className="text-red-600 bg-red-100 p-4 rounded-lg w-full mb-4 text-center">
                        {scanError}
                    </div>
                ) : (
                    <div className="relative w-full aspect-video bg-black rounded-lg overflow-hidden mb-4 border-4 border-dashed border-white">
                        {capturedImage ? (
                            <img src={capturedImage} alt="Captured" className="w-full h-full object-contain" />
                        ) : (
                            <video 
                                ref={videoRef} 
                                className="w-full h-full object-cover" 
                                playsInline 
                                muted
                            ></video>
                        )}
                        {/* æƒæå°ç„¦æ¡† (åƒ…åœ¨æ”å½±æ©Ÿé–‹å•Ÿæ™‚é¡¯ç¤º) */}
                        {isCameraOn && (
                            <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                <div className="w-[75%] h-[75%] border-4 border-yellow-400 border-opacity-75 rounded-lg shadow-lg"></div>
                            </div>
                        )}
                    </div>
                )}
                
                {/* å‹•ä½œæŒ‰éˆ• */}
                <div className="w-full">
                    {!capturedImage && isCameraOn && !scanError && (
                        <button
                            onClick={handleCapture}
                            className={`w-full p-3 mb-3 rounded-lg text-white font-semibold shadow-lg transition-all ${themePrimary} ${themeHover} flex items-center justify-center`}
                            disabled={isAnalyzing}
                        >
                            <Camera className="w-5 h-5 mr-2" />
                            æ“·å–ç•«é¢
                        </button>
                    )}

                    {capturedImage && !scanError && (
                        <div className="grid grid-cols-2 gap-4 mb-3">
                            <button
                                onClick={startCamera} // é‡æ–°æ‹æ”
                                className="w-full p-3 rounded-lg bg-gray-500 hover:bg-gray-600 text-white font-semibold shadow-lg transition-all flex items-center justify-center"
                                disabled={isAnalyzing}
                            >
                                é‡æ–°æ‹æ”
                            </button>
                            <button
                                onClick={handleAnalyze}
                                className={`w-full p-3 rounded-lg text-white font-semibold shadow-lg transition-all ${themePrimary} ${themeHover} flex items-center justify-center`}
                                disabled={isAnalyzing}
                            >
                                <Zap className="w-5 h-5 mr-2" />
                                é–‹å§‹ AI åˆ†æ
                            </button>
                        </div>
                    )}

                    {/* æ¨¡æ“¬æŒ‰éˆ• (ç”¨æ–¼æ¸¬è©¦) */}
                    <button
                        onClick={handleSimulatedAnalysis}
                        className="w-full p-3 mb-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow-lg transition-all"
                        disabled={isAnalyzing}
                    >
                        æ¨¡æ“¬ AI åˆ†ææˆåŠŸ (æ¸¬è©¦ç”¨)
                    </button>

                    <button
                        onClick={() => { stopCamera(); onClose(); }}
                        className="w-full p-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow-lg transition-all"
                        disabled={isAnalyzing}
                    >
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    );
}


// -----------------------------------------------------------------------------
// 4. ä¸»æ‡‰ç”¨ç¨‹å¼å…ƒä»¶ (App Component)
// -----------------------------------------------------------------------------

function App() {
    const { userId, isAuthReady, currentTheme, saveUserTheme } = useLocalMVPSetup();
    
    // UI ç‹€æ…‹ç®¡ç†
    const [barcode, setBarcode] = useState('');
    const [productName, setProductName] = useState('');
    const [currentPrice, setCurrentPrice] = useState('');
    const [discountDetails, setDiscountDetails] = useState(''); 
    const [isThemeModalOpen, setIsThemeModalOpen] = useState(false);
    const [isCaptureModalOpen, setIsCaptureModalOpen] = useState(false); 
    const [comparisonResult, setComparisonResult] = useState({
        isBest: false,
        bestPrice: null,
        bestStore: null,
        message: 'ç­‰å¾…æ¯”åƒ¹æ•¸æ“š...'
    });
    const [isLoading, setIsLoading] = useState(false); 
    const [lookupStatus, setLookupStatus] = useState('ready'); 
    const [statusMessage, setStatusMessage] = useState(''); 
    const [storeName, setStoreName] = useState(''); // æ–°å¢å•†åº—åç¨±ç‹€æ…‹

    // -----------------------------------------------------------------------------
    // ç”¢å“è­˜åˆ¥é‚è¼¯ (Local Storage ç‰ˆæœ¬)
    // -----------------------------------------------------------------------------
    const lookupProduct = useCallback(async (barcodeData) => {
        if (!barcodeData || barcodeData.length < 5) {
            setProductName('');
            setLookupStatus('ready');
            return;
        }

        setLookupStatus('searching');
        const numericalID = djb2Hash(barcodeData);
        
        try {
            await new Promise(r => setTimeout(r, 200)); 
            
            const productsJson = localStorage.getItem('MVP_PRODUCTS') || '{}';
            const products = JSON.parse(productsJson);

            if (products[numericalID]) {
                setProductName(products[numericalID].productName);
                setLookupStatus('found');
            } else {
                setProductName('');
                setLookupStatus('new');
            }
        } catch (error) {
            console.error("æŸ¥è©¢ç”¢å“å¤±æ•— (Local Storage):", error);
            setLookupStatus('ready');
        }
    }, []);

    useEffect(() => {
        if (barcode.length > 0 && isAuthReady) {
            const timer = setTimeout(() => {
                lookupProduct(barcode);
            }, 500); 
            return () => clearTimeout(timer); 
        }
    }, [barcode, isAuthReady, lookupProduct]);

    // è™•ç†ç‹€æ…‹è¨Šæ¯è‡ªå‹•æ¶ˆå¤±
    useEffect(() => {
        if (statusMessage) {
            const timer = setTimeout(() => {
                setStatusMessage('');
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [statusMessage]);

    // è™•ç† AI åˆ†ææˆåŠŸä¸¦å¡«å…¥æ¬„ä½
    const handleAiCaptureSuccess = useCallback((result) => {
        const { scannedBarcode, extractedPrice, storeName, discountDetails } = result;
        
        // 1. è‡ªå‹•å¡«å…¥æ¢ç¢¼
        if (scannedBarcode && scannedBarcode.length > 5) {
            setBarcode(scannedBarcode);
        } else if (!barcode) {
             setStatusMessage("AI æœªèƒ½è­˜åˆ¥æ¢ç¢¼ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æˆ–ç¢ºä¿æ¢ç¢¼æ¸…æ™°ï¼");
        }

        // 2. è‡ªå‹•å¡«å…¥åƒ¹æ ¼ã€å•†åº—ã€æŠ˜æ‰£
        setCurrentPrice(extractedPrice || '');
        setStoreName(storeName || '');
        setDiscountDetails(discountDetails || '');

        setStatusMessage(`AI åˆ†ææˆåŠŸï¼åƒ¹æ ¼: $${extractedPrice || '?'}, å•†åº—: ${storeName || '?'}, æŠ˜æ‰£: ${discountDetails || 'ç„¡'}`);
    }, [barcode]);
    
    // å„²å­˜ä¸¦æ¯”åƒ¹å‡½æ•¸ (Local Storage ç‰ˆæœ¬)
    const saveAndComparePrice = useCallback(async () => {
        const numericalID = djb2Hash(barcode);
        const priceValue = parseFloat(currentPrice);

        if (!userId || !barcode || !productName || isNaN(priceValue)) {
            setStatusMessage("è«‹ç¢ºä¿å·²è¼¸å…¥æ¢ç¢¼ã€ç”¢å“åç¨±å’Œæœ‰æ•ˆåƒ¹æ ¼ï¼");
            return;
        }

        setIsLoading(true);
        
        try {
            // å¾ Local Storage ç²å–æ•¸æ“š
            const productsJson = localStorage.getItem('MVP_PRODUCTS') || '{}';
            const allRecordsJson = localStorage.getItem('MVP_PRICE_RECORDS') || '[]';
            let products = JSON.parse(productsJson);
            let allRecords = JSON.parse(allRecordsJson);

            // 0. æª¢æŸ¥ä¸¦å‰µå»ºç”¢å“ä¸»æª” (å¦‚æœä¸å­˜åœ¨)
            if (!products[numericalID]) {
                products[numericalID] = {
                    numericalID,
                    barcodeData: barcode,
                    productName,
                    createdAt: new Date().toISOString(),
                };
                localStorage.setItem('MVP_PRODUCTS', JSON.stringify(products));
            }
            
            // 1. å„²å­˜æ–°çš„åƒ¹æ ¼ç´€éŒ„
            const priceRecord = {
                numericalID,
                productName,
                storeName: storeName || "æ‰‹å‹•è¼¸å…¥",
                price: priceValue,
                discountDetails: discountDetails, 
                timestamp: new Date().toISOString(),
                recordedBy: userId,
            };
            
            allRecords.push(priceRecord);
            localStorage.setItem('MVP_PRICE_RECORDS', JSON.stringify(allRecords));
            
            // 2. åŸ·è¡Œæ¯”åƒ¹é‚è¼¯ - æŸ¥è©¢è©²ç”¢å“æ‰€æœ‰æ­·å²ç´€éŒ„
            const records = allRecords.filter(r => r.numericalID === numericalID);

            if (records.length <= 1) { 
                setComparisonResult({ 
                    isBest: true, 
                    bestPrice: priceValue,
                    bestStore: storeName || "æ‰‹å‹•è¼¸å…¥",
                    message: 'é€™æ˜¯ç¬¬ä¸€ç­†ç´€éŒ„ï¼' 
                });
            } else {
                const bestDeal = records.reduce((best, cur) => cur.price < best.price ? cur : best);
                const isCurrentBest = priceRecord.price <= bestDeal.price;
                
                // æ¯”è¼ƒé‚è¼¯ï¼šæ¨™åƒ¹æœ€ä½å„ªå…ˆï¼›æ¨™åƒ¹ç›¸åŒå‰‡æœ‰æŠ˜æ‰£å„ªå…ˆ
                const isTrulyBest = isCurrentBest && (priceRecord.price < bestDeal.price || (priceRecord.price === bestDeal.price && priceRecord.discountDetails !== ''));
                
                setComparisonResult({
                    isBest: isTrulyBest,
                    bestPrice: bestDeal.price,
                    bestStore: bestDeal.storeName,
                    message: isTrulyBest 
                        ? 'æ­å–œï¼é€™æ˜¯ç›®å‰ç´€éŒ„ä¸­çš„æœ€ä½æ¨™åƒ¹ (æˆ–å…·å‚™æŠ˜æ‰£)ï¼' 
                        : `éæœ€ä½æ¨™åƒ¹ã€‚æ­·å²æœ€ä½æ¨™åƒ¹ç‚º $${bestDeal.price} (å•†åº—: ${bestDeal.storeName})`
                });
            }

        } catch (error) {
            console.error("å„²å­˜æˆ–æ¯”åƒ¹å¤±æ•— (Local Storage):", error);
            setStatusMessage("æ•¸æ“šæ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–æœ¬åœ°å„²å­˜ç©ºé–“ã€‚");
        } finally {
            setIsLoading(false);
        }
    }, [userId, barcode, productName, currentPrice, discountDetails, storeName]); 

    // ä¸»é¡Œè®Šæ•¸ï¼Œç”¨æ–¼å‹•æ…‹ Tailwind é¡åˆ¥
    const themePrimary = currentTheme.primary;
    const themeText = currentTheme.text;
    const themeLight = currentTheme.light;
    const themeBorder = currentTheme.border;

    // æ ¹æ“šæŸ¥è©¢ç‹€æ…‹é¡¯ç¤ºç”¢å“åç¨±æç¤º
    const productNamePlaceholder = useMemo(() => {
        switch(lookupStatus) {
            case 'searching':
                return 'æ­£åœ¨æŸ¥è©¢ç”¢å“è³‡æ–™...';
            case 'found':
                return 'ç”¢å“åç¨±å·²è‡ªå‹•è¼‰å…¥';
            case 'new':
                return 'ç”¢å“ä¸å­˜åœ¨ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åç¨±';
            default:
                return 'è«‹å…ˆè¼¸å…¥æ¢ç¢¼æˆ–æƒææ¢ç¢¼';
        }
    }, [lookupStatus]);


    if (!isAuthReady) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <p className="text-xl text-gray-700">æ­£åœ¨åˆå§‹åŒ–æœ¬åœ°æ‡‰ç”¨ç¨‹å¼...</p>
            </div>
        );
    }

    return (
        <div className={`min-h-screen p-4 sm:p-8 ${themeLight}`}>
            <div className="max-w-xl mx-auto">
                <header className="flex justify-between items-center mb-6 border-b pb-4">
                    <h1 className={`text-3xl font-extrabold ${themeText} flex items-center`}>
                        <Barcode className="w-8 h-8 mr-2" />
                        æ¢ç¢¼æ¯”åƒ¹ç¥å™¨ (MVP-AI)
                    </h1>
                    <div className="flex items-center space-x-3">
                        <button 
                            onClick={() => setIsThemeModalOpen(true)}
                            className={`p-2 rounded-full text-white shadow-md transition-all ${themePrimary} hover:opacity-80`}
                            title="è¨­å®šä»‹é¢ä¸»é¡Œ"
                        >
                            <PaintBucket className="w-5 h-5" />
                        </button>
                        <p className="text-sm text-gray-500 hidden sm:block">ç”¨æˆ¶ ID: {userId}</p>
                    </div>
                </header>

                {/* ç‹€æ…‹è¨Šæ¯æç¤º */}
                {statusMessage && (
                    <div className="bg-red-500 text-white p-3 rounded-lg shadow-md mb-4 text-center font-medium transition-opacity duration-300">
                        {statusMessage}
                    </div>
                )}

                {/* æ•´åˆæµç¨‹å¡ç‰‡ï¼šAI æ“·å–å…¥å£ */}
                <div className={`p-6 rounded-xl shadow-2xl bg-white border-t-4 ${themeBorder}`}>
                    <h2 className={`text-xl font-semibold ${themeText} mb-6 flex items-center`}>
                        <Zap className="w-5 h-5 mr-2" /> 
                        æ­¥é©Ÿ 1: AI è¦–è¦ºè‡ªå‹•æ“·å–è³‡æ–™
                    </h2>
                    
                    {/* AI æ“·å–æŒ‰éˆ• - é–‹å•Ÿ Modal */}
                    <button 
                        className={`w-full p-4 rounded-lg text-white font-bold text-lg shadow-xl transition-all ${themePrimary} hover:opacity-80 flex items-center justify-center`}
                        onClick={() => setIsCaptureModalOpen(true)}
                    >
                        <Camera className="inline-block w-6 h-6 mr-3" /> 
                        é–‹å•Ÿé¡é ­ï¼Œæ“·å–æ¢ç¢¼èˆ‡åƒ¹ç›®æ¨™ç±¤
                    </button>
                    
                    <hr className="my-6 border-gray-200" />

                    <h2 className={`text-xl font-semibold text-gray-700 mb-4 flex items-center`}>
                        <FileText className="w-5 h-5 mr-2" /> 
                        æ­¥é©Ÿ 2: æª¢æŸ¥æˆ–æ‰‹å‹•è¼¸å…¥è³‡æ–™
                    </h2>

                    {/* æ¢ç¢¼è¼¸å…¥å€ */}
                    <div className="mb-4">
                        <label className="block text-gray-700 font-medium mb-1">æ¢ç¢¼æ•¸æ“š (Barcode Data)</label>
                        <input
                            type="text"
                            value={barcode}
                            onChange={(e) => setBarcode(e.target.value)}
                            placeholder="AI è‡ªå‹•å¡«å…¥ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                        />
                    </div>
                    
                    {/* ç”¢å“åç¨±å€ - é…åˆè‡ªå‹•æŸ¥è©¢ */}
                    <div className="mb-4">
                        <label className="block text-gray-700 font-medium mb-1">ç”¢å“åç¨± (Product Name)</label>
                        <input
                            type="text"
                            value={productName}
                            onChange={(e) => setProductName(e.target.value)}
                            placeholder={productNamePlaceholder}
                            className={`w-full p-3 border border-gray-300 rounded-lg transition 
                                ${lookupStatus === 'found' ? 'bg-green-50' : lookupStatus === 'new' ? 'bg-yellow-50' : ''}`}
                            readOnly={lookupStatus === 'found'} 
                        />
                        <p className="text-sm text-gray-500 mt-1">
                            æ•¸å€¼ ID (Hash): {barcode ? djb2Hash(barcode) : 'å°šæœªè¨ˆç®—'}
                        </p>
                    </div>

                    {/* åƒ¹æ ¼èˆ‡å•†åº—è¼¸å…¥/OCR å€ */}
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">æ¨™åƒ¹ ($) <span className="text-red-500">*</span></label>
                            <input
                                type="number"
                                value={currentPrice}
                                onChange={(e) => setCurrentPrice(e.target.value)}
                                placeholder="AI æ“·å–"
                                className="w-full p-3 border border-gray-300 rounded-lg"
                            />
                        </div>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">å•†åº—åç¨±</label>
                            <input
                                type="text"
                                value={storeName} 
                                onChange={(e) => setStoreName(e.target.value)}
                                placeholder="AI æ“·å–"
                                className="w-full p-3 border border-gray-300 rounded-lg"
                            />
                        </div>
                    </div>
                    
                    {/* å„ªæƒ ç´°ç¯€è¼¸å…¥å€ (æ–°å¢) */}
                    <div className="mb-6">
                        <label className="block text-gray-700 font-medium mb-1">å„ªæƒ ç´°ç¯€/ä¿ƒéŠ·æ´»å‹• (Discount Details)</label>
                        <input
                            type="text"
                            value={discountDetails}
                            onChange={(e) => setDiscountDetails(e.target.value)}
                            placeholder="AI æ“·å– (ä¾‹å¦‚: è²·äºŒé€ä¸€, ç¬¬äºŒä»¶åŠåƒ¹)"
                            className="w-full p-3 border border-gray-300 rounded-lg"
                        />
                    </div>

                    {/* å„²å­˜ç´€éŒ„ä¸¦æ¯”åƒ¹ */}
                    <button 
                        className={`w-full mt-4 p-3 rounded-lg text-white font-semibold shadow-lg transition-all bg-emerald-500 hover:bg-emerald-600`}
                        onClick={saveAndComparePrice}
                        disabled={isLoading}
                    >
                        <ClipboardCheck className="inline-block w-5 h-5 mr-2" /> 
                        {isLoading ? 'å„²å­˜ä¸¦æ¯”åƒ¹ä¸­...' : 'æ­¥é©Ÿ 3: å„²å­˜ç´€éŒ„ä¸¦æ¯”åƒ¹'}
                    </button>
                </div>

                {/* æ¯”åƒ¹çµæœé¡¯ç¤ºå€ */}
                <div className="mt-8">
                    <h2 className={`text-xl font-semibold ${themeText} mb-4 flex items-center`}>
                        <DollarSign className="w-5 h-5 mr-2" />
                        æ¯”åƒ¹çµæœ
                    </h2>
                    <div className={`p-6 rounded-xl shadow-xl border-2 ${comparisonResult.isBest ? 'border-green-500 bg-green-50' : 'border-yellow-500 bg-yellow-50'}`}>
                        <p className={`text-lg font-bold ${comparisonResult.isBest ? 'text-green-700' : 'text-yellow-700'}`}>
                            {comparisonResult.message}
                        </p>
                        {comparisonResult.bestPrice && (
                            <p className="text-sm text-gray-600 mt-2">
                                æ­·å²æœ€ä½æ¨™åƒ¹: ${comparisonResult.bestPrice}
                            </p>
                        )}
                        <p className="text-xs text-gray-500 mt-2">
                            **é™„è¨»:** æ‚¨çš„ç´€éŒ„å·²å„²å­˜åœ¨ç€è¦½å™¨çš„æœ¬åœ°å„²å­˜ä¸­ (Local Storage)ã€‚
                        </p>
                    </div>
                </div>
            </div>

            {/* ä¸»é¡Œé¸æ“‡ Modal */}
            {isThemeModalOpen && (
                <ThemeSelector 
                    theme={currentTheme} 
                    saveTheme={saveUserTheme} 
                    onClose={() => setIsThemeModalOpen(false)} 
                />
            )}

            {/* AI è¦–è¦ºæ“·å– Modal */}
            {isCaptureModalOpen && (
                <AIOcrCaptureModal
                    theme={currentTheme}
                    onAnalysisSuccess={handleAiCaptureSuccess}
                    onClose={() => setIsCaptureModalOpen(false)}
                />
            )}
        </div>
    );
}

export default App;
</file>

<file path="src/index.css">
@tailwind base;
@tailwind components;
@tailwind utilities;
</file>

<file path="src/index.js">
import React from 'react';
import ReactDOM from 'react-dom/client';
import './index.css';
import App from './App';

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);
</file>

<file path=".gitignore">
node_modules
</file>

<file path="netlify.toml">
# netlify.toml

# é€™å€‹è¨­å®šå‘Šè¨´ Netlify æˆ‘å€‘çš„ Serverless Functions å­˜æ”¾åœ¨å“ªå€‹ç›®éŒ„
[functions]
  directory = "netlify/functions/"

# é€™å€‹è¨­å®šå‘Šè¨´ Netlify åœ¨å»ºç½®å°ˆæ¡ˆæ™‚è¦åŸ·è¡Œçš„æŒ‡ä»¤ä»¥åŠè¦ç™¼å¸ƒçš„ç›®éŒ„
[build]
  command = "npm run build"
  publish = "build"
</file>

<file path="package.json">
{
  "name": "barcode-pricing-comparator",
  "version": "1.0.0",
  "description": "æ¯”åƒ¹ç¥å™¨ - æ¢ç¢¼æƒæèˆ‡åƒ¹æ ¼æ¯”è¼ƒæ‡‰ç”¨",
  "main": "index.js",
  "scripts": {
    "start": "react-scripts start",
    "build": "react-scripts build",
    "test": "react-scripts test",
    "eject": "react-scripts eject"
  },
  "dependencies": {
    "autoprefixer": "^10.4.16",
    "axios": "^1.5.1",
    "firebase": "^10.5.0",
    "lucide-react": "^0.545.0",
    "node-fetch": "^2.7.0",
    "postcss": "^8.4.31",
    "quagga": "^0.12.1",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-scripts": "5.0.1",
    "tailwindcss": "^3.3.3",
    "uuid": "^9.0.1"
  },
  "devDependencies": {
    "@babel/plugin-transform-class-properties": "^7.23.3",
    "@babel/plugin-transform-nullish-coalescing-operator": "^7.23.3",
    "@babel/plugin-transform-numeric-separator": "^7.23.3",
    "@babel/plugin-transform-optional-chaining": "^7.23.3",
    "@babel/plugin-transform-private-methods": "^7.23.3",
    "@babel/plugin-transform-private-property-in-object": "^7.23.3",
    "@types/react": "^18.2.25",
    "@types/react-dom": "^18.2.10",
    "eslint": "^8.57.1",
    "eslint-config-react-app": "^7.0.1"
  },
  "eslintConfig": {
    "extends": [
      "react-app",
      "react-app/jest"
    ]
  },
  "browserslist": {
    "production": [
      ">0.2%",
      "not dead",
      "not op_mini all"
    ],
    "development": [
      "last 1 chrome version",
      "last 1 firefox version",
      "last 1 safari version"
    ]
  }
}
</file>

<file path="README.md">
"# Barcodepricing" 
"# Barcodepricing"
</file>

<file path="tailwind.config.js">
/** @type {import('tailwindcss').Config} */
module.exports = {
  content: [
    "./src/**/*.{js,jsx,ts,tsx}",
  ],
  theme: {
    extend: {},
  },
  plugins: [],
}
</file>

<file path="åƒè€ƒç¨‹å¼.txt">
import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, addDoc } from 'firebase/firestore'; 

// --- Firebase Configuration and Initialization ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

// The Quagga global object is assumed to be available via CDN script injection
const Quagga = window.Quagga; 

// Hardcoded list of local supermarkets for demonstration
const STORES = ['å®¶æ¨‚ç¦ (Carrefour)', 'å…¨è¯ (PX Mart)', 'å¤§æ½¤ç™¼ (RT-Mart)', 'ç¾å»‰ç¤¾ (Simple Mart)', 'å…¶ä»–'];

// Simple DJB2-like hash function optimized for speed and consistency
function generateNumericalID(str) {
    let hash = 5381;
    let i = str.length;

    while (i) {
        hash = (hash * 33) ^ str.charCodeAt(--i);
    }

    return hash >>> 0;
}

// Custom hook to handle Firebase setup and user authentication
const useFirebase = () => {
    const [db, setDb] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isLoading, setIsLoading] = useState(true);

    useEffect(() => {
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase configuration is missing.");
            setIsLoading(false);
            return;
        }

        try {
            const app = initializeApp(firebaseConfig);
            const authInstance = getAuth(app);
            const dbInstance = getFirestore(app);
            setDb(dbInstance);

            const unsubscribe = onAuthStateChanged(authInstance, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    setIsLoading(false);
                } else {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(authInstance, initialAuthToken);
                        } else {
                            await signInAnonymously(authInstance);
                        }
                    } catch (error) {
                        console.error("Firebase sign-in failed:", error);
                        setIsLoading(false);
                    }
                }
            });

            return () => unsubscribe();
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            setIsLoading(false);
        }
    }, []);

    return { db, userId, isLoading };
};

// Utility function to convert File to Base64
const fileToBase64 = (file) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]); // Only data part
        reader.onerror = (error) => reject(error);
    });
};

// Main App Component
const App = () => {
    const { db, userId, isLoading } = useFirebase();
    const [barcodeInput, setBarcodeInput] = useState('');
    const [numericalID, setNumericalID] = useState(null);
    const [statusMessage, setStatusMessage] = useState('ç­‰å¾…è¼¸å…¥æˆ–å•Ÿç”¨ç›¸æ©Ÿ...');
    const [isScanning, setIsScanning] = useState(false);
    const [isDetected, setIsDetected] = useState(false);
    const [isOCRCaptureMode, setIsOCRCaptureMode] = useState(false); // NEW: OCR Mode state
    const [isOCRLoading, setIsOCRLoading] = useState(false); // NEW: OCR Loading state
    
    // Product Master Data States
    const [productName, setProductName] = useState('');
    const [isProductExist, setIsProductExist] = useState(false);

    // Price Record States (Current Scan)
    const [currentStore, setCurrentStore] = useState(STORES[0]);
    const [currentPrice, setCurrentPrice] = useState('');
    const [currentDiscount, setCurrentDiscount] = useState('');
    
    // Comparison Results State
    const [comparisonData, setComparisonData] = useState([]); 
    const [bestDeal, setBestDeal] = useState(null); 

    const scannerRef = useRef(null);
    const fileInputRef = useRef(null);

    // Function to reset all product states
    const resetStates = () => {
        setNumericalID(null);
        setProductName('');
        setBarcodeInput('');
        setCurrentPrice('');
        setCurrentDiscount('');
        setIsProductExist(false);
        setComparisonData([]);
        setBestDeal(null);
        setIsOCRCaptureMode(false); // Reset OCR mode
    }

    // --- Gemini OCR Image Analysis Logic ---
    const performOCRAnalysis = async (file) => {
        if (!file) return;

        setIsOCRLoading(true);
        setStatusMessage('ğŸš€ æ­£åœ¨ä¸Šå‚³åœ–ç‰‡ä¸¦é€²è¡Œ Gemini åœ–åƒåˆ†æ (OCR)...');

        try {
            const base64ImageData = await fileToBase64(file);
            
            const systemPrompt = "ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„åƒ¹æ ¼æ¨™ç±¤åˆ†æå¸«ã€‚è«‹ä»”ç´°åˆ†ææä¾›çš„åœ–åƒï¼Œè­˜åˆ¥å•†åº—åç¨±ã€å•†å“çš„æ¨™åƒ¹ï¼ˆåƒ…éœ€æ•¸å­—éƒ¨åˆ†ï¼Œå°æ•¸é»å¾Œå…©ä½ï¼‰ï¼Œä»¥åŠä»»ä½•ç›¸é—œçš„å„ªæƒ æˆ–æŠ˜æ‰£è³‡è¨Šã€‚è«‹ä»¥ JSON æ ¼å¼è¼¸å‡ºçµæœï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡‹æ€§æ–‡å­—ã€‚å¦‚æœç„¡æ³•è­˜åˆ¥ï¼Œè«‹ä½¿ç”¨ç©ºå­—ä¸²æˆ– 0ã€‚";
            const userQuery = "è«‹å¾é€™å¼µåœ–ç‰‡ä¸­æå–å•†åº—åç¨±ã€æ¨™åƒ¹å’Œå„ªæƒ è³‡è¨Šã€‚";
            
            const payload = {
                contents: [
                    {
                        role: "user",
                        parts: [
                            { text: userQuery },
                            {
                                inlineData: {
                                    mimeType: file.type,
                                    data: base64ImageData
                                }
                            }
                        ]
                    }
                ],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "storeName": { "type": "STRING" },
                            "price": { "type": "NUMBER" },
                            "discountDetails": { "type": "STRING" }
                        },
                        "propertyOrdering": ["storeName", "price", "discountDetails"]
                    }
                }
            };

            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            // --- Exponential Backoff for API Call ---
            const maxRetries = 5;
            let attempt = 0;
            let result;

            while (attempt < maxRetries) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) { // Rate limit hit
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempt++;
                            continue; // Retry
                        }
                        throw new Error(`API call failed with status: ${response.status}`);
                    }
                    
                    result = await response.json();
                    break; // Success
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error.message);
                    if (attempt === maxRetries - 1) throw error;
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    attempt++;
                }
            }
            // --- End Exponential Backoff ---

            const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!jsonText) {
                throw new Error("API response was empty or malformed.");
            }
            
            const ocrData = JSON.parse(jsonText);
            
            // Update states with OCR results
            if (ocrData.storeName) setCurrentStore(ocrData.storeName);
            if (ocrData.price && !isNaN(parseFloat(ocrData.price))) setCurrentPrice(ocrData.price.toFixed(2));
            if (ocrData.discountDetails) setCurrentDiscount(ocrData.discountDetails);
            
            setIsOCRCaptureMode(false);
            setStatusMessage(`âœ… åœ–åƒåˆ†æå®Œæˆã€‚çµæœå·²è‡ªå‹•å¡«å…¥ï¼š${ocrData.storeName} $${ocrData.price}`);
            
        } catch (e) {
            console.error("OCR analysis error: ", e);
            setStatusMessage(`ğŸš« åœ–åƒåˆ†æå¤±æ•—ã€‚è«‹æ‰‹å‹•è¼¸å…¥è³‡è¨Šã€‚éŒ¯èª¤: ${e.message}`);
            setIsOCRCaptureMode(false);
        } finally {
            setIsOCRLoading(false);
        }
    };
    
    // Handler for file input change
    const handleFileChange = (event) => {
        const file = event.target.files[0];
        if (file) {
            performOCRAnalysis(file);
        }
    };
    
    // --- Price Comparison Logic (Unchanged) ---
    const fetchComparisonData = async (id, currentRecord) => {
        if (!db) return;

        const pricesRef = collection(db, `artifacts/${appId}/public/data/price_records`);
        const q = query(pricesRef, where('numericalID', '==', id)); 
        
        try {
            const querySnapshot = await getDocs(q);
            let records = [];
            
            querySnapshot.forEach((doc) => {
                records.push({ id: doc.id, ...doc.data() });
            });

            if (currentRecord) {
                records.push({ ...currentRecord, isCurrentScan: true, id: 'current_scan' });
            }

            let lowestPriceRecord = null;
            if (records.length > 0) {
                lowestPriceRecord = records.reduce((min, record) => {
                    return record.price < min.price ? record : min;
                }, records[0]);
            }
            
            setComparisonData(records);
            setBestDeal(lowestPriceRecord);

            return { lowestPriceRecord, records };

        } catch (e) {
            console.error("Error fetching comparison data: ", e);
            setStatusMessage('ğŸš« æ­·å²åƒ¹æ ¼æ¯”è¼ƒå¤±æ•—ã€‚');
            return { lowestPriceRecord: null, records: [] };
        }
    }

    // --- Core Logic: Scan -> Lookup -> Compare (Unchanged) ---
    const processBarcode = async (rawBarcodeData) => {
        if (!rawBarcodeData.trim()) return;

        resetStates(); 
        
        const calculatedNumericalID = generateNumericalID(rawBarcodeData);
        setBarcodeInput(rawBarcodeData);
        setNumericalID(calculatedNumericalID);
        
        setIsDetected(true);
        setTimeout(() => setIsDetected(false), 500); 

        setStatusMessage(`æ•¸å€¼ ID: ${calculatedNumericalID} å·²ç”Ÿæˆã€‚æ­£åœ¨æŸ¥è©¢ç”¢å“ä¸»æª”...`);

        if (db && userId) {
            try {
                // 1. Lookup Product Master Data
                const productDocRef = doc(db, `artifacts/${appId}/public/data/products`, calculatedNumericalID.toString());
                const productSnap = await getDoc(productDocRef);

                if (productSnap.exists()) {
                    const existingData = productSnap.data();
                    setProductName(existingData.productName || 'æœªå‘½åç”¢å“');
                    setIsProductExist(true);
                    setStatusMessage(`ç”¢å“: ${existingData.productName} å·²è¼‰å…¥ã€‚è«‹é€²è¡Œ OCR æˆ–æ‰‹å‹•è¼¸å…¥åƒ¹æ ¼ã€‚`);
                } else {
                    // New product
                    setIsProductExist(false);
                    setStatusMessage('åµæ¸¬åˆ°æ–°ç”¢å“ã€‚è«‹å…ˆè¼¸å…¥ç”¢å“åç¨±ï¼Œç„¶å¾Œé€²è¡Œ OCR æˆ–è¼¸å…¥åƒ¹æ ¼ç´€éŒ„ã€‚');
                }

                // 2. Fetch all historical prices for comparison immediately
                await fetchComparisonData(calculatedNumericalID);

            } catch (e) {
                console.error("Error accessing product master data: ", e);
                setStatusMessage('æ•¸æ“šåº«æŸ¥è©¢å¤±æ•—ï¼Œä½†æ•¸å€¼ ID å·²åœ¨æœ¬åœ°ç”Ÿæˆã€‚');
            }
        }
    };
    
    // --- Save Price Record Logic (Unchanged) ---
    const savePriceRecord = async () => {
        if (!db || !userId || !barcodeInput.trim() || !productName.trim() || isNaN(parseFloat(currentPrice))) {
            setStatusMessage('éŒ¯èª¤ï¼šè«‹ç¢ºä¿ç”¢å“åç¨±å’Œåƒ¹æ ¼çš†å·²è¼¸å…¥ã€‚');
            return;
        }

        const priceValue = parseFloat(currentPrice);
        const rawBarcodeData = barcodeInput.trim();
        const calculatedNumericalID = generateNumericalID(rawBarcodeData);

        const newPriceRecord = {
            numericalID: calculatedNumericalID,
            productName: productName.trim(),
            storeName: currentStore,
            price: priceValue,
            discountDetails: currentDiscount.trim(),
            timestamp: new Date().toISOString(),
            recordedBy: userId,
        };

        try {
            // Check if product master data needs creation/update
            const productDocRef = doc(db, `artifacts/${appId}/public/data/products`, calculatedNumericalID.toString());
            if (!isProductExist) {
                 await setDoc(productDocRef, {
                    numericalID: calculatedNumericalID,
                    barcodeData: rawBarcodeData,
                    productName: productName.trim(),
                    createdAt: new Date().toISOString(),
                    createdBy: userId,
                });
                setIsProductExist(true); 
            } 

            // 1. Save the new price record
            await addDoc(collection(db, `artifacts/${appId}/public/data/price_records`), newPriceRecord);

            // 2. Re-fetch and compare with the new record
            await fetchComparisonData(calculatedNumericalID, newPriceRecord);
            
            setStatusMessage(`ğŸ‰ åƒ¹æ ¼ç´€éŒ„å·²å„²å­˜ã€‚ç•¶å‰ç´€éŒ„ $${priceValue}ã€‚`);

        } catch (e) {
            console.error("Error saving price record: ", e);
            setStatusMessage('ğŸš« åƒ¹æ ¼è³‡æ–™å„²å­˜å¤±æ•—ã€‚');
        }
    }
    
    // --- Input Handlers (Unchanged) ---
    const handleManualScan = () => {
        if (barcodeInput.trim()) {
            processBarcode(barcodeInput);
        }
    };

    const handleKeyDown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            handleManualScan();
        }
    };

    // --- QuaggaJS/Scanning Logic (Unchanged) ---
    useEffect(() => {
        if (!isScanning && Quagga && typeof Quagga.stop === 'function') {
            Quagga.stop();
        }

        if (isScanning && scannerRef.current && Quagga) {
            resetStates(); 
            setStatusMessage('ç›¸æ©Ÿå•Ÿç”¨ä¸­ï¼Œè«‹å°æº–æ¢ç¢¼...');
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: scannerRef.current,
                    constraints: { facingMode: "environment" },
                },
                decoder: {
                    readers: ["ean_reader", "code_128_reader", "code_39_reader", "upc_reader"],
                    multiple: false 
                },
                locator: { patchSize: "medium", halfSample: true },
                numOfWorkers: navigator.hardwareConcurrency || 2,
                locate: true,
            }, (err) => {
                if (err) {
                    console.error("Quagga initialization error:", err);
                    setStatusMessage(`ç›¸æ©Ÿåˆå§‹åŒ–å¤±æ•—: ${err.name}ã€‚è«‹æª¢æŸ¥æ¬Šé™ã€‚`);
                    setIsScanning(false);
                    return;
                }
                Quagga.start();
                setStatusMessage('ç›¸æ©Ÿæƒæä¸­... å˜—è©¦è¾¨è­˜ä¸€ç¶­æ¢ç¢¼ã€‚');
            });

            Quagga.onDetected((data) => {
                const scannedCode = data.codeResult.code;
                if (scannedCode) {
                    Quagga.stop(); 
                    setIsScanning(false);
                    processBarcode(scannedCode);
                }
            });

            return () => {
                if (Quagga && typeof Quagga.stop === 'function') {
                    Quagga.stop();
                    Quagga.offDetected();
                }
            };
        }
    }, [isScanning, db, userId]);

    if (isLoading) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <p className="text-xl font-medium text-indigo-600">è¼‰å…¥ä¸­...</p>
            </div>
        );
    }

    // --- UI Components ---
    
    const ComparisonDisplay = () => {
        if (comparisonData.length === 0) return null;
        if (!bestDeal) return <p className="text-blue-600">ç›®å‰æ²’æœ‰å…¶ä»–æ­·å²åƒ¹æ ¼ç´€éŒ„ã€‚</p>;

        const currentPriceFloat = parseFloat(currentPrice);
        const isBestDeal = currentPriceFloat > 0 && currentPriceFloat === bestDeal.price;
        
        let comparisonMessage;
        if (currentPriceFloat > 0 && isBestDeal) {
            comparisonMessage = <p className="text-lg font-bold text-green-700">ğŸ‰ æ‚¨ç•¶å‰æƒæçš„åƒ¹æ ¼å°±æ˜¯ç›®å‰è³‡æ–™åº«ä¸­çš„æœ€å„ªæƒ åƒ¹æ ¼!</p>;
        } else if (currentPriceFloat > 0 && currentPriceFloat > bestDeal.price) {
            comparisonMessage = (
                <div className="text-lg font-bold text-red-700 space-y-2">
                    <p>ğŸš¨ **æ³¨æ„: åƒ¹æ ¼ä¸æ˜¯æœ€ä½!**</p>
                    <div className="bg-red-50 p-3 rounded-lg border-l-4 border-red-500">
                        <p className="font-normal text-sm text-gray-700">ç›®å‰æœ€å„ªæƒ é¸é …æ˜¯:</p>
                        <p className="font-extrabold text-xl text-red-800">
                            ${bestDeal.price.toFixed(2)} @ {bestDeal.storeName}
                        </p>
                        {bestDeal.discountDetails && <p className="text-xs text-red-600">å„ªæƒ : {bestDeal.discountDetails}</p>}
                    </div>
                </div>
            );
        } else {
             comparisonMessage = <p className="text-lg font-bold text-blue-700">â„¹ï¸ å·²è¼‰å…¥æ­·å²åƒ¹æ ¼ï¼Œè«‹è¼¸å…¥ç•¶å‰åƒ¹æ ¼é€²è¡Œæ¯”è¼ƒã€‚</p>;
        }

        return (
            <div className="pt-4 border-t border-gray-200 mt-4 space-y-4">
                <h3 className="text-xl font-bold text-gray-900">3. æ¯”åƒ¹åˆ†æçµæœ</h3>
                
                {comparisonMessage}

                <details className="text-sm text-gray-600 p-2 bg-gray-50 rounded-lg cursor-pointer">
                    <summary className="font-semibold text-gray-700">æª¢è¦–æ‰€æœ‰ {comparisonData.length} ç­†æ­·å²ç´€éŒ„</summary>
                    <ul className="mt-2 space-y-1">
                        {comparisonData
                            .sort((a, b) => a.price - b.price)
                            .map((record, index) => (
                            <li key={index} className={`flex justify-between items-center py-1 px-2 rounded-md ${record.price === bestDeal.price ? 'bg-yellow-100 font-bold' : 'hover:bg-gray-100'}`}>
                                <span>
                                    {record.storeName} ({new Date(record.timestamp).toLocaleDateString()})
                                </span>
                                <span className="text-lg font-mono">
                                    ${record.price.toFixed(2)}
                                </span>
                            </li>
                        ))}
                    </ul>
                </details>
            </div>
        );
    }
    
    // --- Render ---

    return (
        <div className="min-h-screen flex items-center justify-center p-4 bg-gray-100 font-inter">
            <div className="w-full max-w-lg bg-white shadow-2xl rounded-xl p-8 space-y-6 transform transition duration-500 hover:scale-[1.02]">
                <header className="text-center border-b pb-4">
                    <h1 className="text-3xl font-extrabold text-gray-900">ğŸ›’ æ¢ç¢¼æ¯”åƒ¹ç¥å™¨ (OCR å•Ÿå‹•)</h1>
                    <p className="text-sm text-gray-500 mt-1">é€é AI åœ–åƒåˆ†æè‡ªå‹•è­˜åˆ¥å•†åº—èˆ‡åƒ¹æ ¼</p>
                </header>

                <div className="space-y-4">
                    {/* Mode Toggle Button */}
                    <button
                        onClick={() => {
                            if (isScanning && Quagga) Quagga.stop();
                            setIsScanning(!isScanning);
                            setIsDetected(false); 
                            resetStates();
                        }}
                        className={`w-full flex items-center justify-center px-6 py-3 text-base font-medium rounded-lg shadow-md transition duration-150 ease-in-out transform hover:scale-[1.01] ${
                            isScanning ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-indigo-600 text-white hover:bg-indigo-700'
                        }`}
                    >
                        {isScanning ? 'åœæ­¢æƒæ / åˆ‡æ›è‡³æ‰‹å‹•è¼¸å…¥' : 'å•Ÿç”¨ç›¸æ©Ÿæ¢ç¢¼æƒæ'}
                    </button>
                    
                    {/* Camera/Manual Input */}
                    {(isScanning || !numericalID) && (
                        <div className="space-y-4">
                             {/* Camera Scanner View */}
                            {isScanning && (
                                <div className={`relative w-full aspect-video bg-gray-900 rounded-lg overflow-hidden border-4 transition duration-300 ${isDetected ? 'border-green-500 shadow-xl shadow-green-500/50' : 'border-indigo-500'}`}>
                                    <div ref={scannerRef} style={{ width: '100%', height: '100%', position: 'absolute' }} />
                                    
                                    <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                                        <div className="w-3/4 h-1/2 border-4 border-white border-dashed opacity-80 rounded-lg relative">
                                            <div className={`absolute top-1/2 left-0 right-0 h-0.5 transform -translate-y-1/2 transition duration-100 ${
                                                isDetected ? 'bg-green-500' : 'bg-red-500 animate-pulse'
                                            }`} 
                                            ></div>
                                        </div>
                                    </div>
                                    
                                    <div className="absolute bottom-0 left-0 right-0 text-center text-white text-sm font-semibold p-2 bg-gray-900/60">
                                        {statusMessage}
                                    </div>
                                </div>
                            )}
                            
                            {/* Manual Input View */}
                            {!isScanning && (
                                <div className="space-y-4">
                                    <label htmlFor="barcode" className="block text-lg font-medium text-gray-700">
                                        1. æ‰‹å‹•è¼¸å…¥æ¢ç¢¼æ•¸æ“š:
                                    </label>
                                    <input
                                        type="text"
                                        id="barcode"
                                        value={barcodeInput}
                                        onChange={(e) => setBarcodeInput(e.target.value)}
                                        onKeyDown={handleKeyDown}
                                        className="w-full px-4 py-3 border-2 border-indigo-300 rounded-lg shadow-inner focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 text-gray-800"
                                        placeholder="ä¾‹å¦‚: ç”¢å“ EAN ç¢¼ã€SKU ç¢¼..."
                                    />
                                    <button
                                        onClick={handleManualScan}
                                        className="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-500 focus:ring-opacity-50 transition duration-150 ease-in-out transform hover:translate-y-[-2px] disabled:bg-indigo-400"
                                        disabled={!barcodeInput.trim()}
                                    >
                                        æŸ¥è©¢/ç”Ÿæˆæ•¸å€¼ ID
                                    </button>
                                </div>
                            )}
                        </div>
                    )}
                </div>

                {/* ç”¢å“è³‡æ–™å€ - åªæœ‰æˆåŠŸæƒæå¾Œæ‰é¡¯ç¤º */}
                {numericalID !== null && (
                    <div className="border-t pt-6 space-y-4">
                        <h2 className="text-xl font-bold text-gray-900">
                            2. ç”¢å“è³‡æ–™èˆ‡åƒ¹æ ¼ç´€éŒ„
                        </h2>
                        
                        <div className="bg-indigo-50 border border-indigo-300 p-4 rounded-lg space-y-2">
                            <p className="text-lg font-extrabold text-indigo-800 break-words">
                                å“å: {productName || 'ï¼ˆè«‹è¼¸å…¥åç¨±ä¸¦å„²å­˜ç´€éŒ„ï¼‰'}
                            </p>
                            <p className="text-xs text-indigo-700">
                                æ•¸å€¼ ID: {numericalID} | åŸå§‹æ¢ç¢¼: {barcodeInput}
                            </p>
                            {!isProductExist && (
                                <InputField 
                                    label="è«‹ç‚ºæ–°ç”¢å“å‘½å (å¿…å¡«)"
                                    value={productName}
                                    onChange={setProductName}
                                    type="text"
                                    placeholder="ä¾‹å¦‚: ç‹å­éºµ-åŸå‘³"
                                />
                            )}
                        </div>

                        {/* OCR Capture Toggle */}
                         <button
                            onClick={() => {
                                setIsOCRCaptureMode(true);
                                // Trigger file input click when entering OCR mode
                                if (fileInputRef.current) {
                                    fileInputRef.current.click();
                                }
                            }}
                            className="w-full flex items-center justify-center px-6 py-3 text-base font-medium rounded-lg shadow-md text-white bg-pink-500 hover:bg-pink-600 transition duration-150 transform hover:translate-y-[-1px]"
                            disabled={isOCRLoading}
                        >
                            {isOCRLoading ? 'AI åœ–åƒåˆ†æä¸­...' : 'ğŸ“¸ æ‹ç…§/ä¸Šå‚³åƒ¹æ ¼æ¨™ç±¤é€²è¡Œ OCR'}
                        </button>
                        
                        {/* Hidden File Input for Image Capture */}
                        <input
                            type="file"
                            accept="image/*"
                            capture="environment" // Hint to use back camera on mobile
                            onChange={handleFileChange}
                            ref={fileInputRef}
                            style={{ display: 'none' }}
                        />

                        {/* Price Record Inputs (Manual/OCR Output) */}
                        <div className="space-y-3 pt-4 border-t">
                             <h3 className="text-lg font-semibold text-gray-700">æ–°å¢ç•¶å‰åƒ¹æ ¼ç´€éŒ„ (å¯æ‰‹å‹•ä¿®æ”¹ OCR çµæœ)</h3>
                            
                            <InputField 
                                label="å•†åº— (Store) - ä¾†è‡ª OCR"
                                value={currentStore}
                                onChange={setCurrentStore}
                                type="text" // Changed from SelectField to allow OCR output
                                placeholder="ä¾‹å¦‚: å®¶æ¨‚ç¦"
                            />
                            <InputField 
                                label="åƒ¹æ ¼ (Price) - ä¾†è‡ª OCR / å¿…å¡«"
                                value={currentPrice}
                                onChange={setCurrentPrice}
                                type="number"
                                placeholder="ä¾‹å¦‚: 99.00"
                            />
                            <InputField 
                                label="å„ªæƒ ç´°ç¯€ (Discount Details) - ä¾†è‡ª OCR"
                                value={currentDiscount}
                                onChange={setCurrentDiscount}
                                type="text"
                                placeholder="ä¾‹å¦‚: è²·ä¸€é€ä¸€, ç¬¬äºŒä»¶å…­æŠ˜"
                            />
                        </div>
                        
                        {/* Comparison Display */}
                        <ComparisonDisplay />

                        <button
                            onClick={savePriceRecord}
                            className={`w-full flex items-center justify-center px-6 py-3 text-base font-medium rounded-lg shadow-lg text-white transition duration-150 ease-in-out transform hover:translate-y-[-2px] bg-green-600 hover:bg-green-700 disabled:bg-gray-400`}
                            disabled={!currentPrice.trim() || isNaN(parseFloat(currentPrice)) || !productName.trim()}
                        >
                            å„²å­˜ç•¶å‰åƒ¹æ ¼ç´€éŒ„ä¸¦æ¯”åƒ¹
                        </button>
                    </div>
                )}
                
                {/* ç‹€æ…‹é¡¯ç¤ºå€ */}
                <div className="pt-4 border-t">
                     <div className={`p-3 text-sm rounded-lg ${
                        statusMessage.includes('å¤±æ•—') ? 'bg-red-100 text-red-800' : 
                        statusMessage.includes('æ³¨æ„') ? 'bg-yellow-100 text-yellow-800' : 
                        statusMessage.includes('å·²è¼‰å…¥') || statusMessage.includes('å®Œæˆ') ? 'bg-green-100 text-green-800' :
                        'bg-blue-100 text-blue-800'
                    }`}>
                        <p className="font-semibold">ç•¶å‰ç‹€æ…‹:</p>
                        <p>{statusMessage}</p>
                    </div>
                </div>
            </div>
        </div>
    );
};

// Simple reusable input component
const InputField = ({ label, value, onChange, type, placeholder }) => (
    <div>
        <label className="block text-sm font-medium text-gray-700">
            {label}
        </label>
        <input
            type={type}
            value={value}
            onChange={(e) => onChange(e.target.value)}
            className="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
            placeholder={placeholder}
        />
    </div>
);

// SelectField is no longer used for Store, changed to InputField for direct OCR output.
// Kept here for reference but removed from the main component's render.
const SelectField = ({ label, value, onChange, options }) => (
    <div>
        <label className="block text-sm font-medium text-gray-700">
            {label}
        </label>
        <select
            value={value}
            onChange={(e) => onChange(e.target.value)}
            className="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white"
        >
            {options.map((option) => (
                <option key={option} value={option}>
                    {option}
                </option>
            ))}
        </select>
    </div>
);

export default App;
</file>

<file path="åƒè€ƒç¨‹å¼2.txt">
import React, { useState, useEffect, useCallback, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'firebase/auth';
import { 
    getFirestore, 
    doc, 
    getDoc, 
    setDoc, 
    collection, 
    query, 
    where, 
    addDoc, 
    getDocs, 
    setLogLevel,
    Timestamp 
} from 'firebase/firestore';
import { Upload, Camera, QrCode, RotateCcw, PaintBucket, DollarSign, Barcode, ClipboardCheck, Search } from 'lucide-react';

// è¨­å®š Firebase æ—¥èªŒç´šåˆ¥ (é™¤éŒ¯ç”¨)
// setLogLevel('debug'); 

// -----------------------------------------------------------------------------
// 1. æ ¸å¿ƒè¨­å®šèˆ‡å·¥å…·å‡½æ•¸ (Core Setup & Utilities)
// -----------------------------------------------------------------------------

// ç²å– Canvas ç’°å¢ƒæ³¨å…¥çš„è®Šæ•¸
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

/**
 * DJB2 é›œæ¹Šç®—æ³•ï¼šå°‡æ¢ç¢¼å­—ä¸²è½‰æ›ç‚ºæ•¸å€¼ ID (numericalID)ã€‚
 * @param {string} str - åŸå§‹æ¢ç¢¼å­—ä¸²
 * @returns {number} - 32ä½å…ƒç„¡ç¬¦è™Ÿæ•´æ•¸
 */
function djb2Hash(str) {
    let hash = 5381;
    for (let i = 0; i < str.length; i++) {
        // hash * 33 + charCode
        hash = ((hash << 5) + hash) + str.charCodeAt(i);
    }
    // è½‰æ›ç‚ºç„¡ç¬¦è™Ÿ 32 ä½æ•´æ•¸
    return hash >>> 0;
}

// -----------------------------------------------------------------------------
// 2. ä¸»é¡Œé…ç½® (Theming Configuration) - ä¾æ“š SPEC 3.4
// -----------------------------------------------------------------------------

// å®šç¾©æ‰€æœ‰å¯é¸ä¸»é¡ŒåŠå…¶ Tailwind é¡è‰²é¡åˆ¥
const THEMES = {
    'Default (Indigo)': { 
        primary: 'bg-indigo-600', 
        light: 'bg-indigo-100', 
        hover: 'hover:bg-indigo-700', 
        border: 'border-indigo-600',
        text: 'text-indigo-600',
        color: 'indigo'
    },
    'æµ·æ´‹è— (Ocean Blue)': { 
        primary: 'bg-blue-600', 
        light: 'bg-blue-100', 
        hover: 'hover:bg-blue-700', 
        border: 'border-blue-600',
        text: 'text-blue-600',
        color: 'blue'
    },
    'æ£®æ—ç¶  (Forest Green)': { 
        primary: 'bg-green-600', 
        light: 'bg-green-100', 
        hover: 'hover:bg-green-700', 
        border: 'border-green-600',
        text: 'text-green-600',
        color: 'green'
    },
    'å¤•é™½ç´… (Sunset Red)': { 
        primary: 'bg-red-600', 
        light: 'bg-red-100', 
        hover: 'hover:bg-red-700', 
        border: 'border-red-600',
        text: 'text-red-600',
        color: 'red'
    },
    'æ´»åŠ›æ©™ (Vibrant Orange)': { 
        primary: 'bg-orange-600', 
        light: 'bg-orange-100', 
        hover: 'hover:bg-orange-700', 
        border: 'border-orange-600',
        text: 'text-orange-600',
        color: 'orange'
    },
    'è–°è¡£è‰ç´« (Lavender)': { 
        primary: 'bg-purple-600', 
        light: 'bg-purple-100', 
        hover: 'hover:bg-purple-700', 
        border: 'border-purple-600',
        text: 'text-purple-600',
        color: 'purple'
    },
};

const DEFAULT_THEME_KEY = 'Default (Indigo)';

// -----------------------------------------------------------------------------
// 3. è‡ªå®šç¾© Hook - Firebase åˆå§‹åŒ–èˆ‡èªè­‰ (useFirebase)
// -----------------------------------------------------------------------------

/**
 * è™•ç† Firebase çš„åˆå§‹åŒ–ã€èªè­‰å’Œç‹€æ…‹ç®¡ç†ã€‚
 * @returns {object} åŒ…å« db, auth, userId, isAuthReady, currentTheme, saveUserTheme ç­‰ç‹€æ…‹å’Œç‰©ä»¶ã€‚
 */
function useFirebase() {
    const [db, setDb] = useState(null);
    const [auth, setAuth] = useState(null);
    const [userId, setUserId] = useState(null);
    const [isAuthReady, setIsAuthReady] = useState(false);
    const [currentTheme, setCurrentTheme] = useState(THEMES[DEFAULT_THEME_KEY]);

    // å–å¾—/è¨­å®šç”¨æˆ¶ä¸»é¡Œçš„å‡½æ•¸
    const getThemeRef = useCallback((dbInstance, uid) => {
        if (!dbInstance || !uid) return null;
        // éµå¾ª SPEC 4.0: artifacts/{appId}/users/{userId}/preferences/settings
        return doc(dbInstance, 'artifacts', appId, 'users', uid, 'preferences', 'settings');
    }, []);

    // è¼‰å…¥ç”¨æˆ¶ä¸»é¡Œ
    const loadUserTheme = useCallback(async (dbInstance, uid) => {
        const themeRef = getThemeRef(dbInstance, uid);
        if (!themeRef) return;

        try {
            const docSnap = await getDoc(themeRef);
            if (docSnap.exists()) {
                const savedThemeKey = docSnap.data().theme;
                const themeData = THEMES[savedThemeKey] || THEMES[DEFAULT_THEME_KEY];
                setCurrentTheme(themeData);
            } else {
                setCurrentTheme(THEMES[DEFAULT_THEME_KEY]);
            }
        } catch (error) {
            console.error("ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…ä¸»é¡Œ:", error);
            setCurrentTheme(THEMES[DEFAULT_THEME_KEY]);
        }
    }, [getThemeRef]);

    // å„²å­˜ç”¨æˆ¶ä¸»é¡Œ
    const saveUserTheme = useCallback(async (themeKey) => {
        if (!db || !userId) return;
        const themeRef = getThemeRef(db, userId);

        try {
            const dataToSave = { theme: themeKey };
            // ä½¿ç”¨ setDoc è¦†è“‹/å‰µå»ºæ–‡ä»¶
            await setDoc(themeRef, dataToSave, { merge: true }); 
            setCurrentTheme(THEMES[themeKey] || THEMES[DEFAULT_THEME_KEY]);
            console.log("ä¸»é¡Œè¨­å®šå·²å„²å­˜:", themeKey);
        } catch (error) {
            console.error("ç„¡æ³•å„²å­˜ä½¿ç”¨è€…ä¸»é¡Œ:", error);
        }
    }, [db, userId, getThemeRef]);

    useEffect(() => {
        try {
            const app = initializeApp(firebaseConfig);
            const firestoreDb = getFirestore(app);
            const firebaseAuth = getAuth(app);
            
            setDb(firestoreDb);
            setAuth(firebaseAuth);

            // è¨­ç½®èº«ä»½é©—è­‰ç›£è½å™¨
            const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
                if (user) {
                    setUserId(user.uid);
                    await loadUserTheme(firestoreDb, user.uid); // èªè­‰å¾Œç«‹å³è¼‰å…¥ä¸»é¡Œ
                } else {
                    // å¦‚æœæ²’æœ‰ç”¨æˆ¶ï¼Œå˜—è©¦ä½¿ç”¨è‡ªå®šç¾©ä»¤ç‰Œæˆ–åŒ¿åç™»å…¥
                    try {
                        if (initialAuthToken) {
                            const userCredential = await signInWithCustomToken(firebaseAuth, initialAuthToken);
                            setUserId(userCredential.user.uid);
                            await loadUserTheme(firestoreDb, userCredential.user.uid);
                        } else {
                            const userCredential = await signInAnonymously(firebaseAuth);
                            setUserId(userCredential.user.uid);
                            await loadUserTheme(firestoreDb, userCredential.user.uid);
                        }
                    } catch (error) {
                        console.error("Firebase èªè­‰å¤±æ•—:", error);
                        // å³ä½¿èªè­‰å¤±æ•—ï¼Œä¹Ÿè¦æ¨™è¨˜ç‚ºæº–å‚™å°±ç·’ï¼Œé¿å…æ‡‰ç”¨ç¨‹å¼é–æ­»
                        setUserId(crypto.randomUUID()); 
                        setCurrentTheme(THEMES[DEFAULT_THEME_KEY]);
                    }
                }
                setIsAuthReady(true);
            });

            return () => unsubscribe();
        } catch (error) {
            console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", error);
            setIsAuthReady(true);
        }
    }, [loadUserTheme]);

    return { db, auth, userId, isAuthReady, currentTheme, saveUserTheme };
}

// -----------------------------------------------------------------------------
// 4. ä¸»é¡Œé¸æ“‡å…ƒä»¶ (Theme Selector Component)
// -----------------------------------------------------------------------------

/**
 * é¡¯ç¤ºä¸»é¡Œé¸æ“‡é¢æ¿çš„ Modal å…ƒä»¶ã€‚
 */
function ThemeSelector({ theme, saveTheme, onClose }) {
    const handleThemeChange = (themeKey) => {
        saveTheme(themeKey);
    };

    const handleReset = () => {
        saveTheme(DEFAULT_THEME_KEY);
    };

    return (
        <div className="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all">
                <h3 className={`text-xl font-bold ${theme.text} mb-4 border-b pb-2`}>
                    <PaintBucket className="inline-block w-5 h-5 mr-2" />
                    ä»‹é¢é…è‰²é¸é …
                </h3>
                
                <div className="grid grid-cols-2 gap-4 mb-6">
                    {Object.keys(THEMES).map((themeKey) => {
                        const themeData = THEMES[themeKey];
                        const isSelected = theme.color === themeData.color;
                        return (
                            <button
                                key={themeKey}
                                onClick={() => handleThemeChange(themeKey)}
                                className={`
                                    p-3 rounded-lg text-white font-medium shadow-md transition-all 
                                    ${themeData.primary} ${themeData.hover} 
                                    ${isSelected ? 'ring-4 ring-offset-2 ring-opacity-70 ring-gray-400' : ''}
                                `}
                                style={{ transform: isSelected ? 'scale(1.05)' : 'scale(1)' }}
                            >
                                {themeKey}
                            </button>
                        );
                    })}
                </div>

                <div className="flex justify-between items-center pt-4 border-t">
                    <button
                        onClick={handleReset}
                        className="flex items-center text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors"
                    >
                        <RotateCcw className="w-4 h-4 mr-1" />
                        æ¸…é™¤é‚„åŸ (é è¨­)
                    </button>
                    <button
                        onClick={onClose}
                        className={`px-4 py-2 text-white font-semibold rounded-lg shadow-lg ${theme.primary} ${theme.hover} transition-all`}
                    >
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    );
}

// -----------------------------------------------------------------------------
// 5. ä¸»æ‡‰ç”¨ç¨‹å¼å…ƒä»¶ (App Component)
// -----------------------------------------------------------------------------

function App() {
    const { db, userId, isAuthReady, currentTheme, saveUserTheme } = useFirebase();
    
    // UI ç‹€æ…‹ç®¡ç†
    const [barcode, setBarcode] = useState('');
    const [productName, setProductName] = useState('');
    const [currentPrice, setCurrentPrice] = useState('');
    const [isThemeModalOpen, setIsThemeModalOpen] = useState(false);
    const [comparisonResult, setComparisonResult] = useState({
        isBest: false,
        bestPrice: null,
        bestStore: null,
        message: 'ç­‰å¾…æ¯”åƒ¹æ•¸æ“š...'
    });
    const [isLoading, setIsLoading] = useState(false); // é€šç”¨è¼‰å…¥ç‹€æ…‹
    const [lookupStatus, setLookupStatus] = useState('ready'); // 'ready', 'searching', 'found', 'new'

    // -----------------------------------------------------------------------------
    // ç”¢å“è­˜åˆ¥é‚è¼¯ (æ–°å¢ - é…åˆå–®ä¸€æ­¥é©Ÿéœ€æ±‚)
    // -----------------------------------------------------------------------------
    const lookupProduct = useCallback(async (barcodeData) => {
        if (!db || !barcodeData) {
            setProductName('');
            setLookupStatus('ready');
            return;
        }
        
        if (barcodeData.length < 5) return; // é¿å…éçŸ­çš„è¼¸å…¥è§¸ç™¼æŸ¥è©¢

        setLookupStatus('searching');
        const numericalID = djb2Hash(barcodeData);
        
        try {
            // éµå¾ª SPEC 4.1 è·¯å¾‘: artifacts/{appId}/public/data/products/{numericalID}
            const docRef = doc(db, `artifacts/${appId}/public/data/products`, numericalID.toString());
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                setProductName(docSnap.data().productName);
                setLookupStatus('found');
                console.log("ç”¢å“å·²è­˜åˆ¥:", docSnap.data().productName);
            } else {
                setProductName('');
                setLookupStatus('new');
                console.log("æ–°ç”¢å“ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åç¨±ã€‚");
            }
        } catch (error) {
            console.error("æŸ¥è©¢ç”¢å“å¤±æ•—:", error);
            setLookupStatus('ready');
        }
    }, [db]);

    useEffect(() => {
        // ç•¶æ¢ç¢¼è¼¸å…¥æ”¹è®Šä¸” Firebase æº–å‚™å°±ç·’æ™‚ï¼Œè§¸ç™¼ç”¢å“æŸ¥è©¢
        if (barcode.length > 0 && isAuthReady) {
            // è¨­ç½®ä¸€å€‹å°çš„å»¶é²ï¼Œé¿å…é€£çºŒè¼¸å…¥æ™‚éåº¦è§¸ç™¼ Firestore è®€å–
            const timer = setTimeout(() => {
                lookupProduct(barcode);
            }, 500); 
            return () => clearTimeout(timer); // æ¸…é™¤ä¸Šä¸€å€‹è¨ˆæ™‚å™¨
        }
    }, [barcode, isAuthReady, lookupProduct]);


    // æ¨¡æ“¬ OCR å‡½æ•¸ (Placeholder)
    const performOCRAnalysis = useCallback(async (base64Image) => {
        console.log("æ­£åœ¨æ¨¡æ“¬ OCR åˆ†æ...");
        // æ­¤è™•æ‡‰ç‚ºçœŸå¯¦çš„ Gemini API å‘¼å«é‚è¼¯ (å·²åœ¨ SPEC 3.2 å®šç¾©)
        await new Promise(r => setTimeout(r, 1500)); // æ¨¡æ“¬ API å»¶é²

        // æ¨¡æ“¬çµæ§‹åŒ–è¼¸å‡º
        return {
            storeName: 'æ¨¡æ“¬è¶…å•† (OCR)',
            price: (Math.random() * 50 + 100).toFixed(2), // éš¨æ©Ÿåƒ¹æ ¼
            discountDetails: 'è²·äºŒé€ä¸€å„ªæƒ  (OCR æ¨¡æ“¬)',
        };
    }, []);

    // å„²å­˜ä¸¦æ¯”åƒ¹å‡½æ•¸
    const saveAndComparePrice = useCallback(async () => {
        // åœ¨å„²å­˜å‰ï¼Œæª¢æŸ¥ç”¢å“ä¸»æª”æ˜¯å¦å­˜åœ¨ï¼Œè‹¥ä¸å­˜åœ¨å‰‡å…ˆå‰µå»º
        const numericalID = djb2Hash(barcode);
        const priceValue = parseFloat(currentPrice);

        if (!userId || !barcode || !productName || isNaN(priceValue)) {
            alert("è«‹ç¢ºä¿å·²è¼¸å…¥æ¢ç¢¼ã€ç”¢å“åç¨±å’Œæœ‰æ•ˆåƒ¹æ ¼ï¼");
            return;
        }

        setIsLoading(true);
        
        try {
            // 0. æª¢æŸ¥ä¸¦å‰µå»ºç”¢å“ä¸»æª” (å¦‚æœä¸å­˜åœ¨)
            const productDocRef = doc(db, `artifacts/${appId}/public/data/products`, numericalID.toString());
            const productDocSnap = await getDoc(productDocRef);

            if (!productDocSnap.exists()) {
                await setDoc(productDocRef, {
                    numericalID,
                    barcodeData: barcode,
                    productName,
                    createdAt: new Date().toISOString(),
                });
                console.log("å·²å‰µå»ºæ–°çš„ç”¢å“ä¸»æª”ã€‚");
            }
            
            // 1. å„²å­˜æ–°çš„åƒ¹æ ¼ç´€éŒ„ (SPEC 3.3)
            const priceRecord = {
                numericalID,
                productName,
                storeName: comparisonResult.bestStore || "æ‰‹å‹•è¼¸å…¥",
                price: priceValue,
                discountDetails: "ç„¡", // æš«æ™‚ç‚ºç„¡ï¼Œç­‰å¾…æœªä¾† OCR å®Œå–„
                timestamp: new Date().toISOString(),
                recordedBy: userId,
            };
            
            // éµå¾ª SPEC 4.2 è·¯å¾‘
            const recordsRef = collection(db, `artifacts/${appId}/public/data/price_records`);
            await addDoc(recordsRef, priceRecord);
            
            // 2. åŸ·è¡Œæ¯”åƒ¹é‚è¼¯ (SPEC 3.3) - æŸ¥è©¢æ‰€æœ‰æ­·å²ç´€éŒ„
            const q = query(recordsRef, where("numericalID", "==", numericalID));
            const snapshot = await getDocs(q);
            const records = snapshot.docs.map(d => d.data());

            if (records.length <= 1) { // ç”±æ–¼å‰›å„²å­˜äº†ä¸€ç­†ï¼Œæ‰€ä»¥æ˜¯ <= 1
                setComparisonResult({ isBest: true, message: 'é€™æ˜¯ç¬¬ä¸€ç­†ç´€éŒ„ï¼' });
            } else {
                // æ‰¾å‡ºæ‰€æœ‰ç´€éŒ„ä¸­çš„æœ€ä½åƒ¹
                const bestDeal = records.reduce((best, cur) => cur.price < best.price ? cur : best);
                
                // æª¢æŸ¥ç•¶å‰åƒ¹æ ¼æ˜¯å¦ç‚ºæœ€ä½åƒ¹
                const isCurrentBest = priceRecord.price <= bestDeal.price;
                setComparisonResult({
                    isBest: isCurrentBest,
                    bestPrice: bestDeal.price,
                    bestStore: bestDeal.storeName,
                    message: isCurrentBest 
                        ? 'æ­å–œï¼é€™æ˜¯ç›®å‰ç´€éŒ„ä¸­çš„æœ€ä½åƒ¹ï¼' 
                        : `éæœ€ä½åƒ¹ã€‚æ­·å²æœ€ä½åƒ¹ç‚º $${bestDeal.price} (å•†åº—: ${bestDeal.storeName})`
                });
            }

        } catch (error) {
            console.error("å„²å­˜æˆ–æ¯”åƒ¹å¤±æ•—:", error);
            alert("æ•¸æ“šæ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ¬Šé™ã€‚");
        } finally {
            setIsLoading(false);
        }
    }, [db, userId, barcode, productName, currentPrice, comparisonResult.bestStore]);

    // ä¸»é¡Œè®Šæ•¸ï¼Œç”¨æ–¼å‹•æ…‹ Tailwind é¡åˆ¥
    const themePrimary = currentTheme.primary;
    const themeText = currentTheme.text;
    const themeLight = currentTheme.light;
    const themeBorder = currentTheme.border;

    // æ ¹æ“šæŸ¥è©¢ç‹€æ…‹é¡¯ç¤ºç”¢å“åç¨±æç¤º
    const productNamePlaceholder = useMemo(() => {
        switch(lookupStatus) {
            case 'searching':
                return 'æ­£åœ¨æŸ¥è©¢ç”¢å“è³‡æ–™...';
            case 'found':
                return 'ç”¢å“åç¨±å·²è‡ªå‹•è¼‰å…¥';
            case 'new':
                return 'ç”¢å“ä¸å­˜åœ¨ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åç¨±';
            default:
                return 'è«‹å…ˆè¼¸å…¥æ¢ç¢¼æˆ–æƒææ¢ç¢¼';
        }
    }, [lookupStatus]);


    if (!isAuthReady) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <p className="text-xl text-gray-700">æ­£åœ¨é€£æ¥æ¯”åƒ¹ç³»çµ±...</p>
            </div>
        );
    }

    return (
        // æ‡‰ç”¨ç¨‹å¼ä¸»å®¹å™¨ï¼Œä½¿ç”¨å‹•æ…‹ä¸»é¡Œè‰²
        <div className={`min-h-screen p-4 sm:p-8 ${themeLight}`}>
            <div className="max-w-xl mx-auto">
                <header className="flex justify-between items-center mb-6 border-b pb-4">
                    <h1 className={`text-3xl font-extrabold ${themeText} flex items-center`}>
                        <Barcode className="w-8 h-8 mr-2" />
                        æ¢ç¢¼æ¯”åƒ¹ç¥å™¨
                    </h1>
                    <div className="flex items-center space-x-3">
                        {/* ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• */}
                        <button 
                            onClick={() => setIsThemeModalOpen(true)}
                            className={`p-2 rounded-full text-white shadow-md transition-all ${themePrimary} hover:opacity-80`}
                            title="è¨­å®šä»‹é¢ä¸»é¡Œ"
                        >
                            <PaintBucket className="w-5 h-5" />
                        </button>
                        <p className="text-sm text-gray-500 hidden sm:block">ç”¨æˆ¶ ID: {userId}</p>
                    </div>
                </header>

                {/* æ•´åˆæµç¨‹å¡ç‰‡ï¼šç”¢å“è­˜åˆ¥ã€åƒ¹æ ¼ç´€éŒ„èˆ‡ OCR */}
                <div className={`p-6 rounded-xl shadow-2xl bg-white border-t-4 ${themeBorder}`}>
                    <h2 className={`text-xl font-semibold ${themeText} mb-6 flex items-center`}>
                        <Search className="w-5 h-5 mr-2" /> 
                        ç”¢å“è­˜åˆ¥ã€åƒ¹æ ¼ç´€éŒ„èˆ‡æ¯”åƒ¹
                    </h2>
                    
                    {/* æ¢ç¢¼è¼¸å…¥å€ */}
                    <div className="mb-6">
                        <label className="block text-gray-700 font-medium mb-1">æ¢ç¢¼æ•¸æ“š (Barcode Data)</label>
                        <input
                            type="text"
                            value={barcode}
                            onChange={(e) => setBarcode(e.target.value)}
                            placeholder="æƒææˆ–æ‰‹å‹•è¼¸å…¥æ¢ç¢¼ (EAN/UPC)"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                        />
                    </div>
                    
                    {/* ç”¢å“åç¨±å€ - é…åˆè‡ªå‹•æŸ¥è©¢ */}
                    <div className="mb-6">
                        <label className="block text-gray-700 font-medium mb-1">ç”¢å“åç¨± (Product Name)</label>
                        <input
                            type="text"
                            value={productName}
                            onChange={(e) => setProductName(e.target.value)}
                            placeholder={productNamePlaceholder}
                            className={`w-full p-3 border border-gray-300 rounded-lg transition 
                                ${lookupStatus === 'found' ? 'bg-green-50' : lookupStatus === 'new' ? 'bg-yellow-50' : ''}`}
                            readOnly={lookupStatus === 'found'} // æ‰¾åˆ°å¾Œé–å®š
                        />
                        <p className="text-sm text-gray-500 mt-1">
                            æ•¸å€¼ ID (Hash): {barcode ? djb2Hash(barcode) : 'å°šæœªè¨ˆç®—'}
                        </p>
                    </div>

                    {/* åƒ¹æ ¼èˆ‡å•†åº—è¼¸å…¥/OCR å€ */}
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">æ¨™åƒ¹ ($)</label>
                            <input
                                type="number"
                                value={currentPrice}
                                onChange={(e) => setCurrentPrice(e.target.value)}
                                placeholder="åƒ¹æ ¼ (æ‰‹å‹•è¼¸å…¥)"
                                className="w-full p-3 border border-gray-300 rounded-lg"
                            />
                        </div>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">å•†åº—åç¨±</label>
                            <input
                                type="text"
                                value={comparisonResult.bestStore || ''} // é€™è£¡ç”¨ä¾†é¡¯ç¤º OCR æˆ–æ‰‹å‹•è¼¸å…¥çš„å•†åº—
                                onChange={(e) => setComparisonResult(prev => ({ ...prev, bestStore: e.target.value }))}
                                placeholder="å•†åº—åç¨±"
                                className="w-full p-3 border border-gray-300 rounded-lg"
                            />
                        </div>
                    </div>

                    {/* å‹•ä½œæŒ‰éˆ•ç¾¤çµ„ */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {/* æ¢ç¢¼æƒæ */}
                        <button 
                            className={`p-3 rounded-lg text-white font-semibold shadow-lg transition-all bg-gray-500 hover:bg-gray-600`}
                            onClick={() => alert('QuaggaJS æ¢ç¢¼æƒæåŠŸèƒ½ Placeholder')}
                        >
                            <Camera className="inline-block w-5 h-5 mr-2" /> å•Ÿå‹•æ¢ç¢¼æƒæ
                        </button>
                        
                        {/* åƒ¹æ ¼ OCR */}
                        <button 
                            className={`p-3 rounded-lg text-white font-semibold shadow-lg transition-all ${themePrimary} hover:opacity-80`}
                            onClick={() => document.getElementById('ocr-upload').click()}
                            disabled={isLoading}
                        >
                            <Upload className="inline-block w-5 h-5 mr-2" /> 
                            {isLoading ? 'OCR åˆ†æä¸­...' : 'æ‹ç…§/OCR åƒ¹æ ¼æ¨™ç±¤'}
                        </button>
                        <input
                            type="file"
                            id="ocr-upload"
                            accept="image/*"
                            onChange={async (e) => {
                                const file = e.target.files[0];
                                if (!file) return;

                                setIsLoading(true);
                                try {
                                    const reader = new FileReader();
                                    reader.onloadend = async () => {
                                        const base64Image = reader.result.split(',')[1];
                                        const result = await performOCRAnalysis(base64Image);
                                        
                                        // è‡ªå‹•å¡«å…¥ OCR çµæœ
                                        setCurrentPrice(result.price);
                                        setComparisonResult(prev => ({ ...prev, bestStore: result.storeName })); 
                                        
                                        alert(`OCR æˆåŠŸï¼åƒ¹æ ¼: $${result.price}, å•†åº—: ${result.storeName}`);
                                    };
                                    reader.readAsDataURL(file);
                                } catch (error) {
                                    alert(`OCR å¤±æ•—: ${error.message}`);
                                } finally {
                                    setIsLoading(false);
                                }
                            }}
                            className="hidden"
                        />
                    </div>
                    
                    {/* å„²å­˜ç´€éŒ„ä¸¦æ¯”åƒ¹ */}
                    <button 
                        className={`w-full mt-4 p-3 rounded-lg text-white font-semibold shadow-lg transition-all bg-emerald-500 hover:bg-emerald-600`}
                        onClick={saveAndComparePrice}
                        disabled={isLoading}
                    >
                        <ClipboardCheck className="inline-block w-5 h-5 mr-2" /> 
                        {isLoading ? 'å„²å­˜ä¸¦æ¯”åƒ¹ä¸­...' : 'å„²å­˜ç´€éŒ„ä¸¦æ¯”åƒ¹'}
                    </button>
                </div>

                {/* æ¯”åƒ¹çµæœé¡¯ç¤ºå€ */}
                <div className="mt-8">
                    <h2 className={`text-xl font-semibold ${themeText} mb-4 flex items-center`}>
                        <DollarSign className="w-5 h-5 mr-2" />
                        æ¯”åƒ¹çµæœ
                    </h2>
                    <div className={`p-6 rounded-xl shadow-xl border-2 ${comparisonResult.isBest ? 'border-green-500 bg-green-50' : 'border-yellow-500 bg-yellow-50'}`}>
                        <p className={`text-lg font-bold ${comparisonResult.isBest ? 'text-green-700' : 'text-yellow-700'}`}>
                            {comparisonResult.message}
                        </p>
                        {comparisonResult.bestPrice && (
                            <p className="text-sm text-gray-600 mt-2">
                                æ­·å²æœ€ä½åƒ¹: ${comparisonResult.bestPrice}
                            </p>
                        )}
                    </div>
                </div>
            </div>

            {/* ä¸»é¡Œé¸æ“‡ Modal - ä¾æ“š SPEC 3.4 */}
            {isThemeModalOpen && (
                <ThemeSelector 
                    theme={currentTheme} 
                    saveTheme={saveUserTheme} 
                    onClose={() => setIsThemeModalOpen(false)} 
                />
            )}
        </div>
    );
}

// æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼
export default App;
</file>

<file path="åƒè€ƒç¨‹å¼3.txt">
import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
 å·²ç§»é™¤æ‰€æœ‰ Firebase ç›¸é—œçš„ import

import { Upload, Camera, QrCode, RotateCcw, PaintBucket, DollarSign, Barcode, ClipboardCheck, Search, X } from 'lucide-react';

 -----------------------------------------------------------------------------
 1. æ ¸å¿ƒè¨­å®šèˆ‡å·¥å…·å‡½æ•¸ (Core Setup & Utilities)
 -----------------------------------------------------------------------------

 MVP éšæ®µä½¿ç”¨ Local Storage æ¨¡æ“¬ App ID
const MVP_APP_ID = 'mvp-local-price-app'; 


  DJB2 é›œæ¹Šç®—æ³•ï¼šå°‡æ¢ç¢¼å­—ä¸²è½‰æ›ç‚ºæ•¸å€¼ ID (numericalID)ã€‚
  @param {string} str - åŸå§‹æ¢ç¢¼å­—ä¸²
  @returns {number} - 32ä½å…ƒç„¡ç¬¦è™Ÿæ•´æ•¸
 
function djb2Hash(str) {
    let hash = 5381;
    for (let i = 0; i  str.length; i++) {
         hash  33 + charCode
        hash = ((hash  5) + hash) + str.charCodeAt(i);
    }
     è½‰æ›ç‚ºç„¡ç¬¦è™Ÿ 32 ä½æ•´æ•¸
    return hash  0;
}

 -----------------------------------------------------------------------------
 2. ä¸»é¡Œé…ç½® (Theming Configuration)
 -----------------------------------------------------------------------------

 å®šç¾©æ‰€æœ‰å¯é¸ä¸»é¡ŒåŠå…¶ Tailwind é¡è‰²é¡åˆ¥
const THEMES = {
    'Default (Indigo)' { 
        primary 'bg-indigo-600', 
        light 'bg-indigo-100', 
        hover 'hoverbg-indigo-700', 
        border 'border-indigo-600',
        text 'text-indigo-600',
        color 'indigo'
    },
    'æµ·æ´‹è— (Ocean Blue)' { 
        primary 'bg-blue-600', 
        light 'bg-blue-100', 
        hover 'hoverbg-blue-700', 
        border 'border-blue-600',
        text 'text-blue-600',
        color 'blue'
    },
    'æ£®æ—ç¶  (Forest Green)' { 
        primary 'bg-green-600', 
        light 'bg-green-100', 
        hover 'hoverbg-green-700', 
        border 'border-green-600',
        text 'text-green-600',
        color 'green'
    },
    'å¤•é™½ç´… (Sunset Red)' { 
        primary 'bg-red-600', 
        light 'bg-red-100', 
        hover 'hoverbg-red-700', 
        border 'border-red-600',
        text 'text-red-600',
        color 'red'
    },
    'æ´»åŠ›æ©™ (Vibrant Orange)' { 
        primary 'bg-orange-600', 
        light 'bg-orange-100', 
        hover 'hoverbg-orange-700', 
        border 'border-orange-600',
        text 'text-orange-600',
        color 'orange'
    },
    'è–°è¡£è‰ç´« (Lavender)' { 
        primary 'bg-purple-600', 
        light 'bg-purple-100', 
        hover 'hoverbg-purple-700', 
        border 'border-purple-600',
        text 'text-purple-600',
        color 'purple'
    },
};

const DEFAULT_THEME_KEY = 'Default (Indigo)';

 -----------------------------------------------------------------------------
 3. è‡ªå®šç¾© Hook - æœ¬åœ°å„²å­˜è¨­å®š (useLocalMVPSetup)
 -----------------------------------------------------------------------------


  è™•ç† MVP éšæ®µçš„æœ¬åœ°å„²å­˜ã€ä¸»é¡Œå’Œä½¿ç”¨è€… ID ç®¡ç†ã€‚
  @returns {object} åŒ…å« userId, isAuthReady, currentTheme, saveUserTheme ç­‰ç‹€æ…‹å’Œç‰©ä»¶ã€‚
 
function useLocalMVPSetup() {
     ç²å–æˆ–ç”ŸæˆæŒä¹…åŒ–çš„ç”¨æˆ¶ ID
    const [userId] = useState(() = {
        let savedId = localStorage.getItem('mvp_user_id');
        if (!savedId) {
            savedId = crypto.randomUUID();
            localStorage.setItem('mvp_user_id', savedId);
        }
        return savedId;
    });

     è¼‰å…¥æœ¬åœ°å„²å­˜çš„ä¸»é¡Œ
    const [currentTheme, setCurrentTheme] = useState(() = {
        const savedKey = localStorage.getItem('appTheme')  DEFAULT_THEME_KEY;
        return THEMES[savedKey]  THEMES[DEFAULT_THEME_KEY];
    });

     å„²å­˜ç”¨æˆ¶ä¸»é¡Œåˆ°æœ¬åœ°å„²å­˜
    const saveUserTheme = useCallback((themeKey) = {
        localStorage.setItem('appTheme', themeKey);
        setCurrentTheme(THEMES[themeKey]  THEMES[DEFAULT_THEME_KEY]);
    }, []);

     åœ¨æœ¬åœ° MVP æ¨¡å¼ä¸‹ï¼Œæ‡‰ç”¨ç¨‹å¼å§‹çµ‚æ˜¯æº–å‚™å°±ç·’çš„
    const isAuthReady = true; 
    
    return { 
        userId, 
        isAuthReady, 
        currentTheme, 
        saveUserTheme,
        appId MVP_APP_ID  å‚³å›ç¡¬ç·¨ç¢¼çš„ App ID
    };
}

 -----------------------------------------------------------------------------
 4. ä¸»é¡Œé¸æ“‡å…ƒä»¶ (Theme Selector Component)
 -----------------------------------------------------------------------------


  é¡¯ç¤ºä¸»é¡Œé¸æ“‡é¢æ¿çš„ Modal å…ƒä»¶ã€‚
 
function ThemeSelector({ theme, saveTheme, onClose }) {
    const handleThemeChange = (themeKey) = {
        saveTheme(themeKey);
    };

    const handleReset = () = {
        saveTheme(DEFAULT_THEME_KEY);
    };

    return (
        div className=fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4
            div className=bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all
                h3 className={`text-xl font-bold ${theme.text} mb-4 border-b pb-2`}
                    PaintBucket className=inline-block w-5 h-5 mr-2 
                    ä»‹é¢é…è‰²é¸é …
                h3
                
                div className=grid grid-cols-2 gap-4 mb-6
                    {Object.keys(THEMES).map((themeKey) = {
                        const themeData = THEMES[themeKey];
                        const isSelected = theme.color === themeData.color;
                        return (
                            button
                                key={themeKey}
                                onClick={() = handleThemeChange(themeKey)}
                                className={`
                                    p-3 rounded-lg text-white font-medium shadow-md transition-all 
                                    ${themeData.primary} ${themeData.hover} 
                                    ${isSelected  'ring-4 ring-offset-2 ring-opacity-70 ring-gray-400'  ''}
                                `}
                                style={{ transform isSelected  'scale(1.05)'  'scale(1)' }}
                            
                                {themeKey}
                            button
                        );
                    })}
                div

                div className=flex justify-between items-center pt-4 border-t
                    button
                        onClick={handleReset}
                        className=flex items-center text-sm font-medium text-gray-600 hovertext-gray-900 transition-colors
                    
                        RotateCcw className=w-4 h-4 mr-1 
                        æ¸…é™¤é‚„åŸ (é è¨­)
                    button
                    button
                        onClick={onClose}
                        className={`px-4 py-2 text-white font-semibold rounded-lg shadow-lg ${theme.primary} ${theme.hover} transition-all`}
                    
                        é—œé–‰
                    button
                div
            div
        div
    );
}

 -----------------------------------------------------------------------------
 5. æ¢ç¢¼æƒæå…ƒä»¶ (Barcode Scanner Modal Component)
 -----------------------------------------------------------------------------


  æ¢ç¢¼æƒæ Modal å…ƒä»¶ (QuaggaJS æ¨¡æ“¬)
  è² è²¬è™•ç†ç›¸æ©Ÿå­˜å–ã€è¦–è¨Šé¡¯ç¤ºï¼Œä¸¦å°‡æƒæçµæœå‚³å›çˆ¶å…ƒä»¶ã€‚
 
function BarcodeScannerModal({ theme, onScanSuccess, onClose }) {
    const videoRef = useRef(null);
    const streamRef = useRef(null);
    const [isScanning, setIsScanning] = useState(false);
    const [scanError, setScanError] = useState('');

     é–‹å§‹æƒæ (åˆå§‹åŒ–æ”å½±æ©Ÿ)
    const startScanner = useCallback(async () = {
        setScanError('');
        try {
             å˜—è©¦å–å¾—å¾Œç½®æ”å½±æ©Ÿ ('environment')
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video { 
                    facingMode environment, 
                    width { ideal 640 },
                    height { ideal 480 }
                } 
            });
            streamRef.current = stream;
            
             å°‡è¦–è¨Šæµè¨­å®šçµ¦ video å…ƒç´ 
            if (videoRef.current) {
                videoRef.current.srcObject = stream;
                await videoRef.current.play();
                setIsScanning(true);
            }
            
        } catch (err) {
            console.error(ç„¡æ³•å­˜å–æ”å½±æ©Ÿ, err);
            setScanError(`ç„¡æ³•å­˜å–æ”å½±æ©Ÿæˆ–æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚ (${err.name} - ${err.message})`);
            setIsScanning(false);
        }
    }, []);

     åœæ­¢æƒæ (é‡‹æ”¾æ”å½±æ©Ÿè³‡æº)
    const stopScanner = useCallback(() = {
        if (streamRef.current) {
            streamRef.current.getTracks().forEach(track = track.stop());
            streamRef.current = null;
        }
        setIsScanning(false);
    }, []);

     è™•ç† Modal é–‹å•Ÿé—œé–‰æ™‚çš„ç”Ÿå‘½é€±æœŸ
    useEffect(() = {
        startScanner();
         æ¸…ç†å‡½æ•¸ï¼šç•¶å…ƒä»¶å¸è¼‰æ™‚åœæ­¢æ”å½±æ©Ÿ
        return () = {
            stopScanner();
        };
    }, [startScanner, stopScanner]);

     æ¨¡æ“¬å¯¦éš›çš„æ¢ç¢¼æª¢æ¸¬æˆåŠŸ
    const handleSimulatedScan = () = {
        stopScanner();
         æ¨¡æ“¬ä¸€å€‹å¸¸è¦‹çš„ EAN-13 æ¢ç¢¼ï¼šçµ±ä¸€ç¢¼ 471 é–‹é ­
        const mockBarcode = '4710123456789'; 
        onScanSuccess(mockBarcode);
        onClose();
    };

    const themePrimary = theme.primary;
    const themeHover = theme.hover;

    return (
        div className=fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex flex-col items-center justify-center p-4
            div className=bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all flex flex-col items-center
                header className=flex justify-between items-center w-full mb-4 border-b pb-2
                    h3 className={`text-xl font-bold ${theme.text} flex items-center`}
                        QrCode className=inline-block w-5 h-5 mr-2 
                        æ¢ç¢¼æƒæå™¨ (æ¸¬è©¦ç‰ˆ)
                    h3
                    button onClick={() = { stopScanner(); onClose(); }} className=p-1 rounded-full text-gray-500 hovertext-gray-900
                        X className=w-6 h-6 
                    button
                header

                {scanError  (
                    div className=text-red-600 bg-red-100 p-4 rounded-lg w-full mb-4 text-center
                        {scanError}
                    div
                )  (
                    div className=relative w-full aspect-video bg-black rounded-lg overflow-hidden mb-4 border-4 border-dashed border-green-400
                        { æ”åƒé ­è¦–è¨Šè¼¸å‡º }
                        video 
                            ref={videoRef} 
                            className=w-full h-full object-cover 
                            style={{ transform 'scaleX(-1)' }}  é¡åƒç¿»è½‰ï¼Œé€šå¸¸ç”¨æ–¼å‰ç½®é¡é ­ï¼Œä½†å¾Œç½®ä¹Ÿå¯ç”¨æ–¼æŸäº›æƒ…æ³ä¸‹çš„é è¦½
                            playsInline 
                            muted
                        video
                        { æƒæå°ç„¦æ¡† - ä½¿ç”¨ Tailwind æ¨¡æ“¬ }
                        div className=absolute inset-0 flex items-center justify-center pointer-events-none
                            div className=w-45 h-1 bg-green-500 opacity-75 animate-pulsediv
                            div className=absolute w-45 h-45 border-4 border-green-500 border-opacity-75 rounded-lgdiv
                        div
                    div
                )}
                
                { æ¨¡æ“¬æƒææˆåŠŸæŒ‰éˆ• }
                {isScanning && !scanError && (
                    button
                        onClick={handleSimulatedScan}
                        className={`w-full p-3 mb-3 rounded-lg text-white font-semibold shadow-lg transition-all ${themePrimary} ${themeHover}`}
                    
                        æ¨¡æ“¬æƒææˆåŠŸä¸¦ä½¿ç”¨æ¢ç¢¼ (EAN 4710123456789)
                    button
                )}

                button
                    onClick={() = { stopScanner(); onClose(); }}
                    className=w-full p-3 bg-gray-500 hoverbg-gray-600 text-white font-semibold rounded-lg shadow-lg transition-all
                
                    é—œé–‰æƒæå™¨
                button
            div
        div
    );
}


 -----------------------------------------------------------------------------
 6. ä¸»æ‡‰ç”¨ç¨‹å¼å…ƒä»¶ (App Component)
 -----------------------------------------------------------------------------

function App() {
     ä½¿ç”¨ Local Storage æ›¿æ› Firebase
    const { userId, isAuthReady, currentTheme, saveUserTheme } = useLocalMVPSetup();
    
     UI ç‹€æ…‹ç®¡ç†
    const [barcode, setBarcode] = useState('');
    const [productName, setProductName] = useState('');
    const [currentPrice, setCurrentPrice] = useState('');
    const [discountDetails, setDiscountDetails] = useState(''); 
    const [isThemeModalOpen, setIsThemeModalOpen] = useState(false);
    const [isScannerModalOpen, setIsScannerModalOpen] = useState(false); 
    const [comparisonResult, setComparisonResult] = useState({
        isBest false,
        bestPrice null,
        bestStore null,
        message 'ç­‰å¾…æ¯”åƒ¹æ•¸æ“š...'
    });
    const [isLoading, setIsLoading] = useState(false); 
    const [lookupStatus, setLookupStatus] = useState('ready'); 
    const [statusMessage, setStatusMessage] = useState(''); 

     -----------------------------------------------------------------------------
     ç”¢å“è­˜åˆ¥é‚è¼¯ (Local Storage ç‰ˆæœ¬)
     -----------------------------------------------------------------------------
    const lookupProduct = useCallback(async (barcodeData) = {
        if (!barcodeData  barcodeData.length  5) {
            setProductName('');
            setLookupStatus('ready');
            return;
        }

        setLookupStatus('searching');
        const numericalID = djb2Hash(barcodeData);
        
        try {
             æ¨¡æ“¬å»¶é²
            await new Promise(r = setTimeout(r, 200)); 
            
             å¾ Local Storage è®€å–ç”¢å“ä¸»æª”
            const productsJson = localStorage.getItem('MVP_PRODUCTS')  '{}';
            const products = JSON.parse(productsJson);

            if (products[numericalID]) {
                setProductName(products[numericalID].productName);
                setLookupStatus('found');
                console.log(ç”¢å“å·²è­˜åˆ¥ (Local Storage), products[numericalID].productName);
            } else {
                setProductName('');
                setLookupStatus('new');
                console.log(æ–°ç”¢å“ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åç¨±ã€‚);
            }
        } catch (error) {
            console.error(æŸ¥è©¢ç”¢å“å¤±æ•— (Local Storage), error);
            setLookupStatus('ready');
        }
    }, []);  ç§»é™¤ db ä¾è³´é …

    useEffect(() = {
         ç•¶æ¢ç¢¼è¼¸å…¥æ”¹è®Šä¸”æ‡‰ç”¨ç¨‹å¼æº–å‚™å°±ç·’æ™‚ï¼Œè§¸ç™¼ç”¢å“æŸ¥è©¢
        if (barcode.length  0 && isAuthReady) {
            const timer = setTimeout(() = {
                lookupProduct(barcode);
            }, 500); 
            return () = clearTimeout(timer); 
        }
    }, [barcode, isAuthReady, lookupProduct]);

     è™•ç†ç‹€æ…‹è¨Šæ¯è‡ªå‹•æ¶ˆå¤±
    useEffect(() = {
        if (statusMessage) {
            const timer = setTimeout(() = {
                setStatusMessage('');
            }, 3000);
            return () = clearTimeout(timer);
        }
    }, [statusMessage]);

     æ¨¡æ“¬ OCR å‡½æ•¸ (Placeholder)
    const performOCRAnalysis = useCallback(async (base64Image) = {
        console.log(æ­£åœ¨æ¨¡æ“¬ OCR åˆ†æ...);
        await new Promise(r = setTimeout(r, 1500));  æ¨¡æ“¬ API å»¶é²

         æ¨¡æ“¬çµæ§‹åŒ–è¼¸å‡º - åŒ…å«å„ªæƒ ç´°ç¯€
        return {
            storeName 'æ¨¡æ“¬è¶…å•† (OCR)',
            price (Math.random()  50 + 100).toFixed(2),  éš¨æ©Ÿåƒ¹æ ¼
            discountDetails 'è²·äºŒé€ä¸€å„ªæƒ   å–®ä»¶ $120  æœ‰æ•ˆæœŸé™ 20260101', 
        };
    }, []);

     å„²å­˜ä¸¦æ¯”åƒ¹å‡½æ•¸ (Local Storage ç‰ˆæœ¬)
    const saveAndComparePrice = useCallback(async () = {
        const numericalID = djb2Hash(barcode);
        const priceValue = parseFloat(currentPrice);

        if (!userId  !barcode  !productName  isNaN(priceValue)) {
            setStatusMessage(è«‹ç¢ºä¿å·²è¼¸å…¥æ¢ç¢¼ã€ç”¢å“åç¨±å’Œæœ‰æ•ˆåƒ¹æ ¼ï¼);
            return;
        }

        setIsLoading(true);
        
        try {
             å¾ Local Storage ç²å–æ•¸æ“š
            const productsJson = localStorage.getItem('MVP_PRODUCTS')  '{}';
            const allRecordsJson = localStorage.getItem('MVP_PRICE_RECORDS')  '[]';
            let products = JSON.parse(productsJson);
            let allRecords = JSON.parse(allRecordsJson);

             0. æª¢æŸ¥ä¸¦å‰µå»ºç”¢å“ä¸»æª” (å¦‚æœä¸å­˜åœ¨)
            if (!products[numericalID]) {
                products[numericalID] = {
                    numericalID,
                    barcodeData barcode,
                    productName,
                    createdAt new Date().toISOString(),
                };
                 å„²å­˜å› Local Storage
                localStorage.setItem('MVP_PRODUCTS', JSON.stringify(products));
                console.log(å·²å‰µå»ºæ–°çš„ç”¢å“ä¸»æª” (Local Storage)ã€‚);
            }
            
             1. å„²å­˜æ–°çš„åƒ¹æ ¼ç´€éŒ„
            const priceRecord = {
                numericalID,
                productName,
                storeName comparisonResult.bestStore  æ‰‹å‹•è¼¸å…¥,
                price priceValue,
                discountDetails discountDetails, 
                timestamp new Date().toISOString(),
                recordedBy userId,
            };
            
            allRecords.push(priceRecord);
             å„²å­˜å› Local Storage
            localStorage.setItem('MVP_PRICE_RECORDS', JSON.stringify(allRecords));
            
             2. åŸ·è¡Œæ¯”åƒ¹é‚è¼¯ - æŸ¥è©¢è©²ç”¢å“æ‰€æœ‰æ­·å²ç´€éŒ„
            const records = allRecords.filter(r = r.numericalID === numericalID);

            if (records.length = 1) { 
                setComparisonResult({ 
                    isBest true, 
                    bestPrice priceValue,
                    bestStore comparisonResult.bestStore  æ‰‹å‹•è¼¸å…¥,
                    message 'é€™æ˜¯ç¬¬ä¸€ç­†ç´€éŒ„ï¼' 
                });
            } else {
                 æ‰¾å‡ºæ‰€æœ‰ç´€éŒ„ä¸­çš„æœ€ä½æ¨™åƒ¹
                const bestDeal = records.reduce((best, cur) = cur.price  best.price  cur  best);
                
                const isCurrentBest = priceRecord.price = bestDeal.price;
                
                 æ¯”è¼ƒé‚è¼¯ï¼šæ¨™åƒ¹æœ€ä½å„ªå…ˆï¼›æ¨™åƒ¹ç›¸åŒå‰‡æœ‰æŠ˜æ‰£å„ªå…ˆ
                const isTrulyBest = isCurrentBest && (priceRecord.price  bestDeal.price  (priceRecord.price === bestDeal.price && priceRecord.discountDetails !== ''));
                
                setComparisonResult({
                    isBest isTrulyBest,
                    bestPrice bestDeal.price,
                    bestStore bestDeal.storeName,
                    message isTrulyBest 
                         'æ­å–œï¼é€™æ˜¯ç›®å‰ç´€éŒ„ä¸­çš„æœ€ä½æ¨™åƒ¹ (æˆ–å…·å‚™æŠ˜æ‰£)ï¼' 
                         `éæœ€ä½æ¨™åƒ¹ã€‚æ­·å²æœ€ä½æ¨™åƒ¹ç‚º $${bestDeal.price} (å•†åº— ${bestDeal.storeName})`
                });
            }

        } catch (error) {
            console.error(å„²å­˜æˆ–æ¯”åƒ¹å¤±æ•— (Local Storage), error);
            setStatusMessage(æ•¸æ“šæ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–æœ¬åœ°å„²å­˜ç©ºé–“ã€‚);
        } finally {
            setIsLoading(false);
        }
    }, [userId, barcode, productName, currentPrice, discountDetails, comparisonResult.bestStore]); 

     è™•ç†æ¢ç¢¼æƒææˆåŠŸ
    const handleScanSuccess = useCallback((scannedBarcode) = {
        setBarcode(scannedBarcode); 
        setStatusMessage(`æ¢ç¢¼æƒææˆåŠŸï¼å·²è‡ªå‹•å¡«å…¥æ¢ç¢¼ ${scannedBarcode}`);
    }, []);

     æ¢ç¢¼æƒæåŠŸèƒ½é»æ“Šè™•ç†ï¼šæ‰“é–‹ Modal
    const handleBarcodeScanClick = () = {
        setIsScannerModalOpen(true);
    };

     è™•ç† OCR æˆåŠŸ
    const handleOcrSuccess = useCallback((result) = {
         è‡ªå‹•å¡«å…¥ OCR çµæœ
        setCurrentPrice(result.price);
        setComparisonResult(prev = ({ ...prev, bestStore result.storeName })); 
        setDiscountDetails(result.discountDetails); 
        setStatusMessage(`OCR æˆåŠŸï¼åƒ¹æ ¼ $${result.price}, å•†åº— ${result.storeName}ã€‚å„ªæƒ  ${result.discountDetails}`);
    }, []);

     è™•ç† OCR å¤±æ•—
    const handleOcrError = useCallback((error) = {
        setStatusMessage(`OCR å¤±æ•— ${error.message}`);
    }, []);


     ä¸»é¡Œè®Šæ•¸ï¼Œç”¨æ–¼å‹•æ…‹ Tailwind é¡åˆ¥
    const themePrimary = currentTheme.primary;
    const themeText = currentTheme.text;
    const themeLight = currentTheme.light;
    const themeBorder = currentTheme.border;

     æ ¹æ“šæŸ¥è©¢ç‹€æ…‹é¡¯ç¤ºç”¢å“åç¨±æç¤º
    const productNamePlaceholder = useMemo(() = {
        switch(lookupStatus) {
            case 'searching'
                return 'æ­£åœ¨æŸ¥è©¢ç”¢å“è³‡æ–™...';
            case 'found'
                return 'ç”¢å“åç¨±å·²è‡ªå‹•è¼‰å…¥';
            case 'new'
                return 'ç”¢å“ä¸å­˜åœ¨ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åç¨±';
            default
                return 'è«‹å…ˆè¼¸å…¥æ¢ç¢¼æˆ–æƒææ¢ç¢¼';
        }
    }, [lookupStatus]);


    if (!isAuthReady) {
         é›–ç„¶ç†è«–ä¸Š Local Storage ç¸½æ˜¯ readyï¼Œä½†ä¿ç•™æ­¤é˜²å‘†
        return (
            div className=flex items-center justify-center min-h-screen bg-gray-50
                p className=text-xl text-gray-700æ­£åœ¨åˆå§‹åŒ–æœ¬åœ°æ‡‰ç”¨ç¨‹å¼...p
            div
        );
    }

    return (
         æ‡‰ç”¨ç¨‹å¼ä¸»å®¹å™¨ï¼Œä½¿ç”¨å‹•æ…‹ä¸»é¡Œè‰²
        div className={`min-h-screen p-4 smp-8 ${themeLight}`}
            div className=max-w-xl mx-auto
                header className=flex justify-between items-center mb-6 border-b pb-4
                    h1 className={`text-3xl font-extrabold ${themeText} flex items-center`}
                        Barcode className=w-8 h-8 mr-2 
                        æ¢ç¢¼æ¯”åƒ¹ç¥å™¨ (MVP-æœ¬åœ°å„²å­˜)
                    h1
                    div className=flex items-center space-x-3
                        { ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• }
                        button 
                            onClick={() = setIsThemeModalOpen(true)}
                            className={`p-2 rounded-full text-white shadow-md transition-all ${themePrimary} hoveropacity-80`}
                            title=è¨­å®šä»‹é¢ä¸»é¡Œ
                        
                            PaintBucket className=w-5 h-5 
                        button
                        p className=text-sm text-gray-500 hidden smblockç”¨æˆ¶ ID {userId}p
                    div
                header

                { ç‹€æ…‹è¨Šæ¯æç¤º (å–ä»£ Alert) }
                {statusMessage && (
                    div className=bg-red-500 text-white p-3 rounded-lg shadow-md mb-4 text-center font-medium transition-opacity duration-300
                        {statusMessage}
                    div
                )}

                { æ•´åˆæµç¨‹å¡ç‰‡ï¼šç”¢å“è­˜åˆ¥ã€åƒ¹æ ¼ç´€éŒ„èˆ‡ OCR }
                div className={`p-6 rounded-xl shadow-2xl bg-white border-t-4 ${themeBorder}`}
                    h2 className={`text-xl font-semibold ${themeText} mb-6 flex items-center`}
                        Search className=w-5 h-5 mr-2  
                        ç”¢å“è­˜åˆ¥ã€åƒ¹æ ¼ç´€éŒ„èˆ‡æ¯”åƒ¹
                    h2
                    
                    { æ¢ç¢¼è¼¸å…¥å€ }
                    div className=mb-6
                        label className=block text-gray-700 font-medium mb-1æ¢ç¢¼æ•¸æ“š (Barcode Data)label
                        input
                            type=text
                            value={barcode}
                            onChange={(e) = setBarcode(e.target.value)}
                            placeholder=æƒææˆ–æ‰‹å‹•è¼¸å…¥æ¢ç¢¼ (EANUPC)
                            className=w-full p-3 border border-gray-300 rounded-lg focusring-2 focusring-indigo-500 focusborder-indigo-500 transition
                        
                    div
                    
                    { ç”¢å“åç¨±å€ - é…åˆè‡ªå‹•æŸ¥è©¢ }
                    div className=mb-6
                        label className=block text-gray-700 font-medium mb-1ç”¢å“åç¨± (Product Name)label
                        input
                            type=text
                            value={productName}
                            onChange={(e) = setProductName(e.target.value)}
                            placeholder={productNamePlaceholder}
                            className={`w-full p-3 border border-gray-300 rounded-lg transition 
                                ${lookupStatus === 'found'  'bg-green-50'  lookupStatus === 'new'  'bg-yellow-50'  ''}`}
                            readOnly={lookupStatus === 'found'}  æ‰¾åˆ°å¾Œé–å®š
                        
                        p className=text-sm text-gray-500 mt-1
                            æ•¸å€¼ ID (Hash) {barcode  djb2Hash(barcode)  'å°šæœªè¨ˆç®—'}
                        p
                    div

                    { åƒ¹æ ¼èˆ‡å•†åº—è¼¸å…¥OCR å€ }
                    div className=grid grid-cols-2 gap-4 mb-4
                        div
                            label className=block text-gray-700 font-medium mb-1æ¨™åƒ¹ ($)label
                            input
                                type=number
                                value={currentPrice}
                                onChange={(e) = setCurrentPrice(e.target.value)}
                                placeholder=åƒ¹æ ¼ (æ‰‹å‹•è¼¸å…¥)
                                className=w-full p-3 border border-gray-300 rounded-lg
                            
                        div
                        div
                            label className=block text-gray-700 font-medium mb-1å•†åº—åç¨±label
                            input
                                type=text
                                value={comparisonResult.bestStore  ''}  é€™è£¡ç”¨ä¾†é¡¯ç¤º OCR æˆ–æ‰‹å‹•è¼¸å…¥çš„å•†åº—
                                onChange={(e) = setComparisonResult(prev = ({ ...prev, bestStore e.target.value }))}
                                placeholder=å•†åº—åç¨±
                                className=w-full p-3 border border-gray-300 rounded-lg
                            
                        div
                    div
                    
                    { å„ªæƒ ç´°ç¯€è¼¸å…¥å€ (æ–°å¢) }
                    div className=mb-6
                        label className=block text-gray-700 font-medium mb-1å„ªæƒ ç´°ç¯€ä¿ƒéŠ·æ´»å‹• (Discount Details)label
                        input
                            type=text
                            value={discountDetails}
                            onChange={(e) = setDiscountDetails(e.target.value)}
                            placeholder=ä¾‹å¦‚ è²·äºŒé€ä¸€, ç¬¬äºŒä»¶åŠåƒ¹, çµ„åˆåƒ¹ $150
                            className=w-full p-3 border border-gray-300 rounded-lg
                        
                    div

                    { å‹•ä½œæŒ‰éˆ•ç¾¤çµ„ }
                    div className=grid grid-cols-1 smgrid-cols-2 gap-4
                        { æ¢ç¢¼æƒæ - ç¾åœ¨æœƒæ‰“é–‹ Modal }
                        button 
                            className={`p-3 rounded-lg text-white font-semibold shadow-lg transition-all bg-gray-500 hoverbg-gray-600`}
                            onClick={handleBarcodeScanClick}
                        
                            Camera className=inline-block w-5 h-5 mr-2  å•Ÿå‹•æ¢ç¢¼æƒæ
                        button
                        
                        { åƒ¹æ ¼ OCR }
                        button 
                            className={`p-3 rounded-lg text-white font-semibold shadow-lg transition-all ${themePrimary} hoveropacity-80`}
                            onClick={() = document.getElementById('ocr-upload').click()}
                            disabled={isLoading}
                        
                            Upload className=inline-block w-5 h-5 mr-2  
                            {isLoading  'OCR åˆ†æä¸­...'  'æ‹ç…§OCR åƒ¹æ ¼æ¨™ç±¤'}
                        button
                        input
                            type=file
                            id=ocr-upload
                            accept=image
                            onChange={async (e) = {
                                const file = e.target.files[0];
                                if (!file) return;

                                setIsLoading(true);
                                try {
                                    const reader = new FileReader();
                                    reader.onloadend = async () = {
                                        const base64Image = reader.result.split(',')[1];
                                        const result = await performOCRAnalysis(base64Image);
                                        handleOcrSuccess(result);
                                    };
                                    reader.readAsDataURL(file);
                                } catch (error) {
                                    handleOcrError(error);
                                } finally {
                                    setIsLoading(false);
                                }
                            }}
                            className=hidden
                        
                    div
                    
                    { å„²å­˜ç´€éŒ„ä¸¦æ¯”åƒ¹ }
                    button 
                        className={`w-full mt-4 p-3 rounded-lg text-white font-semibold shadow-lg transition-all bg-emerald-500 hoverbg-emerald-600`}
                        onClick={saveAndComparePrice}
                        disabled={isLoading}
                    
                        ClipboardCheck className=inline-block w-5 h-5 mr-2  
                        {isLoading  'å„²å­˜ä¸¦æ¯”åƒ¹ä¸­...'  'å„²å­˜ç´€éŒ„ä¸¦æ¯”åƒ¹'}
                    button
                div

                { æ¯”åƒ¹çµæœé¡¯ç¤ºå€ }
                div className=mt-8
                    h2 className={`text-xl font-semibold ${themeText} mb-4 flex items-center`}
                        DollarSign className=w-5 h-5 mr-2 
                        æ¯”åƒ¹çµæœ
                    h2
                    div className={`p-6 rounded-xl shadow-xl border-2 ${comparisonResult.isBest  'border-green-500 bg-green-50'  'border-yellow-500 bg-yellow-50'}`}
                        p className={`text-lg font-bold ${comparisonResult.isBest  'text-green-700'  'text-yellow-700'}`}
                            {comparisonResult.message}
                        p
                        {comparisonResult.bestPrice && (
                            p className=text-sm text-gray-600 mt-2
                                æ­·å²æœ€ä½æ¨™åƒ¹ ${comparisonResult.bestPrice}
                            p
                        )}
                        { æç¤ºç¾åœ¨ç´€éŒ„äº†è©³ç´°çš„å„ªæƒ è³‡è¨Š }
                        p className=text-xs text-gray-500 mt-2
                            é™„è¨» æ‚¨çš„ç´€éŒ„å·²å„²å­˜åœ¨ç€è¦½å™¨çš„æœ¬åœ°å„²å­˜ä¸­ (Local Storage)ã€‚
                        p
                    div
                div
            div

            { ä¸»é¡Œé¸æ“‡ Modal }
            {isThemeModalOpen && (
                ThemeSelector 
                    theme={currentTheme} 
                    saveTheme={saveUserTheme} 
                    onClose={() = setIsThemeModalOpen(false)} 
                
            )}

            { æ¢ç¢¼æƒæ Modal - æƒæå™¨ä»‹é¢ }
            {isScannerModalOpen && (
                BarcodeScannerModal
                    theme={currentTheme}
                    onScanSuccess={handleScanSuccess}
                    onClose={() = setIsScannerModalOpen(false)}
                
            )}
        div
    );
}

 æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼
export default App;
</file>

<file path="åƒè€ƒç¨‹å¼4.txt">
import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
// å·²ç§»é™¤æ‰€æœ‰ Firebase ç›¸é—œçš„ import

import { Upload, Camera, QrCode, RotateCcw, PaintBucket, DollarSign, Barcode, ClipboardCheck, Search, X } from 'lucide-react';

// -----------------------------------------------------------------------------
// 1. æ ¸å¿ƒè¨­å®šèˆ‡å·¥å…·å‡½æ•¸ (Core Setup & Utilities)
// -----------------------------------------------------------------------------

// MVP éšæ®µä½¿ç”¨ Local Storage æ¨¡æ“¬ App ID
const MVP_APP_ID = 'mvp-local-price-app'; 

/**
 * DJB2 é›œæ¹Šç®—æ³•ï¼šå°‡æ¢ç¢¼å­—ä¸²è½‰æ›ç‚ºæ•¸å€¼ ID (numericalID)ã€‚
 * @param {string} str - åŸå§‹æ¢ç¢¼å­—ä¸²
 * @returns {number} - 32ä½å…ƒç„¡ç¬¦è™Ÿæ•´æ•¸
 */
function djb2Hash(str) {
    let hash = 5381;
    for (let i = 0; i < str.length; i++) {
        // hash * 33 + charCode
        hash = ((hash << 5) + hash) + str.charCodeAt(i);
    }
    // è½‰æ›ç‚ºç„¡ç¬¦è™Ÿ 32 ä½æ•´æ•¸
    return hash >>> 0;
}

// -----------------------------------------------------------------------------
// 2. ä¸»é¡Œé…ç½® (Theming Configuration)
// -----------------------------------------------------------------------------

// å®šç¾©æ‰€æœ‰å¯é¸ä¸»é¡ŒåŠå…¶ Tailwind é¡è‰²é¡åˆ¥
const THEMES = {
    'Default (Indigo)': { 
        primary: 'bg-indigo-600', 
        light: 'bg-indigo-100', 
        hover: 'hover:bg-indigo-700', 
        border: 'border-indigo-600',
        text: 'text-indigo-600',
        color: 'indigo'
    },
    'æµ·æ´‹è— (Ocean Blue)': { 
        primary: 'bg-blue-600', 
        light: 'bg-blue-100', 
        hover: 'hover:bg-blue-700', 
        border: 'border-blue-600',
        text: 'text-blue-600',
        color: 'blue'
    },
    'æ£®æ—ç¶  (Forest Green)': { 
        primary: 'bg-green-600', 
        light: 'bg-green-100', 
        hover: 'hover:bg-green-700', 
        border: 'border-green-600',
        text: 'text-green-600',
        color: 'green'
    },
    'å¤•é™½ç´… (Sunset Red)': { 
        primary: 'bg-red-600', 
        light: 'bg-red-100', 
        hover: 'hover:bg-red-700', 
        border: 'border-red-600',
        text: 'text-red-600',
        color: 'red'
    },
    'æ´»åŠ›æ©™ (Vibrant Orange)': { 
        primary: 'bg-orange-600', 
        light: 'bg-orange-100', 
        hover: 'hover:bg-orange-700', 
        border: 'border-orange-600',
        text: 'text-orange-600',
        color: 'orange'
    },
    'è–°è¡£è‰ç´« (Lavender)': { 
        primary: 'bg-purple-600', 
        light: 'bg-purple-100', 
        hover: 'hover:bg-purple-700', 
        border: 'border-purple-600',
        text: 'text-purple-600',
        color: 'purple'
    },
};

const DEFAULT_THEME_KEY = 'Default (Indigo)';

// -----------------------------------------------------------------------------
// 3. è‡ªå®šç¾© Hook - æœ¬åœ°å„²å­˜è¨­å®š (useLocalMVPSetup)
// -----------------------------------------------------------------------------

/**
 * è™•ç† MVP éšæ®µçš„æœ¬åœ°å„²å­˜ã€ä¸»é¡Œå’Œä½¿ç”¨è€… ID ç®¡ç†ã€‚
 * @returns {object} åŒ…å« userId, isAuthReady, currentTheme, saveUserTheme ç­‰ç‹€æ…‹å’Œç‰©ä»¶ã€‚
 */
function useLocalMVPSetup() {
    // ç²å–æˆ–ç”ŸæˆæŒä¹…åŒ–çš„ç”¨æˆ¶ ID
    const [userId] = useState(() => {
        let savedId = localStorage.getItem('mvp_user_id');
        if (!savedId) {
            savedId = crypto.randomUUID();
            localStorage.setItem('mvp_user_id', savedId);
        }
        return savedId;
    });

    // è¼‰å…¥æœ¬åœ°å„²å­˜çš„ä¸»é¡Œ
    const [currentTheme, setCurrentTheme] = useState(() => {
        const savedKey = localStorage.getItem('appTheme') || DEFAULT_THEME_KEY;
        return THEMES[savedKey] || THEMES[DEFAULT_THEME_KEY];
    });

    // å„²å­˜ç”¨æˆ¶ä¸»é¡Œåˆ°æœ¬åœ°å„²å­˜
    const saveUserTheme = useCallback((themeKey) => {
        localStorage.setItem('appTheme', themeKey);
        setCurrentTheme(THEMES[themeKey] || THEMES[DEFAULT_THEME_KEY]);
    }, []);

    // åœ¨æœ¬åœ° MVP æ¨¡å¼ä¸‹ï¼Œæ‡‰ç”¨ç¨‹å¼å§‹çµ‚æ˜¯æº–å‚™å°±ç·’çš„
    const isAuthReady = true; 
    
    return { 
        userId, 
        isAuthReady, 
        currentTheme, 
        saveUserTheme,
        appId: MVP_APP_ID // å‚³å›ç¡¬ç·¨ç¢¼çš„ App ID
    };
}

// -----------------------------------------------------------------------------
// 4. ä¸»é¡Œé¸æ“‡å…ƒä»¶ (Theme Selector Component)
// -----------------------------------------------------------------------------

/**
 * é¡¯ç¤ºä¸»é¡Œé¸æ“‡é¢æ¿çš„ Modal å…ƒä»¶ã€‚
 */
function ThemeSelector({ theme, saveTheme, onClose }) {
    const handleThemeChange = (themeKey) => {
        saveTheme(themeKey);
    };

    const handleReset = () => {
        saveTheme(DEFAULT_THEME_KEY);
    };

    return (
        <div className="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all">
                <h3 className={`text-xl font-bold ${theme.text} mb-4 border-b pb-2`}>
                    <PaintBucket className="inline-block w-5 h-5 mr-2" />
                    ä»‹é¢é…è‰²é¸é …
                </h3>
                
                <div className="grid grid-cols-2 gap-4 mb-6">
                    {Object.keys(THEMES).map((themeKey) => {
                        const themeData = THEMES[themeKey];
                        const isSelected = theme.color === themeData.color;
                        return (
                            <button
                                key={themeKey}
                                onClick={() => handleThemeChange(themeKey)}
                                className={`
                                    p-3 rounded-lg text-white font-medium shadow-md transition-all 
                                    ${themeData.primary} ${themeData.hover} 
                                    ${isSelected ? 'ring-4 ring-offset-2 ring-opacity-70 ring-gray-400' : ''}
                                `}
                                style={{ transform: isSelected ? 'scale(1.05)' : 'scale(1)' }}
                            >
                                {themeKey}
                            </button>
                        );
                    })}
                </div>

                <div className="flex justify-between items-center pt-4 border-t">
                    <button
                        onClick={handleReset}
                        className="flex items-center text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors"
                    >
                        <RotateCcw className="w-4 h-4 mr-1" />
                        æ¸…é™¤é‚„åŸ (é è¨­)
                    </button>
                    <button
                        onClick={onClose}
                        className={`px-4 py-2 text-white font-semibold rounded-lg shadow-lg ${theme.primary} ${theme.hover} transition-all`}
                    >
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    );
}

// -----------------------------------------------------------------------------
// 5. æ¢ç¢¼æƒæå…ƒä»¶ (Barcode Scanner Modal Component)
// -----------------------------------------------------------------------------

/**
 * æ¢ç¢¼æƒæ Modal å…ƒä»¶ (QuaggaJS æ¨¡æ“¬)
 * è² è²¬è™•ç†ç›¸æ©Ÿå­˜å–ã€è¦–è¨Šé¡¯ç¤ºï¼Œä¸¦å°‡æƒæçµæœå‚³å›çˆ¶å…ƒä»¶ã€‚
 */
function BarcodeScannerModal({ theme, onScanSuccess, onClose }) {
    const videoRef = useRef(null);
    const streamRef = useRef(null);
    const [isScanning, setIsScanning] = useState(false);
    const [scanError, setScanError] = useState('');

    // é–‹å§‹æƒæ (åˆå§‹åŒ–æ”å½±æ©Ÿ)
    const startScanner = useCallback(async () => {
        setScanError('');
        try {
            // å˜—è©¦å–å¾—å¾Œç½®æ”å½±æ©Ÿ ('environment')
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment", 
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                } 
            });
            streamRef.current = stream;
            
            // å°‡è¦–è¨Šæµè¨­å®šçµ¦ <video> å…ƒç´ 
            if (videoRef.current) {
                videoRef.current.srcObject = stream;
                await videoRef.current.play();
                setIsScanning(true);
            }
            
        } catch (err) {
            console.error("ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:", err);
            setScanError(`ç„¡æ³•å­˜å–æ”å½±æ©Ÿæˆ–æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚ (${err.name} - ${err.message})`);
            setIsScanning(false);
        }
    }, []);

    // åœæ­¢æƒæ (é‡‹æ”¾æ”å½±æ©Ÿè³‡æº)
    const stopScanner = useCallback(() => {
        if (streamRef.current) {
            streamRef.current.getTracks().forEach(track => track.stop());
            streamRef.current = null;
        }
        setIsScanning(false);
    }, []);

    // è™•ç† Modal é–‹å•Ÿ/é—œé–‰æ™‚çš„ç”Ÿå‘½é€±æœŸ
    useEffect(() => {
        startScanner();
        // æ¸…ç†å‡½æ•¸ï¼šç•¶å…ƒä»¶å¸è¼‰æ™‚åœæ­¢æ”å½±æ©Ÿ
        return () => {
            stopScanner();
        };
    }, [startScanner, stopScanner]);

    // æ¨¡æ“¬å¯¦éš›çš„æ¢ç¢¼æª¢æ¸¬æˆåŠŸ
    const handleSimulatedScan = () => {
        stopScanner();
        // æ¨¡æ“¬ä¸€å€‹å¸¸è¦‹çš„ EAN-13 æ¢ç¢¼ï¼šçµ±ä¸€ç¢¼ 471 é–‹é ­
        const mockBarcode = '4710123456789'; 
        onScanSuccess(mockBarcode);
        onClose();
    };

    const themePrimary = theme.primary;
    const themeHover = theme.hover;

    return (
        <div className="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex flex-col items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all flex flex-col items-center">
                <header className="flex justify-between items-center w-full mb-4 border-b pb-2">
                    <h3 className={`text-xl font-bold ${theme.text} flex items-center`}>
                        <QrCode className="inline-block w-5 h-5 mr-2" />
                        æ¢ç¢¼æƒæå™¨ (æ¸¬è©¦ç‰ˆ)
                    </h3>
                    <button onClick={() => { stopScanner(); onClose(); }} className="p-1 rounded-full text-gray-500 hover:text-gray-900">
                        <X className="w-6 h-6" />
                    </button>
                </header>

                {scanError ? (
                    <div className="text-red-600 bg-red-100 p-4 rounded-lg w-full mb-4 text-center">
                        {scanError}
                    </div>
                ) : (
                    <div className="relative w-full aspect-video bg-black rounded-lg overflow-hidden mb-4 border-4 border-dashed border-green-400">
                        {/* æ”åƒé ­è¦–è¨Šè¼¸å‡º */}
                        <video 
                            ref={videoRef} 
                            className="w-full h-full object-cover" 
                            // æ¢ç¢¼æƒæä½¿ç”¨å¾Œç½®é¡é ­ (environment)ï¼Œæ‡‰ä¿æŒç•«é¢æ–¹å‘ä¸€è‡´ï¼Œä¸é€²è¡Œé¡åƒç¿»è½‰ã€‚
                            playsInline 
                            muted
                        ></video>
                        {/* æƒæå°ç„¦æ¡† - ä½¿ç”¨ Tailwind æ¨¡æ“¬ */}
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div className="w-4/5 h-1 bg-green-500 opacity-75 animate-pulse"></div>
                            <div className="absolute w-4/5 h-4/5 border-4 border-green-500 border-opacity-75 rounded-lg"></div>
                        </div>
                    </div>
                )}
                
                {/* æ¨¡æ“¬æƒææˆåŠŸæŒ‰éˆ• */}
                {isScanning && !scanError && (
                    <button
                        onClick={handleSimulatedScan}
                        className={`w-full p-3 mb-3 rounded-lg text-white font-semibold shadow-lg transition-all ${themePrimary} ${themeHover}`}
                    >
                        æ¨¡æ“¬æƒææˆåŠŸä¸¦ä½¿ç”¨æ¢ç¢¼ (EAN: 4710123456789)
                    </button>
                )}

                <button
                    onClick={() => { stopScanner(); onClose(); }}
                    className="w-full p-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow-lg transition-all"
                >
                    é—œé–‰æƒæå™¨
                </button>
            </div>
        </div>
    );
}


// -----------------------------------------------------------------------------
// 6. ä¸»æ‡‰ç”¨ç¨‹å¼å…ƒä»¶ (App Component)
// -----------------------------------------------------------------------------

function App() {
    // ä½¿ç”¨ Local Storage æ›¿æ› Firebase
    const { userId, isAuthReady, currentTheme, saveUserTheme } = useLocalMVPSetup();
    
    // UI ç‹€æ…‹ç®¡ç†
    const [barcode, setBarcode] = useState('');
    const [productName, setProductName] = useState('');
    const [currentPrice, setCurrentPrice] = useState('');
    const [discountDetails, setDiscountDetails] = useState(''); 
    const [isThemeModalOpen, setIsThemeModalOpen] = useState(false);
    const [isScannerModalOpen, setIsScannerModalOpen] = useState(false); 
    const [comparisonResult, setComparisonResult] = useState({
        isBest: false,
        bestPrice: null,
        bestStore: null,
        message: 'ç­‰å¾…æ¯”åƒ¹æ•¸æ“š...'
    });
    const [isLoading, setIsLoading] = useState(false); 
    const [lookupStatus, setLookupStatus] = useState('ready'); 
    const [statusMessage, setStatusMessage] = useState(''); 

    // -----------------------------------------------------------------------------
    // ç”¢å“è­˜åˆ¥é‚è¼¯ (Local Storage ç‰ˆæœ¬)
    // -----------------------------------------------------------------------------
    const lookupProduct = useCallback(async (barcodeData) => {
        if (!barcodeData || barcodeData.length < 5) {
            setProductName('');
            setLookupStatus('ready');
            return;
        }

        setLookupStatus('searching');
        const numericalID = djb2Hash(barcodeData);
        
        try {
            // æ¨¡æ“¬å»¶é²
            await new Promise(r => setTimeout(r, 200)); 
            
            // å¾ Local Storage è®€å–ç”¢å“ä¸»æª”
            const productsJson = localStorage.getItem('MVP_PRODUCTS') || '{}';
            const products = JSON.parse(productsJson);

            if (products[numericalID]) {
                setProductName(products[numericalID].productName);
                setLookupStatus('found');
                console.log("ç”¢å“å·²è­˜åˆ¥ (Local Storage):", products[numericalID].productName);
            } else {
                setProductName('');
                setLookupStatus('new');
                console.log("æ–°ç”¢å“ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åç¨±ã€‚");
            }
        } catch (error) {
            console.error("æŸ¥è©¢ç”¢å“å¤±æ•— (Local Storage):", error);
            setLookupStatus('ready');
        }
    }, []); // ç§»é™¤ db ä¾è³´é …

    useEffect(() => {
        // ç•¶æ¢ç¢¼è¼¸å…¥æ”¹è®Šä¸”æ‡‰ç”¨ç¨‹å¼æº–å‚™å°±ç·’æ™‚ï¼Œè§¸ç™¼ç”¢å“æŸ¥è©¢
        if (barcode.length > 0 && isAuthReady) {
            const timer = setTimeout(() => {
                lookupProduct(barcode);
            }, 500); 
            return () => clearTimeout(timer); 
        }
    }, [barcode, isAuthReady, lookupProduct]);

    // è™•ç†ç‹€æ…‹è¨Šæ¯è‡ªå‹•æ¶ˆå¤±
    useEffect(() => {
        if (statusMessage) {
            const timer = setTimeout(() => {
                setStatusMessage('');
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [statusMessage]);

    // æ¨¡æ“¬ OCR å‡½æ•¸ (Placeholder)
    const performOCRAnalysis = useCallback(async (base64Image) => {
        console.log("æ­£åœ¨æ¨¡æ“¬ OCR åˆ†æ...");
        await new Promise(r => setTimeout(r, 1500)); // æ¨¡æ“¬ API å»¶é²

        // æ¨¡æ“¬çµæ§‹åŒ–è¼¸å‡º - åŒ…å«å„ªæƒ ç´°ç¯€
        return {
            storeName: 'æ¨¡æ“¬è¶…å•† (OCR)',
            price: (Math.random() * 50 + 100).toFixed(2), // éš¨æ©Ÿåƒ¹æ ¼
            discountDetails: 'è²·äºŒé€ä¸€å„ªæƒ  / å–®ä»¶ $120 / æœ‰æ•ˆæœŸé™ 2026/01/01', 
        };
    }, []);

    // å„²å­˜ä¸¦æ¯”åƒ¹å‡½æ•¸ (Local Storage ç‰ˆæœ¬)
    const saveAndComparePrice = useCallback(async () => {
        const numericalID = djb2Hash(barcode);
        const priceValue = parseFloat(currentPrice);

        if (!userId || !barcode || !productName || isNaN(priceValue)) {
            setStatusMessage("è«‹ç¢ºä¿å·²è¼¸å…¥æ¢ç¢¼ã€ç”¢å“åç¨±å’Œæœ‰æ•ˆåƒ¹æ ¼ï¼");
            return;
        }

        setIsLoading(true);
        
        try {
            // å¾ Local Storage ç²å–æ•¸æ“š
            const productsJson = localStorage.getItem('MVP_PRODUCTS') || '{}';
            const allRecordsJson = localStorage.getItem('MVP_PRICE_RECORDS') || '[]';
            let products = JSON.parse(productsJson);
            let allRecords = JSON.parse(allRecordsJson);

            // 0. æª¢æŸ¥ä¸¦å‰µå»ºç”¢å“ä¸»æª” (å¦‚æœä¸å­˜åœ¨)
            if (!products[numericalID]) {
                products[numericalID] = {
                    numericalID,
                    barcodeData: barcode,
                    productName,
                    createdAt: new Date().toISOString(),
                };
                // å„²å­˜å› Local Storage
                localStorage.setItem('MVP_PRODUCTS', JSON.stringify(products));
                console.log("å·²å‰µå»ºæ–°çš„ç”¢å“ä¸»æª” (Local Storage)ã€‚");
            }
            
            // 1. å„²å­˜æ–°çš„åƒ¹æ ¼ç´€éŒ„
            const priceRecord = {
                numericalID,
                productName,
                storeName: comparisonResult.bestStore || "æ‰‹å‹•è¼¸å…¥",
                price: priceValue,
                discountDetails: discountDetails, 
                timestamp: new Date().toISOString(),
                recordedBy: userId,
            };
            
            allRecords.push(priceRecord);
            // å„²å­˜å› Local Storage
            localStorage.setItem('MVP_PRICE_RECORDS', JSON.stringify(allRecords));
            
            // 2. åŸ·è¡Œæ¯”åƒ¹é‚è¼¯ - æŸ¥è©¢è©²ç”¢å“æ‰€æœ‰æ­·å²ç´€éŒ„
            const records = allRecords.filter(r => r.numericalID === numericalID);

            if (records.length <= 1) { 
                setComparisonResult({ 
                    isBest: true, 
                    bestPrice: priceValue,
                    bestStore: comparisonResult.bestStore || "æ‰‹å‹•è¼¸å…¥",
                    message: 'é€™æ˜¯ç¬¬ä¸€ç­†ç´€éŒ„ï¼' 
                });
            } else {
                // æ‰¾å‡ºæ‰€æœ‰ç´€éŒ„ä¸­çš„æœ€ä½æ¨™åƒ¹
                const bestDeal = records.reduce((best, cur) => cur.price < best.price ? cur : best);
                
                const isCurrentBest = priceRecord.price <= bestDeal.price;
                
                // æ¯”è¼ƒé‚è¼¯ï¼šæ¨™åƒ¹æœ€ä½å„ªå…ˆï¼›æ¨™åƒ¹ç›¸åŒå‰‡æœ‰æŠ˜æ‰£å„ªå…ˆ
                const isTrulyBest = isCurrentBest && (priceRecord.price < bestDeal.price || (priceRecord.price === bestDeal.price && priceRecord.discountDetails !== ''));
                
                setComparisonResult({
                    isBest: isTrulyBest,
                    bestPrice: bestDeal.price,
                    bestStore: bestDeal.storeName,
                    message: isTrulyBest 
                        ? 'æ­å–œï¼é€™æ˜¯ç›®å‰ç´€éŒ„ä¸­çš„æœ€ä½æ¨™åƒ¹ (æˆ–å…·å‚™æŠ˜æ‰£)ï¼' 
                        : `éæœ€ä½æ¨™åƒ¹ã€‚æ­·å²æœ€ä½æ¨™åƒ¹ç‚º $${bestDeal.price} (å•†åº—: ${bestDeal.storeName})`
                });
            }

        } catch (error) {
            console.error("å„²å­˜æˆ–æ¯”åƒ¹å¤±æ•— (Local Storage):", error);
            setStatusMessage("æ•¸æ“šæ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–æœ¬åœ°å„²å­˜ç©ºé–“ã€‚");
        } finally {
            setIsLoading(false);
        }
    }, [userId, barcode, productName, currentPrice, discountDetails, comparisonResult.bestStore]); 

    // è™•ç†æ¢ç¢¼æƒææˆåŠŸ
    const handleScanSuccess = useCallback((scannedBarcode) => {
        setBarcode(scannedBarcode); 
        setStatusMessage(`æ¢ç¢¼æƒææˆåŠŸï¼å·²è‡ªå‹•å¡«å…¥æ¢ç¢¼: ${scannedBarcode}`);
    }, []);

    // æ¢ç¢¼æƒæåŠŸèƒ½é»æ“Šè™•ç†ï¼šæ‰“é–‹ Modal
    const handleBarcodeScanClick = () => {
        setIsScannerModalOpen(true);
    };

    // è™•ç† OCR æˆåŠŸ
    const handleOcrSuccess = useCallback((result) => {
        // è‡ªå‹•å¡«å…¥ OCR çµæœ
        setCurrentPrice(result.price);
        setComparisonResult(prev => ({ ...prev, bestStore: result.storeName })); 
        setDiscountDetails(result.discountDetails); 
        setStatusMessage(`OCR æˆåŠŸï¼åƒ¹æ ¼: $${result.price}, å•†åº—: ${result.storeName}ã€‚å„ªæƒ : ${result.discountDetails}`);
    }, []);

    // è™•ç† OCR å¤±æ•—
    const handleOcrError = useCallback((error) => {
        setStatusMessage(`OCR å¤±æ•—: ${error.message}`);
    }, []);


    // ä¸»é¡Œè®Šæ•¸ï¼Œç”¨æ–¼å‹•æ…‹ Tailwind é¡åˆ¥
    const themePrimary = currentTheme.primary;
    const themeText = currentTheme.text;
    const themeLight = currentTheme.light;
    const themeBorder = currentTheme.border;

    // æ ¹æ“šæŸ¥è©¢ç‹€æ…‹é¡¯ç¤ºç”¢å“åç¨±æç¤º
    const productNamePlaceholder = useMemo(() => {
        switch(lookupStatus) {
            case 'searching':
                return 'æ­£åœ¨æŸ¥è©¢ç”¢å“è³‡æ–™...';
            case 'found':
                return 'ç”¢å“åç¨±å·²è‡ªå‹•è¼‰å…¥';
            case 'new':
                return 'ç”¢å“ä¸å­˜åœ¨ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åç¨±';
            default:
                return 'è«‹å…ˆè¼¸å…¥æ¢ç¢¼æˆ–æƒææ¢ç¢¼';
        }
    }, [lookupStatus]);


    if (!isAuthReady) {
        // é›–ç„¶ç†è«–ä¸Š Local Storage ç¸½æ˜¯ readyï¼Œä½†ä¿ç•™æ­¤é˜²å‘†
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <p className="text-xl text-gray-700">æ­£åœ¨åˆå§‹åŒ–æœ¬åœ°æ‡‰ç”¨ç¨‹å¼...</p>
            </div>
        );
    }

    return (
        // æ‡‰ç”¨ç¨‹å¼ä¸»å®¹å™¨ï¼Œä½¿ç”¨å‹•æ…‹ä¸»é¡Œè‰²
        <div className={`min-h-screen p-4 sm:p-8 ${themeLight}`}>
            <div className="max-w-xl mx-auto">
                <header className="flex justify-between items-center mb-6 border-b pb-4">
                    <h1 className={`text-3xl font-extrabold ${themeText} flex items-center`}>
                        <Barcode className="w-8 h-8 mr-2" />
                        æ¢ç¢¼æ¯”åƒ¹ç¥å™¨ (MVP-æœ¬åœ°å„²å­˜)
                    </h1>
                    <div className="flex items-center space-x-3">
                        {/* ä¸»é¡Œåˆ‡æ›æŒ‰éˆ• */}
                        <button 
                            onClick={() => setIsThemeModalOpen(true)}
                            className={`p-2 rounded-full text-white shadow-md transition-all ${themePrimary} hover:opacity-80`}
                            title="è¨­å®šä»‹é¢ä¸»é¡Œ"
                        >
                            <PaintBucket className="w-5 h-5" />
                        </button>
                        <p className="text-sm text-gray-500 hidden sm:block">ç”¨æˆ¶ ID: {userId}</p>
                    </div>
                </header>

                {/* ç‹€æ…‹è¨Šæ¯æç¤º (å–ä»£ Alert) */}
                {statusMessage && (
                    <div className="bg-red-500 text-white p-3 rounded-lg shadow-md mb-4 text-center font-medium transition-opacity duration-300">
                        {statusMessage}
                    </div>
                )}

                {/* æ•´åˆæµç¨‹å¡ç‰‡ï¼šç”¢å“è­˜åˆ¥ã€åƒ¹æ ¼ç´€éŒ„èˆ‡ OCR */}
                <div className={`p-6 rounded-xl shadow-2xl bg-white border-t-4 ${themeBorder}`}>
                    <h2 className={`text-xl font-semibold ${themeText} mb-6 flex items-center`}>
                        <Search className="w-5 h-5 mr-2" /> 
                        ç”¢å“è­˜åˆ¥ã€åƒ¹æ ¼ç´€éŒ„èˆ‡æ¯”åƒ¹
                    </h2>
                    
                    {/* æ¢ç¢¼è¼¸å…¥å€ */}
                    <div className="mb-6">
                        <label className="block text-gray-700 font-medium mb-1">æ¢ç¢¼æ•¸æ“š (Barcode Data)</label>
                        <input
                            type="text"
                            value={barcode}
                            onChange={(e) => setBarcode(e.target.value)}
                            placeholder="æƒææˆ–æ‰‹å‹•è¼¸å…¥æ¢ç¢¼ (EAN/UPC)"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                        />
                    </div>
                    
                    {/* ç”¢å“åç¨±å€ - é…åˆè‡ªå‹•æŸ¥è©¢ */}
                    <div className="mb-6">
                        <label className="block text-gray-700 font-medium mb-1">ç”¢å“åç¨± (Product Name)</label>
                        <input
                            type="text"
                            value={productName}
                            onChange={(e) => setProductName(e.target.value)}
                            placeholder={productNamePlaceholder}
                            className={`w-full p-3 border border-gray-300 rounded-lg transition 
                                ${lookupStatus === 'found' ? 'bg-green-50' : lookupStatus === 'new' ? 'bg-yellow-50' : ''}`}
                            readOnly={lookupStatus === 'found'} // æ‰¾åˆ°å¾Œé–å®š
                        />
                        <p className="text-sm text-gray-500 mt-1">
                            æ•¸å€¼ ID (Hash): {barcode ? djb2Hash(barcode) : 'å°šæœªè¨ˆç®—'}
                        </p>
                    </div>

                    {/* åƒ¹æ ¼èˆ‡å•†åº—è¼¸å…¥/OCR å€ */}
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">æ¨™åƒ¹ ($)</label>
                            <input
                                type="number"
                                value={currentPrice}
                                onChange={(e) => setCurrentPrice(e.target.value)}
                                placeholder="åƒ¹æ ¼ (æ‰‹å‹•è¼¸å…¥)"
                                className="w-full p-3 border border-gray-300 rounded-lg"
                            />
                        </div>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">å•†åº—åç¨±</label>
                            <input
                                type="text"
                                value={comparisonResult.bestStore || ''} // é€™è£¡ç”¨ä¾†é¡¯ç¤º OCR æˆ–æ‰‹å‹•è¼¸å…¥çš„å•†åº—
                                onChange={(e) => setComparisonResult(prev => ({ ...prev, bestStore: e.target.value }))}
                                placeholder="å•†åº—åç¨±"
                                className="w-full p-3 border border-gray-300 rounded-lg"
                            />
                        </div>
                    </div>
                    
                    {/* å„ªæƒ ç´°ç¯€è¼¸å…¥å€ (æ–°å¢) */}
                    <div className="mb-6">
                        <label className="block text-gray-700 font-medium mb-1">å„ªæƒ ç´°ç¯€/ä¿ƒéŠ·æ´»å‹• (Discount Details)</label>
                        <input
                            type="text"
                            value={discountDetails}
                            onChange={(e) => setDiscountDetails(e.target.value)}
                            placeholder="ä¾‹å¦‚: è²·äºŒé€ä¸€, ç¬¬äºŒä»¶åŠåƒ¹, çµ„åˆåƒ¹ $150"
                            className="w-full p-3 border border-gray-300 rounded-lg"
                        />
                    </div>

                    {/* å‹•ä½œæŒ‰éˆ•ç¾¤çµ„ */}
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        {/* æ¢ç¢¼æƒæ - ç¾åœ¨æœƒæ‰“é–‹ Modal */}
                        <button 
                            className={`p-3 rounded-lg text-white font-semibold shadow-lg transition-all bg-gray-500 hover:bg-gray-600`}
                            onClick={handleBarcodeScanClick}
                        >
                            <Camera className="inline-block w-5 h-5 mr-2" /> å•Ÿå‹•æ¢ç¢¼æƒæ
                        </button>
                        
                        {/* åƒ¹æ ¼ OCR */}
                        <button 
                            className={`p-3 rounded-lg text-white font-semibold shadow-lg transition-all ${themePrimary} hover:opacity-80`}
                            onClick={() => document.getElementById('ocr-upload').click()}
                            disabled={isLoading}
                        >
                            <Upload className="inline-block w-5 h-5 mr-2" /> 
                            {isLoading ? 'OCR åˆ†æä¸­...' : 'æ‹ç…§/OCR åƒ¹æ ¼æ¨™ç±¤'}
                        </button>
                        <input
                            type="file"
                            id="ocr-upload"
                            accept="image/*"
                            onChange={async (e) => {
                                const file = e.target.files[0];
                                if (!file) return;

                                setIsLoading(true);
                                try {
                                    const reader = new FileReader();
                                    reader.onloadend = async () => {
                                        const base64Image = reader.result.split(',')[1];
                                        const result = await performOCRAnalysis(base64Image);
                                        handleOcrSuccess(result);
                                    };
                                    reader.readAsDataURL(file);
                                } catch (error) {
                                    handleOcrError(error);
                                } finally {
                                    setIsLoading(false);
                                }
                            }}
                            className="hidden"
                        />
                    </div>
                    
                    {/* å„²å­˜ç´€éŒ„ä¸¦æ¯”åƒ¹ */}
                    <button 
                        className={`w-full mt-4 p-3 rounded-lg text-white font-semibold shadow-lg transition-all bg-emerald-500 hover:bg-emerald-600`}
                        onClick={saveAndComparePrice}
                        disabled={isLoading}
                    >
                        <ClipboardCheck className="inline-block w-5 h-5 mr-2" /> 
                        {isLoading ? 'å„²å­˜ä¸¦æ¯”åƒ¹ä¸­...' : 'å„²å­˜ç´€éŒ„ä¸¦æ¯”åƒ¹'}
                    </button>
                </div>

                {/* æ¯”åƒ¹çµæœé¡¯ç¤ºå€ */}
                <div className="mt-8">
                    <h2 className={`text-xl font-semibold ${themeText} mb-4 flex items-center`}>
                        <DollarSign className="w-5 h-5 mr-2" />
                        æ¯”åƒ¹çµæœ
                    </h2>
                    <div className={`p-6 rounded-xl shadow-xl border-2 ${comparisonResult.isBest ? 'border-green-500 bg-green-50' : 'border-yellow-500 bg-yellow-50'}`}>
                        <p className={`text-lg font-bold ${comparisonResult.isBest ? 'text-green-700' : 'text-yellow-700'}`}>
                            {comparisonResult.message}
                        </p>
                        {comparisonResult.bestPrice && (
                            <p className="text-sm text-gray-600 mt-2">
                                æ­·å²æœ€ä½æ¨™åƒ¹: ${comparisonResult.bestPrice}
                            </p>
                        )}
                        {/* æç¤ºç¾åœ¨ç´€éŒ„äº†è©³ç´°çš„å„ªæƒ è³‡è¨Š */}
                        <p className="text-xs text-gray-500 mt-2">
                            **é™„è¨»:** æ‚¨çš„ç´€éŒ„å·²å„²å­˜åœ¨ç€è¦½å™¨çš„æœ¬åœ°å„²å­˜ä¸­ (Local Storage)ã€‚
                        </p>
                    </div>
                </div>
            </div>

            {/* ä¸»é¡Œé¸æ“‡ Modal */}
            {isThemeModalOpen && (
                <ThemeSelector 
                    theme={currentTheme} 
                    saveTheme={saveUserTheme} 
                    onClose={() => setIsThemeModalOpen(false)} 
                />
            )}

            {/* æ¢ç¢¼æƒæ Modal - æƒæå™¨ä»‹é¢ */}
            {isScannerModalOpen && (
                <BarcodeScannerModal
                    theme={currentTheme}
                    onScanSuccess={handleScanSuccess}
                    onClose={() => setIsScannerModalOpen(false)}
                />
            )}
        </div>
    );
}

// æ¸²æŸ“æ‡‰ç”¨ç¨‹å¼
export default App;
</file>

<file path="åƒè€ƒç¨‹å¼5.txt">
import React, { useState, useEffect, useCallback, useMemo, useRef } from 'react';
import { PaintBucket, DollarSign, Barcode, ClipboardCheck, Search, X, Camera, Zap, FileText } from 'lucide-react';

// -----------------------------------------------------------------------------
// 1. æ ¸å¿ƒè¨­å®šèˆ‡å·¥å…·å‡½æ•¸ (Core Setup & Utilities)
// -----------------------------------------------------------------------------

// MVP éšæ®µä½¿ç”¨ Local Storage æ¨¡æ“¬ App ID
const MVP_APP_ID = 'mvp-local-price-app'; 

/**
 * DJB2 é›œæ¹Šç®—æ³•ï¼šå°‡æ¢ç¢¼å­—ä¸²è½‰æ›ç‚ºæ•¸å€¼ ID (numericalID)ã€‚
 * @param {string} str - åŸå§‹æ¢ç¢¼å­—ä¸²
 * @returns {number} - 32ä½å…ƒç„¡ç¬¦è™Ÿæ•´æ•¸
 */
function djb2Hash(str) {
    let hash = 5381;
    for (let i = 0; i < str.length; i++) {
        // hash * 33 + charCode
        hash = ((hash << 5) + hash) + str.charCodeAt(i);
    }
    // è½‰æ›ç‚ºç„¡ç¬¦è™Ÿ 32 ä½æ•´æ•¸
    return hash >>> 0;
}

/**
 * æŒ‡æ•¸é€€é¿ (Exponential Backoff) åŸ·è¡Œ API å‘¼å«
 */
async function callGeminiApiWithRetry(payload, apiUrl, maxRetries = 3) {
    let lastError = null;
    for (let i = 0; i < maxRetries; i++) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                throw new Error(`API response error: ${response.status} - ${errorBody.error?.message || 'Unknown error'}`);
            }

            const result = await response.json();
            const candidate = result.candidates?.[0];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                const jsonText = candidate.content.parts[0].text;
                try {
                    // è§£æ JSON å…§å®¹
                    return JSON.parse(jsonText);
                } catch (parseError) {
                    console.error("JSON Parse Error:", jsonText, parseError);
                    throw new Error("AI è¼¸å‡ºæ ¼å¼éŒ¯èª¤ï¼Œç„¡æ³•è§£æ JSONã€‚");
                }
            } else {
                throw new Error("AI ç„¡æ³•ç”Ÿæˆæœ‰æ•ˆå…§å®¹ã€‚");
            }

        } catch (error) {
            lastError = error;
            console.warn(`API call failed (Attempt ${i + 1}/${maxRetries}):`, error.message);
            if (i < maxRetries - 1) {
                const delay = Math.pow(2, i) * 1000; // 1s, 2s, 4s
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }
    throw lastError; // æ‰€æœ‰é‡è©¦å¤±æ•—å¾Œæ‹‹å‡ºæœ€å¾Œä¸€å€‹éŒ¯èª¤
}


// -----------------------------------------------------------------------------
// 2. ä¸»é¡Œé…ç½®èˆ‡æœ¬åœ°å„²å­˜è¨­å®š (Theming & Local Setup)
// -----------------------------------------------------------------------------

const THEMES = {
    'Default (Indigo)': { primary: 'bg-indigo-600', light: 'bg-indigo-100', hover: 'hover:bg-indigo-700', border: 'border-indigo-600', text: 'text-indigo-600', color: 'indigo' },
    'æµ·æ´‹è— (Ocean Blue)': { primary: 'bg-blue-600', light: 'bg-blue-100', hover: 'hover:bg-blue-700', border: 'border-blue-600', text: 'text-blue-600', color: 'blue' },
    'æ£®æ—ç¶  (Forest Green)': { primary: 'bg-green-600', light: 'bg-green-100', hover: 'hover:bg-green-700', border: 'border-green-600', text: 'text-green-600', color: 'green' },
    'å¤•é™½ç´… (Sunset Red)': { primary: 'bg-red-600', light: 'bg-red-100', hover: 'hover:bg-red-700', border: 'border-red-600', text: 'text-red-600', color: 'red' },
    'æ´»åŠ›æ©™ (Vibrant Orange)': { primary: 'bg-orange-600', light: 'bg-orange-100', hover: 'hover:bg-orange-700', border: 'border-orange-600', text: 'text-orange-600', color: 'orange' },
    'è–°è¡£è‰ç´« (Lavender)': { primary: 'bg-purple-600', light: 'bg-purple-100', hover: 'hover:bg-purple-700', border: 'border-purple-600', text: 'text-purple-600', color: 'purple' },
};
const DEFAULT_THEME_KEY = 'Default (Indigo)';

function useLocalMVPSetup() {
    const [userId] = useState(() => {
        let savedId = localStorage.getItem('mvp_user_id');
        if (!savedId) {
            savedId = crypto.randomUUID();
            localStorage.setItem('mvp_user_id', savedId);
        }
        return savedId;
    });

    const [currentTheme, setCurrentTheme] = useState(() => {
        const savedKey = localStorage.getItem('appTheme') || DEFAULT_THEME_KEY;
        return THEMES[savedKey] || THEMES[DEFAULT_THEME_KEY];
    });

    const saveUserTheme = useCallback((themeKey) => {
        localStorage.setItem('appTheme', themeKey);
        setCurrentTheme(THEMES[themeKey] || THEMES[DEFAULT_THEME_KEY]);
    }, []);

    const isAuthReady = true; 
    
    return { userId, isAuthReady, currentTheme, saveUserTheme, appId: MVP_APP_ID };
}

// ä¸»é¡Œé¸æ“‡å…ƒä»¶ (Theme Selector Component)
function ThemeSelector({ theme, saveTheme, onClose }) {
    // æ¸²æŸ“é‚è¼¯èˆ‡ä¹‹å‰ç›¸åŒï¼Œç•¥
    const handleThemeChange = (themeKey) => {
        saveTheme(themeKey);
    };

    const handleReset = () => {
        saveTheme(DEFAULT_THEME_KEY);
    };

    return (
        <div className="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all">
                <h3 className={`text-xl font-bold ${theme.text} mb-4 border-b pb-2`}>
                    <PaintBucket className="inline-block w-5 h-5 mr-2" />
                    ä»‹é¢é…è‰²é¸é …
                </h3>
                
                <div className="grid grid-cols-2 gap-4 mb-6">
                    {Object.keys(THEMES).map((themeKey) => {
                        const themeData = THEMES[themeKey];
                        const isSelected = theme.color === themeData.color;
                        return (
                            <button
                                key={themeKey}
                                onClick={() => handleThemeChange(themeKey)}
                                className={`
                                    p-3 rounded-lg text-white font-medium shadow-md transition-all 
                                    ${themeData.primary} ${themeData.hover} 
                                    ${isSelected ? 'ring-4 ring-offset-2 ring-opacity-70 ring-gray-400' : ''}
                                `}
                                style={{ transform: isSelected ? 'scale(1.05)' : 'scale(1)' }}
                            >
                                {themeKey}
                            </button>
                        );
                    })}
                </div>

                <div className="flex justify-between items-center pt-4 border-t">
                    <button
                        onClick={handleReset}
                        className="flex items-center text-sm font-medium text-gray-600 hover:text-gray-900 transition-colors"
                    >
                        <RotateCcw className="w-4 h-4 mr-1" />
                        æ¸…é™¤é‚„åŸ (é è¨­)
                    </button>
                    <button
                        onClick={onClose}
                        className={`px-4 py-2 text-white font-semibold rounded-lg shadow-lg ${theme.primary} ${theme.hover} transition-all`}
                    >
                        é—œé–‰
                    </button>
                </div>
            </div>
        </div>
    );
}

// -----------------------------------------------------------------------------
// 3. AI è¦–è¦ºæ“·å–èˆ‡åˆ†æå…ƒä»¶ (AIOcrCaptureModal)
// -----------------------------------------------------------------------------

/**
 * è² è²¬æ”å½±æ©Ÿå­˜å–ã€æ“·å–ç•«é¢ä¸¦å‘¼å« AI é€²è¡Œåˆ†æçš„ Modal å…ƒä»¶ã€‚
 * è¼¸å‡ºç‚ºçµæ§‹åŒ– JSON æ•¸æ“šã€‚
 */
function AIOcrCaptureModal({ theme, onAnalysisSuccess, onClose }) {
    const videoRef = useRef(null);
    const streamRef = useRef(null);
    const [isCapturing, setIsCapturing] = useState(false);
    const [scanError, setScanError] = useState('');
    const [isLoading, setIsLoading] = useState(false);

    // å–å¾—æ”å½±æ©Ÿç•«é¢
    const startCamera = useCallback(async () => {
        setScanError('');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: "environment", // ä½¿ç”¨å¾Œç½®é¡é ­
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                } 
            });
            streamRef.current = stream;
            
            if (videoRef.current) {
                videoRef.current.srcObject = stream;
                await videoRef.current.play();
                setIsCapturing(true);
            }
            
        } catch (err) {
            console.error("ç„¡æ³•å­˜å–æ”å½±æ©Ÿ:", err);
            setScanError(`ç„¡æ³•å­˜å–æ”å½±æ©Ÿæˆ–æ¬Šé™è¢«æ‹’çµ•ã€‚è«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šã€‚ (${err.name} - ${err.message})`);
            setIsCapturing(false);
        }
    }, []);

    // é‡‹æ”¾æ”å½±æ©Ÿè³‡æº
    const stopCamera = useCallback(() => {
        if (streamRef.current) {
            streamRef.current.getTracks().forEach(track => track.stop());
            streamRef.current = null;
        }
        setIsCapturing(false);
    }, []);

    // è™•ç† Modal é–‹å•Ÿ/é—œé–‰æ™‚çš„ç”Ÿå‘½é€±æœŸ
    useEffect(() => {
        startCamera();
        return () => {
            stopCamera();
        };
    }, [startCamera, stopCamera]);


    // æ“·å–è¦–è¨Šç•«é¢ä¸¦è½‰æ›ç‚º Base64 (JPG) æ•¸æ“š
    const captureImage = useCallback(() => {
        if (!videoRef.current) return null;

        const video = videoRef.current;
        const canvas = document.createElement('canvas');
        // ç¢ºä¿ canvas å°ºå¯¸èˆ‡è¦–è¨Šç•«é¢çš„è§£æåº¦ä¸€è‡´
        canvas.width = video.videoWidth; 
        canvas.height = video.videoHeight;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // å°‡ canvas å…§å®¹è½‰æ›ç‚º Base64 æ ¼å¼çš„ JPEG åœ–ç‰‡ (0.8 å“è³ª)
        const base64Data = canvas.toDataURL('image/jpeg', 0.8);
        
        // ç§»é™¤ MIME é¡å‹å‰ç¶´ï¼Œåªç•™ä¸‹ç´” Base64 æ•¸æ“š
        return base64Data.split(',')[1];
    }, []);
    
    // å‘¼å« Gemini API é€²è¡Œè¦–è¦ºåˆ†æ
    const handleCaptureAndAnalyze = useCallback(async () => {
        setIsLoading(true);
        setScanError('');
        
        try {
            const base64Image = captureImage();
            if (!base64Image) {
                throw new Error("ç„¡æ³•å¾æ”å½±æ©Ÿæ“·å–åˆ°å½±åƒã€‚");
            }

            const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åƒ¹ç›®æ¨™ç±¤å’Œæ”¶æ“šåˆ†æå¸«ã€‚è«‹å¾æä¾›çš„å½±åƒä¸­æå–ç”¢å“æ¢ç¢¼ï¼ˆå¦‚æœå¯è¦‹ï¼‰ã€ä¸»è¦å”®åƒ¹ã€å•†åº—åç¨±ä»¥åŠä»»ä½•è©³ç´°çš„æŠ˜æ‰£æˆ–ä¿ƒéŠ·è³‡è¨Šã€‚è«‹åš´æ ¼ä»¥ JSON æ ¼å¼è¼¸å‡ºã€‚";
            const userPrompt = "åˆ†ææ­¤ç”¢å“æˆ–åƒ¹ç›®æ¨™ç±¤çš„å½±åƒï¼Œä¸¦æå–æ‰€éœ€çš„çµæ§‹åŒ–è³‡è¨Šã€‚è«‹åœ¨ discountDetails ä¸­æä¾›æ‰€æœ‰ç›¸é—œçš„ä¿ƒéŠ·è¨Šæ¯ï¼Œä¾‹å¦‚è²·ä¸€é€ä¸€ã€æœ‰æ•ˆæœŸé™ç­‰ã€‚";
            const apiKey = "" 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userPrompt },
                        {
                            inlineData: {
                                mimeType: "image/jpeg",
                                data: base64Image
                            }
                        }
                    ]
                }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "scannedBarcode": { "type": "STRING", "description": "å½±åƒä¸­æ‰¾åˆ°çš„ EAN, UPC æˆ–å…¶ä»–ç”¢å“æ¢ç¢¼æ•¸å­—ï¼Œå¦‚æœä¸å¯è¦‹å‰‡ç‚ºç©ºå­—ä¸²ã€‚" },
                            "extractedPrice": { "type": "STRING", "description": "ä¸»è¦å”®åƒ¹ï¼Œæ ¼å¼ç‚ºä¹¾æ·¨çš„å­—ä¸²ï¼Œä¸å¸¶è²¨å¹£ç¬¦è™Ÿï¼ˆä¾‹å¦‚ï¼š'120.5'ï¼‰ã€‚å¦‚æœæ‰¾ä¸åˆ°åƒ¹æ ¼å‰‡ç‚ºç©ºå­—ä¸²ã€‚" },
                            "storeName": { "type": "STRING", "description": "åƒ¹ç›®æ¨™ç±¤æˆ–æ”¶æ“šæ‰€ç¤ºçš„å•†åº—åç¨±ã€‚å¦‚æœä¸å¯è¦‹å‰‡ç‚ºç©ºå­—ä¸²ã€‚" },
                            "discountDetails": { "type": "STRING", "description": "ç™¼ç¾çš„ä»»ä½•ä¿ƒéŠ·æˆ–æŠ˜æ‰£çš„è©³ç´°æè¿°ï¼ˆä¾‹å¦‚ï¼š'è²·ä¸€é€ä¸€', 'ç¬¬äºŒä»¶åŠåƒ¹', 'æœ‰æ•ˆæœŸé™ 2026/01/01'ï¼‰ã€‚å¦‚æœæ²’æœ‰æŠ˜æ‰£å‰‡ç‚ºç©ºå­—ä¸²ã€‚" }
                        },
                        "required": ["scannedBarcode", "extractedPrice", "storeName", "discountDetails"]
                    }
                }
            };
            
            // å‘¼å« API ä¸¦ç²å–çµæ§‹åŒ– JSON çµæœ
            const analysisResult = await callGeminiApiWithRetry(payload, apiUrl);
            
            // å‚³å›åˆ†æçµæœ
            onAnalysisSuccess(analysisResult);
            stopCamera();
            onClose();

        } catch (error) {
            console.error("AI åˆ†æå¤±æ•—:", error);
            setScanError(`AI åˆ†æéŒ¯èª¤: ${error.message}`);
        } finally {
            setIsLoading(false);
        }
    }, [captureImage, onAnalysisSuccess, onClose, stopCamera]);
    
    // æ¨¡æ“¬ AI åˆ†ææˆåŠŸ (ç”¨æ–¼æ¸¬è©¦æˆ–ç„¡ç¶²è·¯ç’°å¢ƒ)
    const handleSimulatedAnalysis = () => {
        stopCamera();
        const mockResult = {
            scannedBarcode: '4710123456789',
            extractedPrice: (Math.random() * 50 + 100).toFixed(0).toString(),
            storeName: 'æ¨¡æ“¬è¶…å•† (AI)',
            discountDetails: 'è²·äºŒé€ä¸€å„ªæƒ  / é™æ™‚ä¿ƒéŠ·',
        };
        onAnalysisSuccess(mockResult);
        onClose();
    };

    const themePrimary = theme.primary;
    const themeHover = theme.hover;

    return (
        <div className="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex flex-col items-center justify-center p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 transform transition-all flex flex-col items-center">
                <header className="flex justify-between items-center w-full mb-4 border-b pb-2">
                    <h3 className={`text-xl font-bold ${theme.text} flex items-center`}>
                        <Zap className="inline-block w-5 h-5 mr-2" />
                        AI è¦–è¦ºæ“·å–èˆ‡åˆ†æ
                    </h3>
                    <button onClick={() => { stopCamera(); onClose(); }} className="p-1 rounded-full text-gray-500 hover:text-gray-900">
                        <X className="w-6 h-6" />
                    </button>
                </header>

                {/* ç‹€æ…‹é¡¯ç¤º */}
                {isLoading && (
                    <div className={`w-full p-4 mb-4 rounded-lg bg-yellow-100 text-yellow-800 flex items-center justify-center`}>
                        <svg className="animate-spin -ml-1 mr-3 h-5 w-5 text-yellow-800" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        æ­£åœ¨å‘¼å« AI åˆ†æå½±åƒï¼Œè«‹ç¨å€™...
                    </div>
                )}
                
                {scanError ? (
                    <div className="text-red-600 bg-red-100 p-4 rounded-lg w-full mb-4 text-center">
                        {scanError}
                    </div>
                ) : (
                    <div className="relative w-full aspect-video bg-black rounded-lg overflow-hidden mb-4 border-4 border-dashed border-white">
                        {/* æ”åƒé ­è¦–è¨Šè¼¸å‡º */}
                        <video 
                            ref={videoRef} 
                            className="w-full h-full object-cover" 
                            playsInline 
                            muted
                        ></video>
                        {/* æƒæå°ç„¦æ¡† */}
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <div className="absolute w-4/5 h-4/5 border-4 border-yellow-400 border-opacity-75 rounded-lg"></div>
                        </div>
                    </div>
                )}
                
                {/* å‹•ä½œæŒ‰éˆ• */}
                {isCapturing && !scanError && (
                    <button
                        onClick={handleCaptureAndAnalyze}
                        className={`w-full p-3 mb-3 rounded-lg text-white font-semibold shadow-lg transition-all ${themePrimary} ${themeHover} flex items-center justify-center`}
                        disabled={isLoading}
                    >
                        <Camera className="w-5 h-5 mr-2" />
                        æ“·å–ç•«é¢ä¸¦ç”± AI è‡ªå‹•åˆ†æ
                    </button>
                )}

                {/* æ¨¡æ“¬æŒ‰éˆ• (ç”¨æ–¼æ¸¬è©¦) */}
                 <button
                    onClick={handleSimulatedAnalysis}
                    className="w-full p-3 mb-3 bg-gray-500 hover:bg-gray-600 text-white font-semibold rounded-lg shadow-lg transition-all"
                    disabled={isLoading}
                >
                    æ¨¡æ“¬ AI åˆ†ææˆåŠŸ (æ¸¬è©¦ç”¨)
                </button>


                <button
                    onClick={() => { stopCamera(); onClose(); }}
                    className="w-full p-3 bg-red-500 hover:bg-red-600 text-white font-semibold rounded-lg shadow-lg transition-all"
                    disabled={isLoading}
                >
                    é—œé–‰
                </button>
            </div>
        </div>
    );
}


// -----------------------------------------------------------------------------
// 4. ä¸»æ‡‰ç”¨ç¨‹å¼å…ƒä»¶ (App Component)
// -----------------------------------------------------------------------------

function App() {
    const { userId, isAuthReady, currentTheme, saveUserTheme } = useLocalMVPSetup();
    
    // UI ç‹€æ…‹ç®¡ç†
    const [barcode, setBarcode] = useState('');
    const [productName, setProductName] = useState('');
    const [currentPrice, setCurrentPrice] = useState('');
    const [discountDetails, setDiscountDetails] = useState(''); 
    const [isThemeModalOpen, setIsThemeModalOpen] = useState(false);
    const [isCaptureModalOpen, setIsCaptureModalOpen] = useState(false); 
    const [comparisonResult, setComparisonResult] = useState({
        isBest: false,
        bestPrice: null,
        bestStore: null,
        message: 'ç­‰å¾…æ¯”åƒ¹æ•¸æ“š...'
    });
    const [isLoading, setIsLoading] = useState(false); 
    const [lookupStatus, setLookupStatus] = useState('ready'); 
    const [statusMessage, setStatusMessage] = useState(''); 
    const [storeName, setStoreName] = useState(''); // æ–°å¢å•†åº—åç¨±ç‹€æ…‹

    // -----------------------------------------------------------------------------
    // ç”¢å“è­˜åˆ¥é‚è¼¯ (Local Storage ç‰ˆæœ¬)
    // -----------------------------------------------------------------------------
    const lookupProduct = useCallback(async (barcodeData) => {
        if (!barcodeData || barcodeData.length < 5) {
            setProductName('');
            setLookupStatus('ready');
            return;
        }

        setLookupStatus('searching');
        const numericalID = djb2Hash(barcodeData);
        
        try {
            await new Promise(r => setTimeout(r, 200)); 
            
            const productsJson = localStorage.getItem('MVP_PRODUCTS') || '{}';
            const products = JSON.parse(productsJson);

            if (products[numericalID]) {
                setProductName(products[numericalID].productName);
                setLookupStatus('found');
            } else {
                setProductName('');
                setLookupStatus('new');
            }
        } catch (error) {
            console.error("æŸ¥è©¢ç”¢å“å¤±æ•— (Local Storage):", error);
            setLookupStatus('ready');
        }
    }, []);

    useEffect(() => {
        if (barcode.length > 0 && isAuthReady) {
            const timer = setTimeout(() => {
                lookupProduct(barcode);
            }, 500); 
            return () => clearTimeout(timer); 
        }
    }, [barcode, isAuthReady, lookupProduct]);

    // è™•ç†ç‹€æ…‹è¨Šæ¯è‡ªå‹•æ¶ˆå¤±
    useEffect(() => {
        if (statusMessage) {
            const timer = setTimeout(() => {
                setStatusMessage('');
            }, 3000);
            return () => clearTimeout(timer);
        }
    }, [statusMessage]);

    // è™•ç† AI åˆ†ææˆåŠŸä¸¦å¡«å…¥æ¬„ä½
    const handleAiCaptureSuccess = useCallback((result) => {
        const { scannedBarcode, extractedPrice, storeName, discountDetails } = result;
        
        // 1. è‡ªå‹•å¡«å…¥æ¢ç¢¼
        if (scannedBarcode && scannedBarcode.length > 5) {
            setBarcode(scannedBarcode);
        } else if (!barcode) {
             setStatusMessage("AI æœªèƒ½è­˜åˆ¥æ¢ç¢¼ï¼Œè«‹æ‰‹å‹•è¼¸å…¥æˆ–ç¢ºä¿æ¢ç¢¼æ¸…æ™°ï¼");
        }

        // 2. è‡ªå‹•å¡«å…¥åƒ¹æ ¼ã€å•†åº—ã€æŠ˜æ‰£
        setCurrentPrice(extractedPrice || '');
        setStoreName(storeName || '');
        setDiscountDetails(discountDetails || '');

        setStatusMessage(`AI åˆ†ææˆåŠŸï¼åƒ¹æ ¼: $${extractedPrice || '?'}, å•†åº—: ${storeName || '?'}, æŠ˜æ‰£: ${discountDetails || 'ç„¡'}`);
    }, [barcode]);
    
    // å„²å­˜ä¸¦æ¯”åƒ¹å‡½æ•¸ (Local Storage ç‰ˆæœ¬)
    const saveAndComparePrice = useCallback(async () => {
        const numericalID = djb2Hash(barcode);
        const priceValue = parseFloat(currentPrice);

        if (!userId || !barcode || !productName || isNaN(priceValue)) {
            setStatusMessage("è«‹ç¢ºä¿å·²è¼¸å…¥æ¢ç¢¼ã€ç”¢å“åç¨±å’Œæœ‰æ•ˆåƒ¹æ ¼ï¼");
            return;
        }

        setIsLoading(true);
        
        try {
            // å¾ Local Storage ç²å–æ•¸æ“š
            const productsJson = localStorage.getItem('MVP_PRODUCTS') || '{}';
            const allRecordsJson = localStorage.getItem('MVP_PRICE_RECORDS') || '[]';
            let products = JSON.parse(productsJson);
            let allRecords = JSON.parse(allRecordsJson);

            // 0. æª¢æŸ¥ä¸¦å‰µå»ºç”¢å“ä¸»æª” (å¦‚æœä¸å­˜åœ¨)
            if (!products[numericalID]) {
                products[numericalID] = {
                    numericalID,
                    barcodeData: barcode,
                    productName,
                    createdAt: new Date().toISOString(),
                };
                localStorage.setItem('MVP_PRODUCTS', JSON.stringify(products));
            }
            
            // 1. å„²å­˜æ–°çš„åƒ¹æ ¼ç´€éŒ„
            const priceRecord = {
                numericalID,
                productName,
                storeName: storeName || "æ‰‹å‹•è¼¸å…¥",
                price: priceValue,
                discountDetails: discountDetails, 
                timestamp: new Date().toISOString(),
                recordedBy: userId,
            };
            
            allRecords.push(priceRecord);
            localStorage.setItem('MVP_PRICE_RECORDS', JSON.stringify(allRecords));
            
            // 2. åŸ·è¡Œæ¯”åƒ¹é‚è¼¯ - æŸ¥è©¢è©²ç”¢å“æ‰€æœ‰æ­·å²ç´€éŒ„
            const records = allRecords.filter(r => r.numericalID === numericalID);

            if (records.length <= 1) { 
                setComparisonResult({ 
                    isBest: true, 
                    bestPrice: priceValue,
                    bestStore: storeName || "æ‰‹å‹•è¼¸å…¥",
                    message: 'é€™æ˜¯ç¬¬ä¸€ç­†ç´€éŒ„ï¼' 
                });
            } else {
                const bestDeal = records.reduce((best, cur) => cur.price < best.price ? cur : best);
                const isCurrentBest = priceRecord.price <= bestDeal.price;
                
                // æ¯”è¼ƒé‚è¼¯ï¼šæ¨™åƒ¹æœ€ä½å„ªå…ˆï¼›æ¨™åƒ¹ç›¸åŒå‰‡æœ‰æŠ˜æ‰£å„ªå…ˆ
                const isTrulyBest = isCurrentBest && (priceRecord.price < bestDeal.price || (priceRecord.price === bestDeal.price && priceRecord.discountDetails !== ''));
                
                setComparisonResult({
                    isBest: isTrulyBest,
                    bestPrice: bestDeal.price,
                    bestStore: bestDeal.storeName,
                    message: isTrulyBest 
                        ? 'æ­å–œï¼é€™æ˜¯ç›®å‰ç´€éŒ„ä¸­çš„æœ€ä½æ¨™åƒ¹ (æˆ–å…·å‚™æŠ˜æ‰£)ï¼' 
                        : `éæœ€ä½æ¨™åƒ¹ã€‚æ­·å²æœ€ä½æ¨™åƒ¹ç‚º $${bestDeal.price} (å•†åº—: ${bestDeal.storeName})`
                });
            }

        } catch (error) {
            console.error("å„²å­˜æˆ–æ¯”åƒ¹å¤±æ•— (Local Storage):", error);
            setStatusMessage("æ•¸æ“šæ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®šæˆ–æœ¬åœ°å„²å­˜ç©ºé–“ã€‚");
        } finally {
            setIsLoading(false);
        }
    }, [userId, barcode, productName, currentPrice, discountDetails, storeName]); 

    // ä¸»é¡Œè®Šæ•¸ï¼Œç”¨æ–¼å‹•æ…‹ Tailwind é¡åˆ¥
    const themePrimary = currentTheme.primary;
    const themeText = currentTheme.text;
    const themeLight = currentTheme.light;
    const themeBorder = currentTheme.border;

    // æ ¹æ“šæŸ¥è©¢ç‹€æ…‹é¡¯ç¤ºç”¢å“åç¨±æç¤º
    const productNamePlaceholder = useMemo(() => {
        switch(lookupStatus) {
            case 'searching':
                return 'æ­£åœ¨æŸ¥è©¢ç”¢å“è³‡æ–™...';
            case 'found':
                return 'ç”¢å“åç¨±å·²è‡ªå‹•è¼‰å…¥';
            case 'new':
                return 'ç”¢å“ä¸å­˜åœ¨ï¼Œè«‹æ‰‹å‹•è¼¸å…¥åç¨±';
            default:
                return 'è«‹å…ˆè¼¸å…¥æ¢ç¢¼æˆ–æƒææ¢ç¢¼';
        }
    }, [lookupStatus]);


    if (!isAuthReady) {
        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <p className="text-xl text-gray-700">æ­£åœ¨åˆå§‹åŒ–æœ¬åœ°æ‡‰ç”¨ç¨‹å¼...</p>
            </div>
        );
    }

    return (
        <div className={`min-h-screen p-4 sm:p-8 ${themeLight}`}>
            <div className="max-w-xl mx-auto">
                <header className="flex justify-between items-center mb-6 border-b pb-4">
                    <h1 className={`text-3xl font-extrabold ${themeText} flex items-center`}>
                        <Barcode className="w-8 h-8 mr-2" />
                        æ¢ç¢¼æ¯”åƒ¹ç¥å™¨ (MVP-AI)
                    </h1>
                    <div className="flex items-center space-x-3">
                        <button 
                            onClick={() => setIsThemeModalOpen(true)}
                            className={`p-2 rounded-full text-white shadow-md transition-all ${themePrimary} hover:opacity-80`}
                            title="è¨­å®šä»‹é¢ä¸»é¡Œ"
                        >
                            <PaintBucket className="w-5 h-5" />
                        </button>
                        <p className="text-sm text-gray-500 hidden sm:block">ç”¨æˆ¶ ID: {userId}</p>
                    </div>
                </header>

                {/* ç‹€æ…‹è¨Šæ¯æç¤º */}
                {statusMessage && (
                    <div className="bg-red-500 text-white p-3 rounded-lg shadow-md mb-4 text-center font-medium transition-opacity duration-300">
                        {statusMessage}
                    </div>
                )}

                {/* æ•´åˆæµç¨‹å¡ç‰‡ï¼šAI æ“·å–å…¥å£ */}
                <div className={`p-6 rounded-xl shadow-2xl bg-white border-t-4 ${themeBorder}`}>
                    <h2 className={`text-xl font-semibold ${themeText} mb-6 flex items-center`}>
                        <Zap className="w-5 h-5 mr-2" /> 
                        æ­¥é©Ÿ 1: AI è¦–è¦ºè‡ªå‹•æ“·å–è³‡æ–™
                    </h2>
                    
                    {/* AI æ“·å–æŒ‰éˆ• - é–‹å•Ÿ Modal */}
                    <button 
                        className={`w-full p-4 rounded-lg text-white font-bold text-lg shadow-xl transition-all ${themePrimary} hover:opacity-80 flex items-center justify-center`}
                        onClick={() => setIsCaptureModalOpen(true)}
                    >
                        <Camera className="inline-block w-6 h-6 mr-3" /> 
                        é–‹å•Ÿé¡é ­ï¼Œæ“·å–æ¢ç¢¼èˆ‡åƒ¹ç›®æ¨™ç±¤
                    </button>
                    
                    <hr className="my-6 border-gray-200" />

                    <h2 className={`text-xl font-semibold text-gray-700 mb-4 flex items-center`}>
                        <FileText className="w-5 h-5 mr-2" /> 
                        æ­¥é©Ÿ 2: æª¢æŸ¥æˆ–æ‰‹å‹•è¼¸å…¥è³‡æ–™
                    </h2>

                    {/* æ¢ç¢¼è¼¸å…¥å€ */}
                    <div className="mb-4">
                        <label className="block text-gray-700 font-medium mb-1">æ¢ç¢¼æ•¸æ“š (Barcode Data)</label>
                        <input
                            type="text"
                            value={barcode}
                            onChange={(e) => setBarcode(e.target.value)}
                            placeholder="AI è‡ªå‹•å¡«å…¥ï¼Œæˆ–æ‰‹å‹•è¼¸å…¥"
                            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"
                        />
                    </div>
                    
                    {/* ç”¢å“åç¨±å€ - é…åˆè‡ªå‹•æŸ¥è©¢ */}
                    <div className="mb-4">
                        <label className="block text-gray-700 font-medium mb-1">ç”¢å“åç¨± (Product Name)</label>
                        <input
                            type="text"
                            value={productName}
                            onChange={(e) => setProductName(e.target.value)}
                            placeholder={productNamePlaceholder}
                            className={`w-full p-3 border border-gray-300 rounded-lg transition 
                                ${lookupStatus === 'found' ? 'bg-green-50' : lookupStatus === 'new' ? 'bg-yellow-50' : ''}`}
                            readOnly={lookupStatus === 'found'} 
                        />
                        <p className="text-sm text-gray-500 mt-1">
                            æ•¸å€¼ ID (Hash): {barcode ? djb2Hash(barcode) : 'å°šæœªè¨ˆç®—'}
                        </p>
                    </div>

                    {/* åƒ¹æ ¼èˆ‡å•†åº—è¼¸å…¥/OCR å€ */}
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">æ¨™åƒ¹ ($) <span className="text-red-500">*</span></label>
                            <input
                                type="number"
                                value={currentPrice}
                                onChange={(e) => setCurrentPrice(e.target.value)}
                                placeholder="AI æ“·å–"
                                className="w-full p-3 border border-gray-300 rounded-lg"
                            />
                        </div>
                        <div>
                            <label className="block text-gray-700 font-medium mb-1">å•†åº—åç¨±</label>
                            <input
                                type="text"
                                value={storeName} 
                                onChange={(e) => setStoreName(e.target.value)}
                                placeholder="AI æ“·å–"
                                className="w-full p-3 border border-gray-300 rounded-lg"
                            />
                        </div>
                    </div>
                    
                    {/* å„ªæƒ ç´°ç¯€è¼¸å…¥å€ (æ–°å¢) */}
                    <div className="mb-6">
                        <label className="block text-gray-700 font-medium mb-1">å„ªæƒ ç´°ç¯€/ä¿ƒéŠ·æ´»å‹• (Discount Details)</label>
                        <input
                            type="text"
                            value={discountDetails}
                            onChange={(e) => setDiscountDetails(e.target.value)}
                            placeholder="AI æ“·å– (ä¾‹å¦‚: è²·äºŒé€ä¸€, ç¬¬äºŒä»¶åŠåƒ¹)"
                            className="w-full p-3 border border-gray-300 rounded-lg"
                        />
                    </div>

                    {/* å„²å­˜ç´€éŒ„ä¸¦æ¯”åƒ¹ */}
                    <button 
                        className={`w-full mt-4 p-3 rounded-lg text-white font-semibold shadow-lg transition-all bg-emerald-500 hover:bg-emerald-600`}
                        onClick={saveAndComparePrice}
                        disabled={isLoading}
                    >
                        <ClipboardCheck className="inline-block w-5 h-5 mr-2" /> 
                        {isLoading ? 'å„²å­˜ä¸¦æ¯”åƒ¹ä¸­...' : 'æ­¥é©Ÿ 3: å„²å­˜ç´€éŒ„ä¸¦æ¯”åƒ¹'}
                    </button>
                </div>

                {/* æ¯”åƒ¹çµæœé¡¯ç¤ºå€ */}
                <div className="mt-8">
                    <h2 className={`text-xl font-semibold ${themeText} mb-4 flex items-center`}>
                        <DollarSign className="w-5 h-5 mr-2" />
                        æ¯”åƒ¹çµæœ
                    </h2>
                    <div className={`p-6 rounded-xl shadow-xl border-2 ${comparisonResult.isBest ? 'border-green-500 bg-green-50' : 'border-yellow-500 bg-yellow-50'}`}>
                        <p className={`text-lg font-bold ${comparisonResult.isBest ? 'text-green-700' : 'text-yellow-700'}`}>
                            {comparisonResult.message}
                        </p>
                        {comparisonResult.bestPrice && (
                            <p className="text-sm text-gray-600 mt-2">
                                æ­·å²æœ€ä½æ¨™åƒ¹: ${comparisonResult.bestPrice}
                            </p>
                        )}
                        <p className="text-xs text-gray-500 mt-2">
                            **é™„è¨»:** æ‚¨çš„ç´€éŒ„å·²å„²å­˜åœ¨ç€è¦½å™¨çš„æœ¬åœ°å„²å­˜ä¸­ (Local Storage)ã€‚
                        </p>
                    </div>
                </div>
            </div>

            {/* ä¸»é¡Œé¸æ“‡ Modal */}
            {isThemeModalOpen && (
                <ThemeSelector 
                    theme={currentTheme} 
                    saveTheme={saveUserTheme} 
                    onClose={() => setIsThemeModalOpen(false)} 
                />
            )}

            {/* AI è¦–è¦ºæ“·å– Modal */}
            {isCaptureModalOpen && (
                <AIOcrCaptureModal
                    theme={currentTheme}
                    onAnalysisSuccess={handleAiCaptureSuccess}
                    onClose={() => setIsCaptureModalOpen(false)}
                />
            )}
        </div>
    );
}

export default App;
</file>

<file path="å¾…å¯¦ä½œ.txt">
å¢åŠ é é¢å¯ä»¥æŒ‡å®šå€å¡Šï¼Œå€åˆ†å“åã€æ¨™åƒ¹ã€å–®åƒ¹ä»¥åŠåˆ†è¾¨ä¸åŒåº—å®¶çš„è¨­è¨ˆ


å› ç‚ºç›®å‰ç¨‹å¼é‚„åœ¨MVPæ¸¬è©¦éšæ®µï¼Œæˆ‘æƒ³è«‹ä½ å¹«æˆ‘å…ˆå±è”½firbaseçš„ç›¸é—œåŠŸèƒ½ï¼Œä½†æ˜¯ä¸è¦åˆªé™¤ä»»ä½•ç¨‹å¼ï¼Œè³‡æ–™åº«éƒ¨åˆ†æ”¹ç”±ä½¿ç”¨æœ¬æ©Ÿå„²å­˜ï¼Œç­‰å¾…æ¸¬è©¦æ²’æœ‰å•é¡Œå¾Œå†é–‹å•Ÿfirebaseä¸²æ¥ï¼Œä¸”è«‹å¹«æˆ‘åœ¨ç¨‹å¼ä¸­æŸ±è¨˜ï¼Œä»¥å…å…¶ä»–é–‹ç™¼è€…èª¤åˆª


å–®åƒ¹è¨ˆç®—èˆ‡å„ªæƒ è™•ç†ï¼šç›®å‰çš„æ¯”åƒ¹åƒ…åŸºæ–¼æ¨™åƒ¹ã€‚æˆ‘å€‘æ‡‰è©²å¦‚ä½•æ“´å±•æ•¸æ“šæ¨¡å‹ä¾†ç´å…¥å®¹é‡ (e.g., 500ml, 100g) å’Œå„ªæƒ é¡å‹ (e.g., è²·ä¸€é€ä¸€)ï¼Œä»¥è¨ˆç®—å‡ºçœŸæ­£çš„**ã€Œæ¯å–®ä½æœ€ä½åƒ¹ã€**ï¼Ÿ

æ•¸æ“šå”¯ä¸€æ€§èˆ‡é›œæ¹Š ID è¡çªï¼šæˆ‘å€‘ä½¿ç”¨ DJB2 é›œæ¹Šç®—æ³•å¾æ¢ç¢¼å­—ä¸²ç”Ÿæˆæ•¸å€¼ IDã€‚é›–ç„¶è¡çªæ©Ÿç‡ä½ï¼Œä½†åœ¨è™•ç†æ•¸ç™¾è¬å€‹ç”¢å“æ™‚ï¼Œå¦‚ä½•è¨­è¨ˆä¸€å€‹æ•¸æ“šåº«æª¢æŸ¥æ©Ÿåˆ¶ä¾†é¿å…å…©å€‹ä¸åŒæ¢ç¢¼æ„å¤–ç”¢ç”Ÿç›¸åŒçš„æ•¸å€¼ IDï¼Ÿ

å„ªåŒ–äºŒç¶­æ¢ç¢¼ (QR Code, Data Matrix) çš„æ”¯æ´ï¼šå¦‚ä½•å°‡ QuaggaJS (åªæ”¯æ´ä¸€ç¶­æ¢ç¢¼) æ›¿æ›æˆ–å¢å¼·ç‚ºæ”¯æ´ QR Code çš„å‡½å¼åº«ï¼Œä»¥å¯¦ç¾å°æ‰€æœ‰é¡å‹æ¢ç¢¼çš„é€šç”¨è­˜åˆ¥ï¼Ÿ

æ­·å²åƒ¹æ ¼è¶¨å‹¢åˆ†æï¼šé™¤äº†é¡¯ç¤ºæœ€ä½åƒ¹ï¼Œå¦‚ä½•å¢åŠ åŠŸèƒ½ï¼Œè®“ä½¿ç”¨è€…èƒ½æŸ¥çœ‹åƒ¹æ ¼éš¨æ™‚é–“è®Šå‹•çš„åœ–è¡¨ï¼Œä»¥åˆ¤æ–·ç•¶å‰æ˜¯å¦ç‚ºé€²å ´çš„æœ€ä½³æ™‚æ©Ÿï¼Ÿ
</file>

</files>
