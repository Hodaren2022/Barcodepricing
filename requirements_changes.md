# 需求變更記錄

## 變更要求
根據用戶要求，需要針對特定需求進行處理，千萬不要更動其他功能或顯示。

## 處理原則
1. 只針對明確提出的要求進行修改
2. 不更動其他未提及的功能或顯示
3. 提供修改建議前，需一併提供會影響的功能及範圍供審查
4. 所有變更需清楚記錄在此文件中

## 注意事項
- 用戶強調提供建議後，需要一併提供會影響的功能及範圍供審查
- 用戶要求將此要求紀錄至.md文件中(已完成)
- 任何修改都必須遵循"最小影響原則"，只處理指定需求

## 核心要求確認
用戶明確要求：
1. **只針對具體需求處理** - 不對其他功能進行任何修改
2. **不更動其他功能或顯示** - 保持現有功能完整性
3. **提供影響範圍審查** - 在提供建議前需明確說明會影響的功能及範圍

## 待處理需求
目前尚未收到具體的修改需求內容，請用戶提供詳細的需求說明，我將根據需求進行分析並提供相應的修改建議和影響範圍評估。

## 新增需求 - 所有資料頁面編輯模式功能
用戶提出在"所有資料"頁面增加"編輯模式"功能，具體需求如下：

### 功能描述
1. 在排序功能的右方新增"編輯模式"按鈕
2. 按下按鈕後進入專用編輯模式
3. 編輯模式特性：
   - 暫停資料的即時更新
   - 畫面中央下方顯示"退出編輯模式"的漂浮按鍵
   - 可使用check box選擇要刪除的商品總項目（可複選）
   - 保留原本的左滑開啟價格紀錄詳情裡的單條歷史紀錄的編輯和刪除功能
   - 選擇項目後出現飄浮式刪除按鈕
   - 編輯或刪除完成時保持畫面顯示位置，直到按下退出編輯模式
   - 退出編輯模式時才進行與Firebase的資料更新和同步

### 現有功能分析
經過分析 [AllRecordsPage.js](file:///d%3A/Ai%20software%20DEV/BarcodePricing/001%20-%20DEV/src/AllRecordsPage.js) 文件，發現編輯模式功能已經實現，包含以下特性：

1. **編輯模式按鈕**：已存在於排序選項右側
2. **狀態管理**：
   - `isEditMode` - 編輯模式開關
   - `selectedItems` - 選中的項目集合
   - `localProducts` 和 `localRecords` - 編輯模式下的本地數據副本
3. **UI 變更**：
   - 編輯模式下為每個產品項目添加 checkbox
   - 添加批量刪除的漂浮按鈕
   - 添加退出編輯模式的漂浮按鈕
4. **數據處理**：
   - 進入編輯模式時，複製當前數據到本地狀態
   - 編輯期間所有操作只影響本地狀態
   - 退出編輯模式時，將變更同步到 Firebase

### 用戶提出的優化需求
根據用戶最新指示，需要對現有編輯模式功能進行以下優化：

1. **視覺反饋**：選中項目時可以增加更明顯的視覺效果
2. **位置固定**：確保漂浮按鈕在滾動時保持可見
3. **操作確認**：批量刪除前添加確認對話框

### 用戶新增需求
用戶希望在編輯模式下刪除價格紀錄詳情裡的單條紀錄時，畫面不要重整，但是在非編輯模式時需保持原本功能。

### 用戶最新需求
用戶希望在退出時檢查數據版本或提供衝突解決機制。

### 實作範圍確認
根據用戶最新指示，將針對上述優化需求和新增需求進行實作。

### 實作詳細說明

#### 1. 視覺反饋優化
- **修改內容**：為選中的項目添加增強的視覺反饋效果
- **實現方式**：當項目被選中時，添加藍色邊框和背景色
- **影響範圍**：產品項目的渲染邏輯

#### 2. 位置固定優化
- **修改內容**：確保漂浮按鈕在滾動時保持可見
- **實現方式**：使用 `fixed` 定位確保按鈕始終可見
- **影響範圍**：批量刪除按鈕和退出編輯模式按鈕的定位

#### 3. 操作確認優化
- **修改內容**：批量刪除前添加確認對話框
- **實現方式**：
  - 新增 `isBulkDeleteConfirmationOpen` 狀態管理對話框顯示
  - 新增 `BulkDeleteConfirmation` 組件
  - 修改 `handleBulkDeleteClick` 函數以顯示確認對話框
- **影響範圍**：批量刪除功能流程

#### 4. 編輯模式下單條記錄刪除不重整畫面
- **修改內容**：在編輯模式下刪除單條記錄時，不重新整理畫面，僅更新本地狀態
- **實現方式**：
  - 修改 `confirmDelete` 函數，根據是否為編輯模式採取不同行為
  - 在編輯模式下，直接更新本地狀態而不調用 `fetchData`
  - 在非編輯模式下，保持原有行為
- **影響範圍**：單條記錄刪除功能流程

#### 5. 數據版本檢查和衝突解決機制
- **修改內容**：在退出編輯模式時檢查數據版本或提供衝突解決機制
- **實現方式**：
  - 在進入編輯模式時保存原始數據的快照和時間戳
  - 在退出編輯模式時比較當前Firebase數據與原始快照
  - 如果檢測到衝突，顯示衝突解決對話框
  - 提供合併選項：保留本地變更、保留遠程變更或手動合併
- **影響範圍**：編輯模式的進入和退出流程

#### 6. 衝突解決機制實現細節
- **新增狀態**：
  - `originalDataSnapshot` - 保存進入編輯模式時的原始數據快照
  - `isConflictDialogOpen` - 衝突對話框顯示狀態
  - `conflictData` - 衝突數據詳細信息
- **新增功能**：
  - `checkForConflictsAndExit` - 檢查衝突並退出的函數
  - `checkForDataConflicts` - 數據衝突檢查函數
  - `ConflictResolutionDialog` - 衝突解決對話框組件
  - `handleConflictResolution` - 衝突解決處理函數
- **修改功能**：
  - 編輯模式按鈕的點擊處理函數，使其調用衝突檢查
  - `exitEditMode` 函數，增強其功能以處理衝突後的退出

### 修改文件列表
- [src/AllRecordsPage.js](file:///d%3A/Ai%20software%20DEV/BarcodePricing/001%20-%20DEV/src/AllRecordsPage.js)：實現所有優化功能

### 不影響的功能
- 主頁面 ([App.js](file:///d%3A/Ai%20software%20DEV/BarcodePricing/001%20-%20DEV/src/App.js)) 的任何功能
- Firebase 數據結構
- 價格趨勢圖表顯示
- 搜尋功能
- 編輯模式的核心邏輯